<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#060A08" />
  <title>Virtus Shooting Lab</title>
  <link rel="manifest" href="manifest.json">
  <!-- Cache-bust (aiuta un po' su mobile) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#060A08;
      --bg2:#07110C;
      --card:rgba(255,255,255,.04);
      --card2:rgba(255,255,255,.03);
      --stroke:rgba(255,255,255,.06);
      --stroke2:rgba(255,255,255,.10);
      --txt:#EAF5EE;
      --muted:rgba(234,245,238,.72);
      --muted2:rgba(234,245,238,.55);
      --green:#17C964;
      --green2:#0B3D2A;
      --shadow: 0 14px 36px rgba(0,0,0,.50);
      --r:24px;
      --r2:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(900px 600px at 18% -10%, rgba(23,201,100,.16), transparent 60%),
        radial-gradient(900px 600px at 92% 10%, rgba(23,201,100,.10), transparent 55%),
        linear-gradient(180deg, #07160f, var(--bg) 55%);
      min-height:100%;
    }
    .wrap{
      width:min(980px, 94vw);
      margin:18px auto 42px;
    }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(23,201,100,.06), transparent 60%), var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card.pad{padding:16px}
    .sectionTitle{
      margin: 2px 2px 12px;
      font-size: 22px;
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted)}
    .row{display:flex; align-items:center; gap:12px}
    .col{display:flex; flex-direction:column; gap:10px}
    .spacer{flex:1}
    .divider{height:1px; background:var(--stroke); margin:12px 0}

    /* Header */
    .header{
      display:flex; align-items:center; gap:14px;
      padding:16px;
      background:
        radial-gradient(700px 260px at 10% 0%, rgba(23,201,100,.18), transparent 65%),
        linear-gradient(135deg, rgba(0,0,0,.35), rgba(0,0,0,.12));
    }
    .logoBox{
      width:76px; height:76px;
      border-radius: 22px;
      overflow:hidden;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.32);
      flex:0 0 auto;
      display:grid; place-items:center;
    }
    .logoBox img{width:100%; height:100%; object-fit:cover}
    .titleBox{min-width:0}
    .title{
      margin:0;
      font-size: 34px;
      line-height:1.05;
      font-weight: 1100;
      letter-spacing: .2px;
      text-shadow: 0 2px 16px rgba(0,0,0,.35);
      word-break: break-word;
    }
    .menuBtn{
      margin-left:auto;
      width:46px; height:46px;
      border-radius: 16px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.26);
      color: var(--txt);
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
      font-size:22px;
      font-weight:1000;
    }
    .menuBtn:active{transform: scale(.98)}

    /* Inputs */
    label{font-size:13px; color:var(--muted)}
    input[type="date"], input[type="text"], select{
      width:100%;
      padding: 14px 14px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--txt);
      outline:none;
      font-size: 16px;
    }
    input[type="date"]{color-scheme: dark}
    select{appearance:none}

    /* Tabs players (presenti) */
    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:6px;
    }
    .ptab{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      cursor:pointer;
      user-select:none;
      max-width: 100%;
    }
    .ptab.active{
      border-color: rgba(23,201,100,.38);
      background: linear-gradient(180deg, rgba(23,201,100,.16), rgba(0,0,0,.18));
    }
    .ava{
      width:36px; height:36px;
      border-radius: 999px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      display:grid; place-items:center;
      font-weight:1000;
      color: rgba(234,245,238,.80);
      flex:0 0 auto;
    }
    .ava img{width:100%; height:100%; object-fit:cover}
    .ptabName{
      font-weight: 1000;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 220px;
    }

    /* Timer */
    .timerBox{
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(23,201,100,.10), rgba(0,0,0,.18));
      padding: 14px;
    }
    .time{
      text-align:center;
      font-size: 66px;
      font-weight: 1150;
      letter-spacing: 1px;
      margin: 6px 0 12px;
      font-variant-numeric: tabular-nums;
      text-shadow: 0 2px 22px rgba(0,0,0,.40);
    }
    .btnRow{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
    .btn{
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.24);
      color: var(--txt);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 1000;
      cursor:pointer;
      user-select:none;
      min-width: 92px;
    }
    .btn:active{transform: scale(.98)}
    .btnPrimary{
      background: linear-gradient(180deg, rgba(23,201,100,.22), rgba(11,61,42,.18));
      border-color: rgba(23,201,100,.40);
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
    }
    .btnStartBig{
      min-width: 190px;
      padding: 16px 18px;
      border-radius: 18px;
      font-size: 18px;
    }

    /* Shots */
    .shotRow{
      display:grid;
      grid-template-columns: 1fr auto auto auto;
      gap:10px;
      align-items:center;
      padding: 12px;
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
    }
    .shotName{font-weight:1100; font-size: 18px; line-height:1.05}
    .shotSub{font-size:12px; color:var(--muted2); margin-top:4px}
    .pmBtn{
      width:46px; height:46px;
      border-radius: 16px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.22);
      color: var(--txt);
      font-size: 26px;
      font-weight: 1100;
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .pmBtn:active{transform: scale(.98)}
    .val{
      width:64px;
      text-align:center;
      font-size: 22px;
      font-weight: 1150;
      padding: 10px 0;
      border-radius: 16px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.16);
      font-variant-numeric: tabular-nums;
    }
    .actions2{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top: 12px}

    /* Stats */
    .statsBox{
      position:relative;
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      padding: 12px;
      overflow:hidden;
    }
    .watermark{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      opacity:.10;
      pointer-events:none;
      transform: translateY(10px);
    }
    .watermark img{
      width:min(420px, 80%);
      filter: saturate(1.1) contrast(1.05);
    }
    canvas{width:100% !important; height:260px !important}

    .statLine{
      margin-top:10px;
      font-weight:1000;
    }

    /* Ranking list */
    .rankBox{
      margin-top:12px;
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.16);
      padding: 12px;
    }
    .rankItem{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 10px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.05);
      background: rgba(255,255,255,.02);
      margin-bottom: 10px;
    }
    .rankItem:last-child{margin-bottom:0}
    .rkNum{
      width:34px; height:34px;
      border-radius: 14px;
      border:1px solid rgba(23,201,100,.22);
      background: rgba(23,201,100,.12);
      display:grid; place-items:center;
      font-weight:1100;
      font-variant-numeric: tabular-nums;
      flex:0 0 auto;
    }
    .rkName{
      font-weight:1100;
      flex:1;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rkPct{font-weight:1150; font-variant-numeric: tabular-nums;}
    .rkMeta{color:var(--muted2); font-size:12px; margin-left:auto}

    /* Overlays / Modals (scroll FIX) */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      z-index: 9999;
      padding: 14px;
      align-items:center;
      justify-content:center;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(740px, 96vw);
      max-height: 86vh;
      overflow:hidden;
      border-radius: 22px;
      border:1px solid var(--stroke2);
      background: rgba(6, 14, 10, .94);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding: 14px;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(23,201,100,.10), transparent 70%);
    }
    .modalTitle{font-weight:1100; font-size: 18px}
    .modalBody{
      padding: 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex:1 1 auto;
    }
    .modalFoot{
      padding: 12px;
      border-top:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }
    .xBtn{
      margin-left:auto;
      width:40px; height:40px;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.22);
      color: var(--txt);
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
      font-weight:1100;
    }
    .xBtn:active{transform: scale(.98)}

    /* Select players list */
    .pickRow{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 12px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      margin-bottom:10px;
    }
    .pickRow input{width:22px; height:22px}
    .pickMain{font-weight:1100}
    .pickSub{font-size:12px; color:var(--muted2)}
    .chipSmall{
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-weight:1000;
      font-size:12px;
      color: rgba(234,245,238,.85);
    }

    /* Responsive */
    @media (max-width:520px){
      .title{font-size:30px}
      .time{font-size:58px}
      canvas{height:240px !important}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- HEADER -->
    <div class="card">
      <div class="header">
        <div class="logoBox" id="logoBox">
          <img id="logoImg" alt="Virtus logo" src="icon-512.png" />
        </div>
        <div class="titleBox">
          <h1 class="title">Virtus Shooting Lab</h1>
        </div>
        <button class="menuBtn" id="menuBtn" aria-label="Menu">⋮</button>
      </div>
    </div>

    <!-- HOME: 1) DATA 2) TAB 3) TIMER 4) INPUT 5) SALVA 6) STATS + CLASSIFICA GIORNATA -->
    <div class="card pad" style="margin-top:14px;">
      <div class="sectionTitle">Sessione</div>

      <!-- 1) DATA -->
      <div class="row" style="flex-wrap:wrap;">
        <div class="col" style="flex:1; min-width: 220px;">
          <label for="sessionDate">Data sessione</label>
          <input id="sessionDate" type="date" />
        </div>
      </div>

      <!-- 2) TAB GIOCATORI PRESENTI -->
      <div class="divider"></div>
      <div class="row" style="flex-wrap:wrap;">
        <div class="col" style="flex:1; min-width:220px;">
          <div class="muted" style="font-weight:900;">Giocatori presenti</div>
          <div id="presentHint" class="muted" style="font-size:13px; margin-top:4px;">Menu ⋮ → Seleziona giocatori</div>
        </div>
        <button class="btn btnPrimary" id="openSelectPlayers" type="button">Seleziona</button>
      </div>
      <div class="tabs" id="playerTabs" style="margin-top:12px;"></div>
    </div>

    <!-- 3) TIMER -->
    <div class="card pad" style="margin-top:14px;">
      <div class="row" style="gap:12px; flex-wrap:wrap;">
        <div class="sectionTitle" style="margin:0;">Timer</div>
        <div class="spacer"></div>
        <div style="min-width:170px;">
          <select id="timerPreset" aria-label="Timer preset">
            <option value="45">45 sec</option>
            <option value="40">40 sec</option>
            <option value="35">35 sec</option>
          </select>
        </div>
      </div>

      <div class="timerBox" style="margin-top:12px;">
        <div class="time" id="timeDisplay">00:45</div>
        <div class="btnRow">
          <button class="btn btnPrimary btnStartBig" id="startBtn" type="button">START</button>
          <button class="btn" id="stopBtn" type="button">Stop</button>
          <button class="btn" id="resetBtn" type="button">Reset</button>
        </div>
      </div>
    </div>

    <!-- 4) INSERIMENTO -->
    <div class="card pad" style="margin-top:14px;">
      <div class="sectionTitle">Inserimento tiri</div>

      <div class="col" style="gap:12px;">
        <div class="shotRow">
          <div>
            <div class="shotName">Fondo sx</div>
            <div class="shotSub">su 10</div>
          </div>
          <button class="pmBtn" data-k="fondo_sx" data-d="-1" type="button">−</button>
          <div class="val" id="val-fondo_sx">0</div>
          <button class="pmBtn" data-k="fondo_sx" data-d="1" type="button">+</button>
        </div>

        <div class="shotRow">
          <div>
            <div class="shotName">45° sx</div>
            <div class="shotSub">su 10</div>
          </div>
          <button class="pmBtn" data-k="angolo_sx" data-d="-1" type="button">−</button>
          <div class="val" id="val-angolo_sx">0</div>
          <button class="pmBtn" data-k="angolo_sx" data-d="1" type="button">+</button>
        </div>

        <div class="shotRow">
          <div>
            <div class="shotName">Frontale</div>
            <div class="shotSub">su 10</div>
          </div>
          <button class="pmBtn" data-k="frontale" data-d="-1" type="button">−</button>
          <div class="val" id="val-frontale">0</div>
          <button class="pmBtn" data-k="frontale" data-d="1" type="button">+</button>
        </div>

        <div class="shotRow">
          <div>
            <div class="shotName">45° dx</div>
            <div class="shotSub">su 10</div>
          </div>
          <button class="pmBtn" data-k="angolo_dx" data-d="-1" type="button">−</button>
          <div class="val" id="val-angolo_dx">0</div>
          <button class="pmBtn" data-k="angolo_dx" data-d="1" type="button">+</button>
        </div>

        <div class="shotRow">
          <div>
            <div class="shotName">Fondo dx</div>
            <div class="shotSub">su 10</div>
          </div>
          <button class="pmBtn" data-k="fondo_dx" data-d="-1" type="button">−</button>
          <div class="val" id="val-fondo_dx">0</div>
          <button class="pmBtn" data-k="fondo_dx" data-d="1" type="button">+</button>
        </div>
      </div>

      <div class="actions2">
        <button class="btn" id="clearBtn" type="button">Azzera</button>
        <button class="btn btnPrimary" id="saveBtn" type="button">Salva</button>
      </div>
    </div>

    <!-- 6) STATISTICHE (SOLO GIORNATA) + CLASSIFICA GIORNATA -->
    <div class="card pad" style="margin-top:14px;">
      <div class="sectionTitle">Statistiche (giornata)</div>

      <div class="statsBox">
        <div class="watermark"><img alt="logo" src="icon-512.png"></div>
        <canvas id="chart"></canvas>
      </div>

      <div class="row" style="margin-top:10px; flex-wrap:wrap;">
        <div class="statLine" id="dayStatLine">—</div>
        <div class="spacer"></div>
        <button class="btn btnPrimary" id="shareBtn" type="button">Condividi WhatsApp</button>
      </div>

      <!-- CLASSIFICA GIORNATA (sempre presente) -->
      <div class="rankBox" style="margin-top:14px;">
        <div class="row" style="gap:10px; flex-wrap:wrap;">
          <div style="font-weight:1100; font-size:18px;">Classifica giornata</div>
          <div class="spacer"></div>
          <div class="chipSmall" id="rankDayMeta">—</div>
        </div>
        <div style="height:10px"></div>
        <div id="rankDayList"></div>
      </div>
    </div>

  </div>

  <!-- MENU MODAL -->
  <div class="overlay" id="menuOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">Menu</div>
        <button class="xBtn" id="menuClose" aria-label="Chiudi">✕</button>
      </div>
      <div class="modalBody">
        <button class="btn btnPrimary" style="width:100%; margin-bottom:10px;" id="menuSelectPlayers" type="button">Seleziona giocatori</button>
        <button class="btn" style="width:100%; margin-bottom:10px;" id="menuPlayer" type="button">Giocatore (nome + foto)</button>
        <button class="btn" style="width:100%; margin-bottom:10px;" id="menuTeamRanking" type="button">Classifica squadra (totale)</button>
        <button class="btn" style="width:100%; margin-bottom:10px;" id="menuBackup" type="button">Backup / Import</button>
        <button class="btn" style="width:100%; margin-bottom:10px;" id="menuResetSessions" type="button">Reset totale sessioni</button>
      </div>
      <div class="modalFoot">
        <button class="btn" id="menuClose2" type="button">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- SELECT PLAYERS MODAL -->
  <div class="overlay" id="selectOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">Seleziona giocatori presenti</div>
        <button class="xBtn" id="selectClose" aria-label="Chiudi">✕</button>
      </div>
      <div class="modalBody" id="selectList"></div>
      <div class="modalFoot">
        <button class="btn" id="selectCancel" type="button">Annulla</button>
        <button class="btn btnPrimary" id="selectOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- PLAYER MODAL -->
  <div class="overlay" id="playerOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">Giocatore</div>
        <button class="xBtn" id="playerClose" aria-label="Chiudi">✕</button>
      </div>
      <div class="modalBody">
        <div class="row" style="gap:14px; flex-wrap:wrap;">
          <div class="ava" id="playerPreviewAva" style="width:92px; height:92px; border-radius:24px;">VS</div>
          <div class="col" style="flex:1; min-width:220px;">
            <label for="playerNameInput">Nome</label>
            <input id="playerNameInput" type="text" placeholder="Es. Emanuele" />
            <label for="playerPhotoInput">Foto (fotocamera)</label>
            <input id="playerPhotoInput" type="file" accept="image/*" capture="environment" />
          </div>
        </div>
        <div class="divider"></div>
        <div class="actions2">
          <button class="btn btnPrimary" id="playerSave" type="button">Salva</button>
          <button class="btn" id="playerRemovePhoto" type="button">Rimuovi foto</button>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="playerClose2" type="button">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- TEAM RANKING MODAL -->
  <div class="overlay" id="teamOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">Classifica squadra (totale)</div>
        <button class="xBtn" id="teamClose" aria-label="Chiudi">✕</button>
      </div>
      <div class="modalBody">
        <div class="muted" style="font-weight:900; margin-bottom:10px;">Media totale su tutte le sessioni salvate.</div>
        <div id="rankTeamList"></div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="teamClose2" type="button">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- BACKUP / IMPORT MODAL -->
  <div class="overlay" id="backupOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">Backup / Import</div>
        <button class="xBtn" id="backupClose" aria-label="Chiudi">✕</button>
      </div>
      <div class="modalBody">
        <div class="muted" style="margin-bottom:10px;">Import abbina automaticamente per NOME. Se non trova, ti fa scegliere il giocatore.</div>

        <label for="importJson">Import JSON</label>
        <input id="importJson" type="file" accept="application/json" />

        <div class="divider"></div>

        <button class="btn btnPrimary" style="width:100%;" id="exportJson" type="button">Esporta JSON (giocatore attivo)</button>

        <div class="divider"></div>
        <div class="muted" style="font-size:13px;">
          Consiglio: prima di esportare, il giocatore deve avere scritto il proprio nome in “Giocatore (nome + foto)”.
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="backupClose2" type="button">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- IMPORT TARGET PICK MODAL (if name not found) -->
  <div class="overlay" id="importPickOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">Scegli giocatore per import</div>
        <button class="xBtn" id="importPickClose" aria-label="Chiudi">✕</button>
      </div>
      <div class="modalBody">
        <div class="muted" style="font-weight:900; margin-bottom:10px;" id="importPickInfo">—</div>
        <div id="importPickList"></div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="importPickCancel" type="button">Annulla</button>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    /***********************
     * BEST-EFFORT: evitare vecchie versioni PWA
     ***********************/
    (async function(){
      try{
        if('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          for(const r of regs){ await r.unregister(); }
        }
        if('caches' in window){
          const keys = await caches.keys();
          for(const k of keys){ await caches.delete(k); }
        }
      }catch(e){}
    })();

    /***********************
     * CONFIG
     ***********************/
    const SHOTS_PER_POS = 10;
    const POS = [
      { key:"fondo_sx",  label:"Fondo sx" },
      { key:"angolo_sx", label:"45° sx" },
      { key:"frontale",  label:"Frontale" },
      { key:"angolo_dx", label:"45° dx" },
      { key:"fondo_dx",  label:"Fondo dx" },
    ];
    const PLAYER_COUNT = 12;
    const LS_KEY = "virtus_shooting_lab_v1";

    /***********************
     * STATE
     ***********************/
    function defaultState(){
      const players = Array.from({length:PLAYER_COUNT}, (_,i)=>{
        const id = "G"+(i+1);
        return { id, name: `Giocatore ${i+1}`, photo:null, sessions:[] };
      });
      const inputs = Object.fromEntries(players.map(p => [p.id, Object.fromEntries(POS.map(x=>[x.key,0]))]));
      return {
        version: 1,
        sessionDate: todayISO(),
        presentIds: [],
        activeId: "G1",
        timerSec: 45,
        inputs,
        players
      };
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return defaultState();
        const st = JSON.parse(raw);
        if(!st || !Array.isArray(st.players)) return defaultState();
        // normalize
        if(!st.inputs) st.inputs = {};
        for(const p of st.players){
          if(typeof p.name !== "string") p.name = p.id;
          if(typeof p.photo !== "string") p.photo = null;
          if(!Array.isArray(p.sessions)) p.sessions = [];
          if(!st.inputs[p.id]) st.inputs[p.id] = Object.fromEntries(POS.map(x=>[x.key,0]));
          for(const x of POS){
            if(typeof st.inputs[p.id][x.key] !== "number") st.inputs[p.id][x.key] = 0;
          }
        }
        if(!Array.isArray(st.presentIds)) st.presentIds = [];
        if(!st.sessionDate) st.sessionDate = todayISO();
        if(!st.activeId) st.activeId = st.players[0].id;
        if(!st.timerSec || ![35,40,45].includes(Number(st.timerSec))) st.timerSec = 45;
        return st;
      }catch(e){
        return defaultState();
      }
    }

    let state = loadState();

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    function getPlayer(id){
      return state.players.find(p=>p.id === id);
    }

    function todayISO(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60*1000);
      return local.toISOString().slice(0,10);
    }

    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    function initials(name){
      const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
      if(parts.length === 0) return "VS";
      const a = parts[0][0] || "";
      const b = parts.length>1 ? (parts[parts.length-1][0]||"") : "";
      return (a+b).toUpperCase();
    }

    function ensureActiveValid(){
      if(state.presentIds.length){
        if(!state.presentIds.includes(state.activeId)) state.activeId = state.presentIds[0];
      }else{
        state.activeId = "G1";
      }
    }

    /***********************
     * DOM
     ***********************/
    const el = (id)=>document.getElementById(id);

    const sessionDateEl = el("sessionDate");
    const timerPresetEl = el("timerPreset");
    const openSelectPlayersBtn = el("openSelectPlayers");
    const playerTabsEl = el("playerTabs");
    const presentHintEl = el("presentHint");

    const timeDisplayEl = el("timeDisplay");
    const startBtn = el("startBtn");
    const stopBtn  = el("stopBtn");
    const resetBtn = el("resetBtn");

    const clearBtn = el("clearBtn");
    const saveBtn  = el("saveBtn");
    const shareBtn = el("shareBtn");

    const dayStatLineEl = el("dayStatLine");
    const rankDayMetaEl = el("rankDayMeta");
    const rankDayListEl = el("rankDayList");

    // overlays
    const menuBtn = el("menuBtn");
    const menuOverlay = el("menuOverlay");
    const menuClose = el("menuClose");
    const menuClose2 = el("menuClose2");
    const menuSelectPlayers = el("menuSelectPlayers");
    const menuPlayer = el("menuPlayer");
    const menuTeamRanking = el("menuTeamRanking");
    const menuBackup = el("menuBackup");
    const menuResetSessions = el("menuResetSessions");

    const selectOverlay = el("selectOverlay");
    const selectClose = el("selectClose");
    const selectCancel = el("selectCancel");
    const selectOk = el("selectOk");
    const selectList = el("selectList");

    const playerOverlay = el("playerOverlay");
    const playerClose = el("playerClose");
    const playerClose2 = el("playerClose2");
    const playerPreviewAva = el("playerPreviewAva");
    const playerNameInput = el("playerNameInput");
    const playerPhotoInput = el("playerPhotoInput");
    const playerSave = el("playerSave");
    const playerRemovePhoto = el("playerRemovePhoto");

    const teamOverlay = el("teamOverlay");
    const teamClose = el("teamClose");
    const teamClose2 = el("teamClose2");
    const rankTeamList = el("rankTeamList");

    const backupOverlay = el("backupOverlay");
    const backupClose = el("backupClose");
    const backupClose2 = el("backupClose2");
    const exportJsonBtn = el("exportJson");
    const importJsonEl = el("importJson");

    const importPickOverlay = el("importPickOverlay");
    const importPickClose = el("importPickClose");
    const importPickCancel = el("importPickCancel");
    const importPickInfo = el("importPickInfo");
    const importPickList = el("importPickList");

    /***********************
     * Overlay helpers
     ***********************/
    function openOverlay(o){
      o.classList.add("show");
      o.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeOverlay(o){
      o.classList.remove("show");
      o.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }
    function bindOverlayClose(overlay){
      overlay.addEventListener("click", (e)=>{
        if(e.target === overlay) closeOverlay(overlay);
      });
    }
    [menuOverlay, selectOverlay, playerOverlay, teamOverlay, backupOverlay, importPickOverlay].forEach(bindOverlayClose);

    /***********************
     * Timer
     ***********************/
    let timer = { running:false, remaining: state.timerSec, t:null };

    function fmt(sec){
      const s = Math.max(0, sec|0);
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${mm}:${ss}`;
    }
    function stopTimer(){
      timer.running=false;
      if(timer.t) clearInterval(timer.t);
      timer.t=null;
    }
    function resetTimer(){
      stopTimer();
      timer.remaining = state.timerSec;
      timeDisplayEl.textContent = fmt(timer.remaining);
    }
    function startTimer(){
      if(timer.running) return;
      timer.running=true;
      if(timer.remaining <= 0) timer.remaining = state.timerSec;

      timer.t = setInterval(()=>{
        timer.remaining -= 1;
        timeDisplayEl.textContent = fmt(timer.remaining);
        if(timer.remaining <= 0){
          stopTimer();
          timeDisplayEl.textContent = "00:00";
          finishSignal();
        }
      }, 1000);
    }

    /***********************
     * Sound + vibration (10 beep, louder)
     ***********************/
    let audioCtx = null;
    function getAudioCtx(){
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }
    function beepOnce(freq=988, dur=0.08, gainVal=0.85){
      const ctx = getAudioCtx();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "square";
      o.frequency.value = freq;
      g.gain.value = gainVal;
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + dur);
    }
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

    async function finishSignal(){
      if(navigator.vibrate){
        navigator.vibrate([120,80,120,80,120,80,120,80,120]);
      }
      const pattern = [880,880,988,988,1047,1047,1175,1175,1319,1319];
      for(let i=0;i<pattern.length;i++){
        try{ beepOnce(pattern[i], 0.09, 0.90); }catch(e){}
        await sleep(420);
      }
    }

    /***********************
     * Inputs per-player
     ***********************/
    function curInputs(){ return state.inputs[state.activeId]; }

    function updateInputsUI(){
      const inp = curInputs();
      for(const x of POS){
        el("val-"+x.key).textContent = String(inp[x.key] || 0);
      }
    }

    document.querySelectorAll(".pmBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const k = btn.getAttribute("data-k");
        const d = parseInt(btn.getAttribute("data-d"),10) || 0;
        const inp = curInputs();
        inp[k] = clamp((inp[k]||0) + d, 0, SHOTS_PER_POS);
        saveState();
        updateInputsUI();
        updateDayStats(); // live refresh
      }, {passive:true});
    });

    function clearInputs(){
      state.inputs[state.activeId] = Object.fromEntries(POS.map(x=>[x.key,0]));
      saveState();
      updateInputsUI();
      updateDayStats();
    }

    /***********************
     * Sessions + day stats
     ***********************/
    function saveSession(){
      if(!state.presentIds.length){
        alert("Prima seleziona i giocatori presenti (Menu ⋮).");
        return;
      }
      const p = getPlayer(state.activeId);
      if(!p) return;

      const date = state.sessionDate;
      const inp = curInputs();

      const made = {};
      let totalMade = 0;
      let totalAtt = 0;

      for(const x of POS){
        const v = clamp(inp[x.key]||0, 0, SHOTS_PER_POS);
        made[x.key] = v;
        totalMade += v;
        totalAtt += SHOTS_PER_POS;
      }

      p.sessions.push({
        date,
        made,
        shotsPerPos: SHOTS_PER_POS,
        ts: Date.now()
      });

      // reset input after save
      state.inputs[p.id] = Object.fromEntries(POS.map(x=>[x.key,0]));
      saveState();
      updateUI();
    }

    function sessionsOnDate(player, date){
      return (player.sessions || []).filter(s => String(s.date) === String(date));
    }

    function computeDayPlayerStats(player, date){
      const ss = sessionsOnDate(player, date);
      if(!ss.length){
        return { byPos: POS.map(()=>0), overall:0, made:0, att:0, sessions:0 };
      }
      let made = 0, att = 0;
      const byPosMade = POS.map(()=>0);
      const byPosAtt  = POS.map(()=>0);

      for(const s of ss){
        const spp = Number(s.shotsPerPos || SHOTS_PER_POS);
        for(let i=0;i<POS.length;i++){
          const k = POS[i].key;
          const m = clamp(Number(s.made?.[k] ?? 0), 0, spp);
          byPosMade[i] += m;
          byPosAtt[i]  += spp;
          made += m;
          att  += spp;
        }
      }

      const byPos = byPosMade.map((m,i)=> byPosAtt[i] ? Math.round((m/byPosAtt[i])*100) : 0);
      const overall = att ? Math.round((made/att)*100) : 0;

      return { byPos, overall, made, att, sessions:ss.length };
    }

    /***********************
     * Chart (giornata only)
     ***********************/
    let chart = null;
    function renderChart(dayStats){
      const ctx = el("chart").getContext("2d");
      const data = {
        labels: POS.map(x=>x.label),
        datasets: [{
          data: dayStats.byPos,
          borderWidth: 3,
          pointRadius: 4,
          tension: 0.35,
        }]
      };
      const opts = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            min: 0,
            max: 100,
            ticks: { color: "rgba(234,245,238,.78)", stepSize: 20 },
            grid: { color: "rgba(255,255,255,.10)" }
          },
          x: {
            ticks: { color: "rgba(234,245,238,.78)" },
            grid: { color: "rgba(255,255,255,.08)" }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: { label: (c)=> `${c.parsed.y}%` }
          }
        }
      };
      if(chart){
        chart.data = data;
        chart.options = opts;
        chart.update();
      }else{
        chart = new Chart(ctx, { type:"line", data, options: opts });
      }
    }

    function updateDayStats(){
      ensureActiveValid();
      const p = getPlayer(state.activeId);
      const date = state.sessionDate;
      if(!p){
        dayStatLineEl.textContent = "—";
        renderChart({byPos: POS.map(()=>0)});
        return;
      }
      const st = computeDayPlayerStats(p, date);

      // If player has no saved sessions for the day, show also "live" input as hint? NO: you asked to keep it clean.
      dayStatLineEl.textContent = `Giornata ${date}: ${st.overall}% (${st.made}/${st.att}) • Sessioni: ${st.sessions}`;

      renderChart(st);
      renderDayRanking(); // keep in sync
    }

    /***********************
     * Day ranking (always visible)
     ***********************/
    function renderDayRanking(){
      const date = state.sessionDate;
      const ids = state.presentIds || [];
      rankDayMetaEl.textContent = `${date} • presenti: ${ids.length}`;

      if(!ids.length){
        rankDayListEl.innerHTML = `<div class="muted">Seleziona i giocatori presenti dal Menu ⋮.</div>`;
        return;
      }

      const rows = ids.map(id=>{
        const p = getPlayer(id);
        if(!p) return null;
        const st = computeDayPlayerStats(p, date);
        return { id, name: p.name, pct: st.overall, made: st.made, att: st.att, sessions: st.sessions, photo: p.photo };
      }).filter(Boolean);

      // if nobody has sessions today, show helpful text
      const anyData = rows.some(r=>r.sessions > 0);
      if(!anyData){
        rankDayListEl.innerHTML = `<div class="muted">Nessun dato salvato oggi. Inserisci e premi “Salva” per i presenti.</div>`;
        return;
      }

      rows.sort((a,b)=> b.pct - a.pct);

      rankDayListEl.innerHTML = "";
      rows.forEach((r, idx)=>{
        const div = document.createElement("div");
        div.className = "rankItem";

        const num = document.createElement("div");
        num.className = "rkNum";
        num.textContent = String(idx+1);

        const ava = document.createElement("div");
        ava.className = "ava";
        ava.style.width = "44px";
        ava.style.height = "44px";
        ava.style.borderRadius = "16px";
        if(r.photo){
          const img = document.createElement("img");
          img.src = r.photo;
          ava.appendChild(img);
        }else{
          ava.textContent = initials(r.name);
        }

        const nm = document.createElement("div");
        nm.className = "rkName";
        nm.textContent = r.name;

        const meta = document.createElement("div");
        meta.className = "rkMeta";
        meta.textContent = r.sessions ? `${r.made}/${r.att} • ${r.sessions} sess.` : "—";

        const pct = document.createElement("div");
        pct.className = "rkPct";
        pct.textContent = `${r.pct}%`;

        div.appendChild(num);
        div.appendChild(ava);
        div.appendChild(nm);
        div.appendChild(meta);
        div.appendChild(pct);

        // tap: switch active player
        div.addEventListener("click", ()=>{
          state.activeId = r.id;
          saveState();
          renderTabs();
          updateInputsUI();
          updateDayStats();
        });

        rankDayListEl.appendChild(div);
      });
    }

    /***********************
     * Team ranking (menu) - total average across all sessions
     ***********************/
    function computeTotalPlayer(player){
      const ss = player.sessions || [];
      if(!ss.length) return { pct:0, made:0, att:0, sessions:0 };
      let made = 0, att = 0;
      for(const s of ss){
        const spp = Number(s.shotsPerPos || SHOTS_PER_POS);
        for(const x of POS){
          made += clamp(Number(s.made?.[x.key] ?? 0), 0, spp);
          att  += spp;
        }
      }
      const pct = att ? Math.round((made/att)*100) : 0;
      return { pct, made, att, sessions:ss.length };
    }

    function renderTeamRanking(){
      const rows = state.players.map(p=>{
        const t = computeTotalPlayer(p);
        return { id:p.id, name:p.name, photo:p.photo, ...t };
      }).filter(r=>r.sessions>0);

      if(!rows.length){
        rankTeamList.innerHTML = `<div class="muted">Nessuna sessione salvata ancora.</div>`;
        return;
      }

      rows.sort((a,b)=> b.pct - a.pct);

      rankTeamList.innerHTML = "";
      rows.forEach((r, idx)=>{
        const div = document.createElement("div");
        div.className = "rankItem";

        const num = document.createElement("div");
        num.className = "rkNum";
        num.textContent = String(idx+1);

        const ava = document.createElement("div");
        ava.className = "ava";
        ava.style.width = "44px";
        ava.style.height = "44px";
        ava.style.borderRadius = "16px";
        if(r.photo){
          const img = document.createElement("img");
          img.src = r.photo;
          ava.appendChild(img);
        }else{
          ava.textContent = initials(r.name);
        }

        const nm = document.createElement("div");
        nm.className = "rkName";
        nm.textContent = r.name;

        const meta = document.createElement("div");
        meta.className = "rkMeta";
        meta.textContent = `${r.made}/${r.att} • ${r.sessions} sess.`;

        const pct = document.createElement("div");
        pct.className = "rkPct";
        pct.textContent = `${r.pct}%`;

        div.appendChild(num);
        div.appendChild(ava);
        div.appendChild(nm);
        div.appendChild(meta);
        div.appendChild(pct);

        rankTeamList.appendChild(div);
      });
    }

    /***********************
     * Tabs (present players only)
     ***********************/
    function renderTabs(){
      ensureActiveValid();

      const ids = state.presentIds || [];
      playerTabsEl.innerHTML = "";

      if(!ids.length){
        presentHintEl.textContent = "Menu ⋮ → Seleziona giocatori";
        playerTabsEl.innerHTML = `<div class="muted">Nessun giocatore selezionato.</div>`;
        return;
      }

      presentHintEl.textContent = "";

      ids.forEach(id=>{
        const p = getPlayer(id);
        if(!p) return;

        const tab = document.createElement("div");
        tab.className = "ptab" + (id === state.activeId ? " active" : "");

        const av = document.createElement("div");
        av.className = "ava";
        if(p.photo){
          const img = document.createElement("img");
          img.src = p.photo;
          av.appendChild(img);
        }else{
          av.textContent = initials(p.name);
        }

        const nm = document.createElement("div");
        nm.className = "ptabName";
        nm.textContent = p.name;

        tab.appendChild(av);
        tab.appendChild(nm);

        tab.addEventListener("click", ()=>{
          state.activeId = id;
          saveState();
          renderTabs();
          updateInputsUI();
          updateDayStats();
        });

        playerTabsEl.appendChild(tab);
      });
    }

    /***********************
     * Select players modal
     ***********************/
    function openSelectModal(){
      selectList.innerHTML = "";
      const selected = new Set(state.presentIds);

      state.players.forEach(p=>{
        const row = document.createElement("div");
        row.className = "pickRow";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = selected.has(p.id);
        cb.setAttribute("data-id", p.id);

        const av = document.createElement("div");
        av.className = "ava";
        av.style.width = "44px";
        av.style.height = "44px";
        av.style.borderRadius = "16px";
        if(p.photo){
          const img = document.createElement("img");
          img.src = p.photo;
          av.appendChild(img);
        }else{
          av.textContent = initials(p.name);
        }

        const box = document.createElement("div");
        box.style.display = "flex";
        box.style.flexDirection = "column";

        const main = document.createElement("div");
        main.className = "pickMain";
        main.textContent = p.name;

        const sub = document.createElement("div");
        sub.className = "pickSub";
        sub.textContent = p.id;

        box.appendChild(main);
        box.appendChild(sub);

        row.appendChild(cb);
        row.appendChild(av);
        row.appendChild(box);

        // tap row toggles checkbox
        row.addEventListener("click", (e)=>{
          if(e.target.tagName.toLowerCase() !== "input"){
            cb.checked = !cb.checked;
          }
        });

        selectList.appendChild(row);
      });

      openOverlay(selectOverlay);
    }

    function applySelectedPlayers(){
      const checks = selectList.querySelectorAll('input[type="checkbox"][data-id]');
      const ids = [];
      checks.forEach(c=>{
        if(c.checked) ids.push(c.getAttribute("data-id"));
      });
      state.presentIds = ids;
      ensureActiveValid();
      saveState();
      renderTabs();
      updateInputsUI();
      updateDayStats();
    }

    /***********************
     * Player modal (name + camera photo)
     ***********************/
    function renderPlayerModal(){
      const p = getPlayer(state.activeId);
      if(!p) return;
      playerNameInput.value = p.name;

      // preview
      playerPreviewAva.innerHTML = "";
      if(p.photo){
        const img = document.createElement("img");
        img.src = p.photo;
        img.style.width = "100%";
        img.style.height = "100%";
        img.style.objectFit = "cover";
        img.style.borderRadius = "24px";
        playerPreviewAva.appendChild(img);
      }else{
        playerPreviewAva.textContent = initials(p.name);
      }

      playerPhotoInput.value = "";
    }

    async function fileToDataURL(file, maxSize=720){
      const bmp = await createImageBitmap(file);
      const scale = Math.min(1, maxSize / Math.max(bmp.width, bmp.height));
      const w = Math.round(bmp.width * scale);
      const h = Math.round(bmp.height * scale);
      const c = document.createElement("canvas");
      c.width = w; c.height = h;
      const g = c.getContext("2d");
      g.drawImage(bmp, 0,0,w,h);
      return c.toDataURL("image/jpeg", 0.86);
    }

    playerPhotoInput.addEventListener("change", async ()=>{
      const file = playerPhotoInput.files && playerPhotoInput.files[0];
      if(!file) return;
      const dataUrl = await fileToDataURL(file, 720);
      const p = getPlayer(state.activeId);
      if(!p) return;
      p.photo = dataUrl;
      saveState();
      renderPlayerModal();
      renderTabs();
      updateDayStats();
    });

    /***********************
     * Export/Import
     ***********************/
    function safeFile(name){
      return String(name || "giocatore")
        .trim().toLowerCase()
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/^_+|_+$/g,"")
        .slice(0,40) || "giocatore";
    }

    function exportJSON(){
      const p = getPlayer(state.activeId);
      if(!p){ alert("Nessun giocatore attivo."); return; }
      const payload = {
        app: "VirtusShootingLab",
        version: 1,
        exportedAt: new Date().toISOString(),
        playerName: p.name,
        sessions: p.sessions
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `vsl_${safeFile(p.name)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function sessionSig(s){
      const m = s?.made || {};
      return [
        s?.date || "",
        s?.shotsPerPos || SHOTS_PER_POS,
        m.fondo_sx ?? "",
        m.angolo_sx ?? "",
        m.frontale ?? "",
        m.angolo_dx ?? "",
        m.fondo_dx ?? "",
        s?.ts || ""
      ].join("|");
    }

    // import flow variables
    let pendingImport = null; // {payload, sessions, nameLower}

    function findPlayerByNameCaseInsensitive(name){
      const n = String(name||"").trim().toLowerCase();
      if(!n) return null;
      return state.players.find(p => String(p.name||"").trim().toLowerCase() === n) || null;
    }

    function mergeSessions(targetPlayer, newSessions){
      const existing = new Set((targetPlayer.sessions||[]).map(sessionSig));
      let added = 0;
      for(const s of newSessions){
        const sig = sessionSig(s);
        if(!existing.has(sig)){
          targetPlayer.sessions.push(s);
          existing.add(sig);
          added++;
        }
      }
      return added;
    }

    function openImportPickModal(importName){
      importPickInfo.textContent = `Import: “${importName}” non trovato tra i tuoi nomi. Scegli dove importare:`;
      importPickList.innerHTML = "";

      state.players.forEach(p=>{
        const row = document.createElement("div");
        row.className = "pickRow";

        const av = document.createElement("div");
        av.className = "ava";
        av.style.width = "44px";
        av.style.height = "44px";
        av.style.borderRadius = "16px";
        if(p.photo){
          const img = document.createElement("img");
          img.src = p.photo;
          av.appendChild(img);
        }else{
          av.textContent = initials(p.name);
        }

        const box = document.createElement("div");
        box.style.display = "flex";
        box.style.flexDirection = "column";

        const main = document.createElement("div");
        main.className = "pickMain";
        main.textContent = p.name;

        const sub = document.createElement("div");
        sub.className = "pickSub";
        sub.textContent = p.id;

        box.appendChild(main);
        box.appendChild(sub);

        const go = document.createElement("button");
        go.className = "btn btnPrimary";
        go.type = "button";
        go.textContent = "Importa qui";

        go.addEventListener("click", ()=>{
          if(!pendingImport) return;
          const added = mergeSessions(p, pendingImport.sessions);
          saveState();
          closeOverlay(importPickOverlay);
          pendingImport = null;
          updateUI();
          alert(`Import completato ✅ (+${added} sessioni)`);
        });

        row.appendChild(av);
        row.appendChild(box);
        row.appendChild(go);

        importPickList.appendChild(row);
      });

      openOverlay(importPickOverlay);
    }

    async function importJSON(file){
      try{
        const txt = await file.text();
        const obj = JSON.parse(txt);
        if(!obj || !Array.isArray(obj.sessions)) throw new Error("JSON non valido");

        const importName = String(obj.playerName || "").trim();
        const sessions = obj.sessions;

        // try automatic match by name
        const target = findPlayerByNameCaseInsensitive(importName);

        if(target){
          const added = mergeSessions(target, sessions);
          saveState();
          updateUI();
          alert(`Import completato su “${target.name}” ✅ (+${added} sessioni)`);
          return;
        }

        // else: ask user where to import
        pendingImport = { sessions, importName };
        openImportPickModal(importName || "(senza nome)");
      }catch(e){
        alert("Import fallito: " + (e.message || e));
      }finally{
        importJsonEl.value = "";
      }
    }

    /***********************
     * WhatsApp share (giornata)
     ***********************/
    function shareWhatsApp(){
      const p = getPlayer(state.activeId);
      if(!p){ alert("Nessun giocatore attivo."); return; }
      const date = state.sessionDate;
      const st = computeDayPlayerStats(p, date);

      const msg =
`🏀 Virtus Shooting Lab
Giocatore: ${p.name}
Giornata: ${date}
Risultato: ${st.overall}% (${st.made}/${st.att})
Sessioni: ${st.sessions}

Fondo sx: ${st.byPos[0]}%
45° sx: ${st.byPos[1]}%
Frontale: ${st.byPos[2]}%
45° dx: ${st.byPos[3]}%
Fondo dx: ${st.byPos[4]}%`;

      const url = "https://wa.me/?text=" + encodeURIComponent(msg);
      window.open(url, "_blank");
    }

    /***********************
     * Reset total sessions (keep names/photos)
     ***********************/
    function resetAllSessions(){
      const ok = confirm("Vuoi cancellare TUTTE le sessioni salvate? (Nomi e foto restano)");
      if(!ok) return;
      for(const p of state.players){
        p.sessions = [];
      }
      saveState();
      updateUI();
      alert("Sessioni cancellate ✅");
    }

    /***********************
     * UI update
     ***********************/
    function updateUI(){
      ensureActiveValid();

      sessionDateEl.value = state.sessionDate;
      timerPresetEl.value = String(state.timerSec);

      renderTabs();
      updateInputsUI();

      resetTimer();
      updateDayStats();
    }

    /***********************
     * Events
     ***********************/
    // session date
    sessionDateEl.addEventListener("change", ()=>{
      state.sessionDate = sessionDateEl.value || todayISO();
      saveState();
      updateDayStats();
    });

    // timer preset
    timerPresetEl.addEventListener("change", ()=>{
      const v = Number(timerPresetEl.value);
      state.timerSec = [35,40,45].includes(v) ? v : 45;
      saveState();
      resetTimer();
    });

    startBtn.addEventListener("click", startTimer);
    stopBtn.addEventListener("click", stopTimer);
    resetBtn.addEventListener("click", resetTimer);

    clearBtn.addEventListener("click", clearInputs);
    saveBtn.addEventListener("click", saveSession);
    shareBtn.addEventListener("click", shareWhatsApp);

    // menu
    menuBtn.addEventListener("click", ()=>openOverlay(menuOverlay));
    menuClose.addEventListener("click", ()=>closeOverlay(menuOverlay));
    menuClose2.addEventListener("click", ()=>closeOverlay(menuOverlay));

    menuSelectPlayers.addEventListener("click", ()=>{
      closeOverlay(menuOverlay);
      openSelectModal();
    });
    menuPlayer.addEventListener("click", ()=>{
      closeOverlay(menuOverlay);
      renderPlayerModal();
      openOverlay(playerOverlay);
    });
    menuTeamRanking.addEventListener("click", ()=>{
      closeOverlay(menuOverlay);
      renderTeamRanking();
      openOverlay(teamOverlay);
    });
    menuBackup.addEventListener("click", ()=>{
      closeOverlay(menuOverlay);
      openOverlay(backupOverlay);
    });
    menuResetSessions.addEventListener("click", ()=>{
      closeOverlay(menuOverlay);
      resetAllSessions();
    });

    // select players
    openSelectPlayersBtn.addEventListener("click", openSelectModal);
    selectClose.addEventListener("click", ()=>closeOverlay(selectOverlay));
    selectCancel.addEventListener("click", ()=>closeOverlay(selectOverlay));
    selectOk.addEventListener("click", ()=>{
      applySelectedPlayers();
      closeOverlay(selectOverlay);
    });

    // player modal
    playerClose.addEventListener("click", ()=>closeOverlay(playerOverlay));
    playerClose2.addEventListener("click", ()=>closeOverlay(playerOverlay));
    playerSave.addEventListener("click", ()=>{
      const p = getPlayer(state.activeId);
      if(!p) return;
      const name = (playerNameInput.value || "").trim();
      if(name) p.name = name;
      saveState();
      renderPlayerModal();
      renderTabs();
      updateDayStats();
      closeOverlay(playerOverlay);
    });
    playerRemovePhoto.addEventListener("click", ()=>{
      const p = getPlayer(state.activeId);
      if(!p) return;
      p.photo = null;
      saveState();
      renderPlayerModal();
      renderTabs();
      updateDayStats();
    });

    // team modal
    teamClose.addEventListener("click", ()=>closeOverlay(teamOverlay));
    teamClose2.addEventListener("click", ()=>closeOverlay(teamOverlay));

    // backup
    backupClose.addEventListener("click", ()=>closeOverlay(backupOverlay));
    backupClose2.addEventListener("click", ()=>closeOverlay(backupOverlay));
    exportJsonBtn.addEventListener("click", exportJSON);
    importJsonEl.addEventListener("change", ()=>{
      const f = importJsonEl.files && importJsonEl.files[0];
      if(!f) return;
      importJSON(f);
    });

    // import pick
    importPickClose.addEventListener("click", ()=>{
      pendingImport = null;
      closeOverlay(importPickOverlay);
    });
    importPickCancel.addEventListener("click", ()=>{
      pendingImport = null;
      closeOverlay(importPickOverlay);
    });

    /***********************
     * Boot
     ***********************/
    // ensure date
    if(!state.sessionDate) state.sessionDate = todayISO();
    // default presentIds if empty? keep empty (you choose who is present)
    ensureActiveValid();

    // init controls
    sessionDateEl.value = state.sessionDate;
    timerPresetEl.value = String(state.timerSec);
    timeDisplayEl.textContent = fmt(state.timerSec);

    updateUI();

    // If on resize, refresh chart sizing (Chart.js generally handles it, but safe)
    window.addEventListener("resize", ()=>{
      try{ if(chart) chart.resize(); }catch(e){}
    }, {passive:true});
  </script>
</body>
</html>
