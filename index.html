<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Virtus Shot Tracker</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#062714" />

  <!-- Chart.js (CDN stabile) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#04180d;
      --bg2:#0a2c18;
      --card: rgba(0,0,0,.35);
      --card2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --accent:#1e8239;
      --accent2:#0f5f27;
      --danger:#8a2f2f;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --btnRadius: 16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(30,130,57,.35), transparent 55%),
        radial-gradient(900px 700px at 90% 30%, rgba(30,130,57,.20), transparent 55%),
        linear-gradient(160deg, var(--bg2), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:20px 14px 70px;}
    .hero{
      padding:18px 18px 8px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(30,130,57,.18), rgba(0,0,0,.0));
    }
    h1{
      margin:0 0 8px 0;
      font-weight:800;
      letter-spacing:.2px;
      font-size: clamp(34px, 6vw, 52px);
      line-height:1.05;
    }
    .subrow{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      color:var(--muted);
      font-size:14px;
    }
    .pill{
      margin-left:auto;
      padding:8px 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      color: var(--text);
      font-weight:600;
    }
    .card{
      margin-top:16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .cardTitle{
      font-size:28px;
      font-weight:800;
      margin:0 0 12px 0;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .col{flex:1;min-width:250px;}
    label{display:block;color:var(--muted);font-size:13px;margin:10px 0 6px;}
    input[type="text"], input[type="date"], textarea, select{
      width:100%;
      padding:14px 14px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      font-size:16px;
    }
    textarea{min-height:54px;resize:vertical;}
    .btnRow{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;}
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:14px 14px;
      border-radius: var(--btnRadius);
      font-weight:800;
      font-size:16px;
      cursor:pointer;
    }
    button.primary{
      background: linear-gradient(180deg, rgba(30,130,57,.95), rgba(15,95,39,.95));
      border-color: rgba(30,130,57,.55);
    }
    button.danger{
      background: rgba(138,47,47,.42);
      border-color: rgba(138,47,47,.45);
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;
      margin-top:6px;
    }
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(30,130,57,.35);
      border-color: rgba(30,130,57,.55);
    }

    .shotGrid{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:10px;
    }
    .shotRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:center;
      padding:14px;
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.07);
    }
    .shotName{
      font-size:22px;
      font-weight:900;
      margin:0;
      line-height:1.1;
    }
    .shotMeta{
      margin-top:3px;
      color:var(--muted);
      font-weight:700;
      font-size:13px;
    }
    .counter{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .counter button{
      width:50px;height:50px;
      padding:0;
      border-radius: 16px;
      font-size:22px;
      font-weight:900;
      background: rgba(0,0,0,.25);
    }
    .counter .val{
      width:62px;
      text-align:center;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.28);
      font-size:20px;
      font-weight:900;
    }
    .hint{
      color:var(--muted);
      font-size:13px;
      margin-top:10px;
      line-height:1.35;
    }

    /* Timer area */
    .timerBox{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;flex-wrap:wrap;
      padding:14px;
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.07);
      margin-top:12px;
    }
    .timerLeft{
      display:flex;flex-direction:column;gap:4px;
    }
    .timerBig{
      font-size:34px;
      font-weight:950;
      letter-spacing:.6px;
    }
    .timerSmall{color:var(--muted);font-weight:800;}
    .timerBtns{display:flex;gap:10px;flex-wrap:wrap;}
    .timerBtns button{min-width:140px;}
    .mini{
      font-size:13px;color:var(--muted);font-weight:800;margin-top:8px;
    }

    /* Stats */
    .chartWrap{
      position:relative;
      padding:10px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .watermark{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      opacity:.12;
      filter: saturate(1.1) contrast(1.1);
    }
    .watermark img{
      max-width: 72%;
      max-height: 72%;
      transform: rotate(-10deg);
    }
    canvas{width:100% !important;height:320px !important; background: transparent;}

    .footerSpace{height:18px;}

    /* Mobile polish */
    @media (max-width:520px){
      .counter .val{width:58px;}
      .timerBtns button{min-width:120px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1>Virtus Shot<br/>Tracker</h1>
      <div class="subrow">
        <div>Sessione = <b>10 tiri</b> per posizione ‚Ä¢ Statistiche 0‚Äì100%</div>
        <div class="pill" id="statusPill">Pronto</div>
      </div>
    </div>

    <!-- PLAYER / SETTINGS -->
    <div class="card">
      <div class="cardTitle">Giocatori</div>

      <div class="tabs" id="playerTabs"></div>

      <label>Nome giocatore (tab selezionato)</label>
      <input id="playerName" type="text" placeholder="Es. Marco" />

      <div class="row">
        <div class="col">
          <label>Timer gara</label>
          <select id="timerPreset">
            <option value="45">45 sec</option>
            <option value="40">40 sec</option>
            <option value="35">35 sec</option>
          </select>
        </div>

        <div class="col">
          <label>Import JSON (auto sul giocatore giusto)</label>
          <input id="importFile" type="file" accept="application/json" />
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="saveNameBtn">Salva nome</button>
        <button class="danger" id="resetPlayerBtn">Reset giocatore</button>
        <button id="exportBtn">Esporta JSON</button>
        <button id="shareBtn" class="primary">Condividi su WhatsApp</button>
      </div>

      <div class="hint">
        Suggerimento: dopo ‚ÄúSalva sessione‚Äù puoi condividere subito il report. Il JSON serve per backup / invio coach.
      </div>
    </div>

    <!-- GARA -->
    <div class="card">
      <div class="cardTitle">Modalit√† gara</div>

      <div class="timerBox">
        <div class="timerLeft">
          <div class="timerSmall">Tempo per ogni posizione</div>
          <div class="timerBig" id="timerDisplay">00:45</div>
          <div class="timerSmall" id="timerNote">Seleziona 45/40/35 e premi Start.</div>
        </div>
        <div class="timerBtns">
          <button class="primary" id="startTimerBtn">Start</button>
          <button id="stopTimerBtn">Stop</button>
          <button id="resetTimerBtn">Reset</button>
        </div>
      </div>
      <div class="mini">
        A fine tempo: <b>beep + vibrazione</b> (se il telefono lo permette). La gara √® ‚Äúsolo timer‚Äù.
      </div>
    </div>

    <!-- SESSION -->
    <div class="card">
      <div class="cardTitle">Nuova sessione</div>

      <div class="row">
        <div class="col">
          <label>Data</label>
          <input id="sessionDate" type="date" />
        </div>
        <div class="col">
          <label>Note (opzionale)</label>
          <textarea id="sessionNote" placeholder="Es. dopo allenamento / gara..."></textarea>
        </div>
      </div>

      <div class="hint">
        Inserisci i canestri segnati (0‚Äì10) con +/-.
      </div>

      <div class="shotGrid" id="shotGrid"></div>

      <div class="btnRow" style="margin-top:14px;">
        <button id="clearEntryBtn">Azzera inserimento</button>
        <button class="primary" id="saveSessionBtn">Salva sessione</button>
      </div>

      <div class="hint">
        Dopo ‚ÄúSalva sessione‚Äù puoi condividere su WhatsApp dal tasto ‚ÄúCondividi su WhatsApp‚Äù.
      </div>
    </div>

    <!-- STATS -->
    <div class="card">
      <div class="cardTitle">Statistiche</div>
      <div class="hint">Grafico sempre da <b>0% a 100%</b>.</div>

      <div class="chartWrap">
        <div class="watermark">
          <!-- usa PNG/SVG che hai gi√† nel repo: preferisco icon-512.png -->
          <img id="wmImg" src="icon-512.png" alt="Virtus watermark" />
        </div>
        <canvas id="shotChart"></canvas>
      </div>

      <div class="footerSpace"></div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const APP_KEY = "virtusShotTracker_v8";
const POSITIONS = [
  { key:"fondo_sx", label:"Fondo sx", idx:1 },
  { key:"45_sx",    label:"45¬∞ sx",  idx:2 },
  { key:"front",    label:"Frontale",idx:3 },
  { key:"45_dx",    label:"45¬∞ dx",  idx:4 },
  { key:"fondo_dx", label:"Fondo dx",idx:5 },
];
const SHOTS_PER_POSITION = 10;
const PLAYER_SLOTS = 12;

/* =========================
   STATE
========================= */
let state = loadState();
let chart = null;

// timer
let tRunning = false;
let tEndAt = 0;
let tTick = null;
let lastBeepAt = 0;

/* =========================
   INIT
========================= */
initTabs();
initForm();
initShotInputs();
initChart();
renderAll();

/* =========================
   STORAGE
========================= */
function defaultState(){
  const players = {};
  for(let i=1;i<=PLAYER_SLOTS;i++){
    players["p"+i] = {
      id:"p"+i,
      name:"Giocatore " + i,
      photo:null,
      sessions:[],
      // current entry (draft)
      draft:{
        date: todayISO(),
        note:"",
        values: Object.fromEntries(POSITIONS.map(p => [p.key, 0]))
      }
    };
  }
  return {
    version: 8,
    selectedPlayerId: "p1",
    timerPreset: 45,
    players
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(APP_KEY);
    if(!raw) return defaultState();
    const parsed = JSON.parse(raw);

    // upgrade safety
    if(!parsed.players){
      return defaultState();
    }

    // ensure slots exist
    for(let i=1;i<=PLAYER_SLOTS;i++){
      const id="p"+i;
      if(!parsed.players[id]){
        parsed.players[id] = defaultState().players[id];
      }
    }
    if(!parsed.selectedPlayerId || !parsed.players[parsed.selectedPlayerId]){
      parsed.selectedPlayerId="p1";
    }
    if(!parsed.timerPreset) parsed.timerPreset = 45;

    // ensure drafts
    for(const id of Object.keys(parsed.players)){
      const pl = parsed.players[id];
      if(!pl.draft){
        pl.draft = { date: todayISO(), note:"", values: Object.fromEntries(POSITIONS.map(p => [p.key, 0])) };
      }
      if(!pl.draft.values){
        pl.draft.values = Object.fromEntries(POSITIONS.map(p => [p.key, 0]));
      }
      for(const p of POSITIONS){
        if(typeof pl.draft.values[p.key] !== "number") pl.draft.values[p.key]=0;
      }
      if(!Array.isArray(pl.sessions)) pl.sessions=[];
      if(typeof pl.name !== "string") pl.name = pl.name ? String(pl.name) : id;
    }
    return parsed;
  }catch(e){
    return defaultState();
  }
}
function saveState(){
  localStorage.setItem(APP_KEY, JSON.stringify(state));
}
function currentPlayer(){
  return state.players[state.selectedPlayerId];
}

/* =========================
   UI INIT
========================= */
function initTabs(){
  const tabs = document.getElementById("playerTabs");
  tabs.innerHTML = "";
  for(let i=1;i<=PLAYER_SLOTS;i++){
    const id="p"+i;
    const b=document.createElement("div");
    b.className="tab";
    b.textContent="Giocatore " + i;
    b.dataset.pid=id;
    b.addEventListener("click", () => {
      state.selectedPlayerId=id;
      saveState();
      renderAll();
    });
    tabs.appendChild(b);
  }
}

function initForm(){
  document.getElementById("saveNameBtn").addEventListener("click", () => {
    const pl = currentPlayer();
    const name = (document.getElementById("playerName").value || "").trim();
    if(name) pl.name = name;
    saveState();
    renderAll();
  });

  document.getElementById("resetPlayerBtn").addEventListener("click", () => {
    if(!confirm("Reset totale giocatore selezionato? (dati e sessioni)")) return;
    const id = state.selectedPlayerId;
    state.players[id] = defaultState().players[id];
    saveState();
    renderAll();
  });

  document.getElementById("timerPreset").addEventListener("change", (e) => {
    state.timerPreset = parseInt(e.target.value,10) || 45;
    saveState();
    if(!tRunning){
      setTimerDisplay(state.timerPreset);
    }
  });

  document.getElementById("sessionDate").addEventListener("change", (e) => {
    const pl = currentPlayer();
    pl.draft.date = e.target.value;
    saveState();
  });

  document.getElementById("sessionNote").addEventListener("input", (e) => {
    const pl = currentPlayer();
    pl.draft.note = e.target.value;
    saveState();
  });

  document.getElementById("clearEntryBtn").addEventListener("click", () => {
    const pl = currentPlayer();
    for(const p of POSITIONS) pl.draft.values[p.key]=0;
    saveState();
    renderAll();
  });

  document.getElementById("saveSessionBtn").addEventListener("click", () => {
    const pl = currentPlayer();
    const values = { ...pl.draft.values };
    const totalMade = Object.values(values).reduce((a,b)=>a+b,0);
    const totalShots = SHOTS_PER_POSITION * POSITIONS.length;

    const session = {
      id: "s_" + Date.now(),
      date: pl.draft.date || todayISO(),
      note: pl.draft.note || "",
      values,
      totalMade,
      totalShots,
      createdAt: new Date().toISOString()
    };
    pl.sessions.unshift(session);

    // reset draft for next
    pl.draft.note = "";
    for(const p of POSITIONS) pl.draft.values[p.key]=0;

    saveState();
    renderAll();

    flashPill("Sessione salvata ‚úÖ");
  });

  // Export / Share
  document.getElementById("exportBtn").addEventListener("click", exportJSON);
  document.getElementById("shareBtn").addEventListener("click", shareWhatsApp);

  // Import JSON
  document.getElementById("importFile").addEventListener("change", handleImportFile);

  // Timer buttons
  document.getElementById("startTimerBtn").addEventListener("click", startTimer);
  document.getElementById("stopTimerBtn").addEventListener("click", stopTimer);
  document.getElementById("resetTimerBtn").addEventListener("click", resetTimer);

  // Defaults
  document.getElementById("timerPreset").value = String(state.timerPreset || 45);
  setTimerDisplay(state.timerPreset || 45);

  // date default
  const pl=currentPlayer();
  if(!pl.draft.date) pl.draft.date = todayISO();
  document.getElementById("sessionDate").value = pl.draft.date || todayISO();
}

function initShotInputs(){
  const grid = document.getElementById("shotGrid");
  grid.innerHTML = "";
  for(const p of POSITIONS){
    const row = document.createElement("div");
    row.className="shotRow";

    const left = document.createElement("div");
    const name = document.createElement("div");
    name.className="shotName";
    name.textContent = p.label;
    const meta = document.createElement("div");
    meta.className="shotMeta";
    meta.textContent = `(su ${SHOTS_PER_POSITION}) ‚Ä¢ Posizione ${p.idx}/${POSITIONS.length}`;
    left.appendChild(name);
    left.appendChild(meta);

    const right = document.createElement("div");
    right.className="counter";

    const minus = document.createElement("button");
    minus.textContent = "‚àí";
    minus.addEventListener("click", () => bumpValue(p.key, -1));

    const val = document.createElement("div");
    val.className="val";
    val.id = `val_${p.key}`;
    val.textContent = "0";

    const plus = document.createElement("button");
    plus.textContent = "+";
    plus.addEventListener("click", () => bumpValue(p.key, +1));

    right.appendChild(minus);
    right.appendChild(val);
    right.appendChild(plus);

    row.appendChild(left);
    row.appendChild(right);
    grid.appendChild(row);
  }
}

function initChart(){
  const ctx = document.getElementById("shotChart");
  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: POSITIONS.map(p => p.label),
      datasets: [{
        label: "% realizzazione",
        data: POSITIONS.map(() => 0),
        borderWidth: 1,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 250 },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks:{
            label: (c) => `${Math.round(c.parsed.y)}%`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          min: 0,
          max: 100,
          ticks: {
            callback: (v) => v + "%"
          }
        },
        x: {
          ticks: { maxRotation: 0, minRotation: 0 }
        }
      }
    }
  });
}

/* =========================
   RENDER
========================= */
function renderAll(){
  // tabs active + labels
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach(t => {
    const pid=t.dataset.pid;
    t.classList.toggle("active", pid === state.selectedPlayerId);
    const pl = state.players[pid];
    // show short name on tab
    if(pl && pl.name){
      // keep "Giocatore i" label but if renamed show first word
      const i = pid.replace("p","");
      t.textContent = pl.name ? pl.name : ("Giocatore " + i);
    }
  });

  // form fields
  const pl = currentPlayer();
  document.getElementById("playerName").value = pl.name || "";
  document.getElementById("sessionDate").value = pl.draft.date || todayISO();
  document.getElementById("sessionNote").value = pl.draft.note || "";
  document.getElementById("timerPreset").value = String(state.timerPreset || 45);

  // shot values
  for(const p of POSITIONS){
    const el = document.getElementById(`val_${p.key}`);
    if(el) el.textContent = String(pl.draft.values[p.key] ?? 0);
  }

  // watermark fallback (se icon-512.png non esiste)
  const wm = document.getElementById("wmImg");
  wm.onerror = () => { wm.src = "icon-192.png"; };

  // chart update
  updateChart();

  // status pill
  const pill = document.getElementById("statusPill");
  pill.textContent = tRunning ? "Gara in corso" : "Pronto";
}

/* =========================
   VALUE LOGIC (PER PLAYER!)
========================= */
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function bumpValue(key, delta){
  const pl = currentPlayer();
  const cur = pl.draft.values[key] ?? 0;
  const next = clamp(cur + delta, 0, SHOTS_PER_POSITION);
  pl.draft.values[key] = next;
  saveState();
  const el = document.getElementById(`val_${key}`);
  if(el) el.textContent = String(next);
  updateChart();
}

/* =========================
   CHART LOGIC
========================= */
function updateChart(){
  const pl = currentPlayer();
  const last = pl.sessions[0]; // last saved
  // We plot last saved session if exists; otherwise plot draft
  const sourceValues = last ? last.values : pl.draft.values;

  const perc = POSITIONS.map(p => {
    const made = sourceValues[p.key] ?? 0;
    return Math.round((made / SHOTS_PER_POSITION) * 100);
  });

  chart.data.datasets[0].data = perc;
  chart.update();
}

/* =========================
   TIMER (gara)
========================= */
function setTimerDisplay(seconds){
  const mm = String(Math.floor(seconds/60)).padStart(2,"0");
  const ss = String(seconds%60).padStart(2,"0");
  document.getElementById("timerDisplay").textContent = `${mm}:${ss}`;
}

function startTimer(){
  if(tRunning) return;
  const sec = parseInt(document.getElementById("timerPreset").value,10) || 45;
  state.timerPreset = sec;
  saveState();

  tRunning = true;
  tEndAt = Date.now() + sec*1000;
  document.getElementById("timerNote").textContent = "Timer in corso‚Ä¶";
  renderAll();

  tTick = setInterval(() => {
    const left = Math.max(0, Math.ceil((tEndAt - Date.now())/1000));
    setTimerDisplay(left);

    if(left <= 0){
      finishTimer();
    }
  }, 200);
}

function stopTimer(){
  if(!tRunning) return;
  tRunning = false;
  clearInterval(tTick);
  tTick = null;
  document.getElementById("timerNote").textContent = "Timer fermato.";
  setTimerDisplay(state.timerPreset || 45);
  renderAll();
}

function resetTimer(){
  tRunning = false;
  clearInterval(tTick);
  tTick = null;
  document.getElementById("timerNote").textContent = "Seleziona 45/40/35 e premi Start.";
  setTimerDisplay(state.timerPreset || 45);
  renderAll();
}

function finishTimer(){
  if(!tRunning) return;
  tRunning = false;
  clearInterval(tTick);
  tTick = null;

  setTimerDisplay(0);
  document.getElementById("timerNote").textContent = "Tempo finito ‚úÖ";

  // beep + vibrazione
  try{
    if(navigator.vibrate) navigator.vibrate([200,80,200,80,260]);
  }catch(e){}

  try{
    // Beep semplice via WebAudio (senza autostart, √® attivato da click Start)
    const now = Date.now();
    if(now - lastBeepAt > 500){
      lastBeepAt = now;
      const AC = window.AudioContext || window.webkitAudioContext;
      const ac = new AC();
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = "square";
      o.frequency.value = 880;
      g.gain.value = 0.08;
      o.connect(g); g.connect(ac.destination);
      o.start();
      setTimeout(() => { o.stop(); ac.close(); }, 220);
    }
  }catch(e){}

  renderAll();
  flashPill("TEMPO FINITO üîî");
}

/* =========================
   EXPORT / IMPORT
========================= */
function exportJSON(){
  const pl = currentPlayer();
  const payload = {
    app: "Virtus Shot Tracker",
    version: state.version,
    exportedAt: new Date().toISOString(),
    player: {
      id: pl.id,
      name: pl.name,
      sessions: pl.sessions
    }
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `virtus_shot_${safeFileName(pl.name || pl.id)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(()=>URL.revokeObjectURL(url), 1500);
  flashPill("JSON esportato ‚úÖ");
}

function handleImportFile(ev){
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);

      // Accept either full export payload or raw player object
      let playerObj = null;
      if(data && data.player && data.player.sessions){
        playerObj = data.player;
      }else if(data && data.sessions){
        playerObj = data;
      }else{
        throw new Error("Formato non valido");
      }

      // Find matching player tab by name (best effort), else use current
      const incomingName = (playerObj.name || "").trim();
      let targetId = state.selectedPlayerId;

      if(incomingName){
        const found = Object.values(state.players).find(p => (p.name||"").trim().toLowerCase() === incomingName.toLowerCase());
        if(found) targetId = found.id;
      }

      // Merge: replace sessions, keep draft reset
      const tgt = state.players[targetId];
      tgt.name = incomingName || tgt.name;
      tgt.sessions = Array.isArray(playerObj.sessions) ? playerObj.sessions : [];
      tgt.draft = {
        date: todayISO(),
        note:"",
        values: Object.fromEntries(POSITIONS.map(p => [p.key, 0]))
      };

      state.selectedPlayerId = targetId;
      saveState();
      renderAll();
      flashPill("Import OK ‚úÖ");

    }catch(e){
      alert("Errore import JSON: " + (e.message || "file non valido"));
    }finally{
      ev.target.value = "";
    }
  };
  reader.readAsText(file);
}

/* =========================
   WHATSAPP SHARE (testo)
========================= */
function shareWhatsApp(){
  const pl = currentPlayer();
  const last = pl.sessions[0];
  if(!last){
    alert("Prima salva almeno una sessione.");
    return;
  }

  const lines = [];
  lines.push(`üèÄ Virtus Shot ‚Ä¢ ${pl.name}`);
  lines.push(`üìÖ ${formatDateIT(last.date)} ‚Ä¢ Sessione: 10 tiri per posizione`);
  lines.push("");
  for(const p of POSITIONS){
    const made = last.values[p.key] ?? 0;
    const perc = Math.round((made/SHOTS_PER_POSITION)*100);
    lines.push(`${p.label}: ${made}/${SHOTS_PER_POSITION} (${perc}%)`);
  }
  lines.push("");
  const totPerc = Math.round((last.totalMade/last.totalShots)*100);
  lines.push(`Totale: ${last.totalMade}/${last.totalShots} (${totPerc}%)`);
  if(last.note){
    lines.push(`Note: ${last.note}`);
  }

  const text = encodeURIComponent(lines.join("\n"));
  const url = `https://wa.me/?text=${text}`;
  window.open(url, "_blank");
}

/* =========================
   HELPERS
========================= */
function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function formatDateIT(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}
function safeFileName(s){
  return (s||"player")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g,"_")
    .replace(/^_+|_+$/g,"")
    .slice(0,40) || "player";
}
function flashPill(msg){
  const pill = document.getElementById("statusPill");
  const prev = pill.textContent;
  pill.textContent = msg;
  setTimeout(()=>{ pill.textContent = tRunning ? "Gara in corso" : "Pronto"; }, 1400);
}
</script>
</body>
</html>
