<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#062b1a" />
  <title>Virtus Shot Tracker</title>

  <style>
    :root{
      --bg0:#020403;
      --bg1:#04140d;
      --bg2:#062b1a;
      --card:rgba(8, 20, 14, .78);
      --card2:rgba(10, 26, 18, .86);
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.58);
      --green:#12c46a;
      --green2:#0a7a43;
      --shadow: 0 12px 28px rgba(0,0,0,.45);
      --r:22px;
      --r2:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(18,196,106,.20), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(18,196,106,.14), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg0) 60%);
      min-height:100%;
    }

    .wrap{
      width:min(980px, 94vw);
      margin: 18px auto 40px;
      padding-bottom: 24px;
    }

    .card{
      background: linear-gradient(180deg, rgba(18,196,106,.08), transparent 55%), var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card.pad{ padding: 16px; }
    .row{display:flex; gap:12px; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}
    .spacer{flex:1}
    .muted{color:var(--muted)}
    .divider{height:1px; background:var(--stroke); margin:12px 0}

    /* HEADER */
    .header{
      padding:16px 16px;
      display:flex;
      align-items:center;
      gap:14px;
      background:
        radial-gradient(700px 300px at 10% 0%, rgba(18,196,106,.20), transparent 60%),
        linear-gradient(135deg, rgba(0,0,0,.30), rgba(0,0,0,.08));
    }
    .logo{
      width:64px; height:64px; border-radius:16px;
      background: rgba(0,0,0,.35);
      border:1px solid var(--stroke2);
      display:grid; place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo img{width:100%; height:100%; object-fit:cover}
    .titleBox{display:flex; flex-direction:column; gap:2px}
    .title{
      font-size: 34px;
      font-weight: 900;
      letter-spacing:.2px;
      line-height:1.05;
      margin:0;
      text-shadow: 0 2px 16px rgba(0,0,0,.35);
      word-break: break-word;
    }

    /* TOP BAR: player + menu */
    .topbar{
      margin-top:14px;
      padding: 14px 14px;
      display:flex; align-items:center; gap:12px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.30);
      border:1px solid var(--stroke2);
      max-width: 70%;
    }
    .badge{
      width:34px; height:34px; border-radius:999px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      font-weight:800;
      color:rgba(255,255,255,.85);
      flex:0 0 auto;
    }
    .pname{
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pmini{
      width:34px; height:34px; border-radius:12px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      flex:0 0 auto;
    }
    .pmini img{width:100%; height:100%; object-fit:cover}

    .iconBtn{
      width:44px; height:44px; border-radius:14px;
      display:grid; place-items:center;
      background: rgba(0,0,0,.28);
      border:1px solid var(--stroke2);
      color:var(--txt);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:active{transform: scale(.98)}
    .dots{font-size:22px; line-height:0}

    /* SECTION TITLES */
    .sectionTitle{
      margin: 10px 2px 8px;
      font-size: 24px;
      font-weight: 900;
      letter-spacing:.2px;
    }

    /* INPUTS */
    input[type="text"], input[type="date"], select{
      width:100%;
      padding: 14px 14px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--txt);
      outline:none;
      font-size: 16px;
    }
    input[type="date"]{color-scheme: dark}
    select{appearance:none}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}

    /* TIMER */
    .timerBox{
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(18,196,106,.10), rgba(0,0,0,.22));
      padding: 14px;
    }
    .time{
      font-size: 66px;
      font-weight: 1000;
      letter-spacing: 1px;
      text-align:center;
      margin: 6px 0 12px;
      text-shadow: 0 2px 20px rgba(0,0,0,.35);
    }
    .btnRow{display:flex; gap:10px; align-items:center; justify-content:center}
    .btn{
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.28);
      color: var(--txt);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      min-width: 92px;
    }
    .btn:active{transform: scale(.98)}
    .btnPrimary{
      background: linear-gradient(180deg, rgba(18,196,106,.22), rgba(18,196,106,.10));
      border-color: rgba(18,196,106,.35);
    }
    .btnStartBig{
      min-width: 190px;
      font-size: 18px;
      padding: 16px 18px;
      border-radius: 18px;
    }

    /* SHOOT INPUT */
    .shotRow{
      display:grid;
      grid-template-columns: 1fr auto auto auto;
      gap:10px;
      align-items:center;
      padding: 12px 12px;
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
    }
    .shotName{
      font-weight: 950;
      font-size: 18px;
      line-height:1.05;
    }
    .shotSub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .pmBtn{
      width:46px; height:46px;
      border-radius: 16px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.26);
      color: var(--txt);
      font-size: 26px;
      font-weight: 900;
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .pmBtn:active{transform: scale(.98)}
    .val{
      width:64px;
      text-align:center;
      font-size: 22px;
      font-weight: 1000;
      padding: 10px 0;
      border-radius: 16px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.18);
    }

    .actions2{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top: 12px}

    /* STATS */
    .statsBox{
      position:relative;
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      padding: 12px;
      overflow:hidden;
    }
    .statsLogo{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      opacity:.14;
      pointer-events:none;
      transform: translateY(10px);
    }
    .statsLogo img{
      width:min(420px, 80%);
      filter: saturate(1.1) contrast(1.05);
    }
    canvas{
      width:100% !important;
      height: 260px !important;
    }

    /* OVERLAY / MODALS */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      z-index: 9999;
      padding: 14px;
      align-items:center;
      justify-content:center;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(720px, 96vw);
      max-height: 86vh;
      overflow:hidden;
      border-radius: 22px;
      border:1px solid var(--stroke2);
      background: rgba(6, 18, 12, .94);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding: 14px 14px;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(18,196,106,.10), transparent 70%);
    }
    .modalTitle{font-weight:1000; font-size: 18px}
    .modalBody{
      padding: 12px;
      overflow:auto;           /* <-- SCROLL QUI */
      -webkit-overflow-scrolling: touch;
      flex:1 1 auto;
    }
    .modalFoot{
      padding: 12px;
      border-top:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }

    .listItem{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 12px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      margin-bottom: 10px;
    }
    .listItem input{width:22px; height:22px}
    .liText{display:flex; flex-direction:column}
    .liMain{font-weight: 950}
    .liSub{font-size:12px; color:var(--muted)}

    .menuItem{
      width:100%;
      text-align:left;
      padding: 14px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      font-weight: 950;
      cursor:pointer;
      margin-bottom: 10px;
    }
    .menuItem:active{transform: scale(.99)}

    /* Responsive */
    @media (max-width:520px){
      .title{font-size:30px}
      .time{font-size:58px}
      .shotRow{grid-template-columns: 1fr auto auto auto}
      canvas{height:240px !important}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- HEADER BOX -->
    <div class="card">
      <div class="header">
        <div class="logo" id="logoBox">
          <img id="logoImg" alt="Virtus logo" src="icon-512.png" />
        </div>
        <div class="titleBox">
          <h1 class="title">Virtus Shot Tracker</h1>
        </div>
      </div>

      <!-- PLAYER + MENU -->
      <div class="topbar">
        <div class="pill" id="playerPill" title="Giocatore selezionato">
          <div class="badge" id="playerBadge">G1</div>
          <div class="pmini" id="playerPhotoMini" style="display:none">
            <img id="playerPhotoMiniImg" alt="foto giocatore" />
          </div>
          <div class="pname" id="playerNameTop">Giocatore 1</div>
        </div>
        <div class="spacer"></div>
        <button class="iconBtn" id="menuBtn" aria-label="Menu">
          <span class="dots">⋮</span>
        </button>
      </div>
    </div>

    <!-- SESSION -->
    <div class="card pad" style="margin-top:14px;">
      <div class="sectionTitle">Sessione</div>
      <div class="grid2">
        <div class="col">
          <label class="muted" for="sessionDate">Data sessione</label>
          <input id="sessionDate" type="date" />
        </div>
        <div class="col">
          <label class="muted" for="timerPreset">Timer</label>
          <select id="timerPreset">
            <option value="45">45 sec</option>
            <option value="40">40 sec</option>
            <option value="35">35 sec</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row" style="gap:10px;">
        <div class="col" style="flex:1;">
          <div class="muted">Giocatori presenti</div>
          <div id="presentSummary" style="font-weight:900;">Nessuno selezionato</div>
        </div>
        <button class="btn btnPrimary" id="openSelectPlayers">Seleziona</button>
      </div>
    </div>

    <!-- TIMER -->
    <div class="card pad" style="margin-top:14px;">
      <div class="sectionTitle">Timer</div>
      <div class="timerBox">
        <div class="time" id="timeDisplay">00:45</div>
        <div class="btnRow">
          <button class="btn btnPrimary btnStartBig" id="startBtn">START</button>
          <button class="btn" id="stopBtn">Stop</button>
          <button class="btn" id="resetBtn">Reset</button>
        </div>
      </div>
    </div>

    <!-- INPUT SHOTS -->
    <div class="card pad" style="margin-top:14px;">
      <div class="sectionTitle">Inserimento tiri</div>

      <div class="col" style="gap:12px;">
        <div class="shotRow">
          <div>
            <div class="shotName">Fondo sx</div>
            <div class="shotSub">su 10</div>
          </div>
          <button class="pmBtn" data-k="fsx" data-d="-1">−</button>
          <div class="val" id="val-fsx">0</div>
          <button class="pmBtn" data-k="fsx" data-d="1">+</button>
        </div>

        <div class="shotRow">
          <div>
            <div class="shotName">45° sx</div>
            <div class="shotSub">su 10</div>
          </div>
          <button class="pmBtn" data-k="45sx" data-d="-1">−</button>
          <div class="val" id="val-45sx">0</div>
          <button class="pmBtn" data-k="45sx" data-d="1">+</button>
        </div>

        <div class="shotRow">
          <div>
            <div class="shotName">Frontale</div>
            <div class="shotSub">su 10</div>
          </div>
          <button class="pmBtn" data-k="fr" data-d="-1">−</button>
          <div class="val" id="val-fr">0</div>
          <button class="pmBtn" data-k="fr" data-d="1">+</button>
        </div>

        <div class="shotRow">
          <div>
            <div class="shotName">45° dx</div>
            <div class="shotSub">su 10</div>
          </div>
          <button class="pmBtn" data-k="45dx" data-d="-1">−</button>
          <div class="val" id="val-45dx">0</div>
          <button class="pmBtn" data-k="45dx" data-d="1">+</button>
        </div>

        <div class="shotRow">
          <div>
            <div class="shotName">Fondo dx</div>
            <div class="shotSub">su 10</div>
          </div>
          <button class="pmBtn" data-k="fdx" data-d="-1">−</button>
          <div class="val" id="val-fdx">0</div>
          <button class="pmBtn" data-k="fdx" data-d="1">+</button>
        </div>
      </div>

      <div class="actions2">
        <button class="btn" id="clearBtn">Azzera</button>
        <button class="btn btnPrimary" id="saveBtn">Salva</button>
      </div>
    </div>

    <!-- STATS -->
    <div class="card pad" style="margin-top:14px;">
      <div class="sectionTitle">Statistiche</div>
      <div class="statsBox">
        <div class="statsLogo">
          <img alt="logo" src="icon-512.png">
        </div>
        <canvas id="chart"></canvas>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="font-weight:950;" id="avgLine">Media: 0% • Sessioni: 0</div>
        <div class="spacer"></div>
        <button class="btn btnPrimary" id="shareBtn">Condividi WhatsApp</button>
      </div>
    </div>
  </div>

  <!-- MENU MODAL -->
  <div class="overlay" id="menuOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">Menu</div>
        <div class="spacer"></div>
        <button class="iconBtn" id="menuClose" aria-label="Chiudi"><span class="dots">✕</span></button>
      </div>
      <div class="modalBody">
        <button class="menuItem" id="menuNewSession">Nuova sessione (reset presenti)</button>
        <button class="menuItem" id="menuSelectPlayers">Seleziona giocatori</button>
        <button class="menuItem" id="menuPlayerSettings">Giocatore (nome + foto)</button>
        <button class="menuItem" id="menuBackup">Backup / Import</button>
      </div>
      <div class="modalFoot">
        <button class="btn" id="menuClose2">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- SELECT PLAYERS MODAL -->
  <div class="overlay" id="selectOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">Seleziona giocatori presenti</div>
        <div class="spacer"></div>
        <button class="iconBtn" id="selectClose" aria-label="Chiudi"><span class="dots">✕</span></button>
      </div>
      <div class="modalBody" id="selectList"></div>
      <div class="modalFoot">
        <button class="btn" id="selectCancel">Annulla</button>
        <button class="btn btnPrimary" id="selectOk">OK</button>
      </div>
    </div>
  </div>

  <!-- PLAYER SETTINGS MODAL -->
  <div class="overlay" id="playerOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">Giocatore</div>
        <div class="spacer"></div>
        <button class="iconBtn" id="playerClose" aria-label="Chiudi"><span class="dots">✕</span></button>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div class="col">
            <label class="muted" for="playerNameInput">Nome</label>
            <input id="playerNameInput" type="text" placeholder="Es. Marco" />
          </div>
          <div class="col">
            <label class="muted">Foto</label>
            <!-- camera directly -->
            <input id="playerPhotoInput" type="file" accept="image/*" capture="environment" />
          </div>
        </div>
        <div class="divider"></div>
        <div class="row" style="gap:12px; align-items:flex-start;">
          <div class="pmini" style="width:92px; height:92px; border-radius:22px;" id="playerPhotoPreviewWrap">
            <img id="playerPhotoPreview" alt="preview" style="width:100%; height:100%; object-fit:cover; display:none;">
          </div>
          <div class="col" style="flex:1;">
            <button class="btn btnPrimary" id="playerSave">Salva</button>
            <button class="btn" id="playerRemovePhoto">Rimuovi foto</button>
            <button class="btn" id="playerReset">Reset giocatore</button>
          </div>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="playerClose2">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- BACKUP MODAL -->
  <div class="overlay" id="backupOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle">Backup / Import</div>
        <div class="spacer"></div>
        <button class="iconBtn" id="backupClose" aria-label="Chiudi"><span class="dots">✕</span></button>
      </div>
      <div class="modalBody">
        <div class="row" style="gap:10px;">
          <input id="importJson" type="file" accept="application/json" />
        </div>
        <div class="divider"></div>
        <div class="row" style="gap:10px;">
          <button class="btn btnPrimary" id="exportJson">Esporta JSON</button>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="backupClose2">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    /* =========================
       STORAGE / STATE
    ========================= */
    const LS_KEY = "virtus_shot_tracker_v9";

    const POS = [
      { key:"fsx",  label:"Fondo sx" },
      { key:"45sx", label:"45° sx" },
      { key:"fr",   label:"Frontale" },
      { key:"45dx", label:"45° dx" },
      { key:"fdx",  label:"Fondo dx" },
    ];

    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

    function defaultState(){
      const players = Array.from({length:12}, (_,i)=>{
        const id = "G"+(i+1);
        return {
          id,
          name: "Giocatore " + (i+1),
          photo: null,          // dataURL
          sessions: []          // {date, made:{}, totalMade, totalAtt, percByPos:{}}
        };
      });
      return {
        version: 9,
        sessionDate: new Date().toISOString().slice(0,10),
        presentIds: [],          // players selected for today
        currentPlayerId: "G1",
        timerSec: 45,
        // current input per player (separate!)
        currentInputs: Object.fromEntries(players.map(p => [p.id, Object.fromEntries(POS.map(x=>[x.key,0]))])),
        players
      };
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return defaultState();
        const st = JSON.parse(raw);

        // minimal migrations / safety
        if(!st.players || !Array.isArray(st.players)) return defaultState();
        if(!st.currentInputs) st.currentInputs = {};
        for(const p of st.players){
          if(!st.currentInputs[p.id]){
            st.currentInputs[p.id] = Object.fromEntries(POS.map(x=>[x.key,0]));
          }else{
            for(const x of POS){
              if(typeof st.currentInputs[p.id][x.key] !== "number") st.currentInputs[p.id][x.key] = 0;
            }
          }
          if(!Array.isArray(p.sessions)) p.sessions = [];
          if(typeof p.name !== "string") p.name = p.id;
          if(typeof p.photo !== "string") p.photo = null;
        }
        if(!st.presentIds) st.presentIds = [];
        if(!st.sessionDate) st.sessionDate = new Date().toISOString().slice(0,10);
        if(!st.currentPlayerId) st.currentPlayerId = st.players[0].id;
        if(!st.timerSec) st.timerSec = 45;
        return st;
      }catch(e){
        return defaultState();
      }
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    let state = loadState();

    function getPlayer(id){ return state.players.find(p=>p.id===id); }

    function ensureCurrentPlayerValid(){
      const validIds = state.presentIds.length ? state.presentIds : state.players.map(p=>p.id);
      if(!validIds.includes(state.currentPlayerId)){
        state.currentPlayerId = validIds[0];
      }
    }

    /* =========================
       DOM
    ========================= */
    const sessionDateEl = document.getElementById("sessionDate");
    const timerPresetEl = document.getElementById("timerPreset");

    const playerBadge = document.getElementById("playerBadge");
    const playerNameTop = document.getElementById("playerNameTop");
    const playerPhotoMini = document.getElementById("playerPhotoMini");
    const playerPhotoMiniImg = document.getElementById("playerPhotoMiniImg");

    const presentSummary = document.getElementById("presentSummary");

    const timeDisplay = document.getElementById("timeDisplay");
    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const resetBtn = document.getElementById("resetBtn");

    const clearBtn = document.getElementById("clearBtn");
    const saveBtn  = document.getElementById("saveBtn");
    const shareBtn = document.getElementById("shareBtn");

    const avgLine  = document.getElementById("avgLine");

    const openSelectPlayers = document.getElementById("openSelectPlayers");

    /* Menu overlays */
    const menuBtn = document.getElementById("menuBtn");
    const menuOverlay = document.getElementById("menuOverlay");
    const menuClose = document.getElementById("menuClose");
    const menuClose2 = document.getElementById("menuClose2");
    const menuNewSession = document.getElementById("menuNewSession");
    const menuSelectPlayers = document.getElementById("menuSelectPlayers");
    const menuPlayerSettings = document.getElementById("menuPlayerSettings");
    const menuBackup = document.getElementById("menuBackup");

    const selectOverlay = document.getElementById("selectOverlay");
    const selectList = document.getElementById("selectList");
    const selectClose = document.getElementById("selectClose");
    const selectCancel = document.getElementById("selectCancel");
    const selectOk = document.getElementById("selectOk");

    const playerOverlay = document.getElementById("playerOverlay");
    const playerClose = document.getElementById("playerClose");
    const playerClose2 = document.getElementById("playerClose2");
    const playerNameInput = document.getElementById("playerNameInput");
    const playerPhotoInput = document.getElementById("playerPhotoInput");
    const playerPhotoPreview = document.getElementById("playerPhotoPreview");
    const playerSave = document.getElementById("playerSave");
    const playerRemovePhoto = document.getElementById("playerRemovePhoto");
    const playerReset = document.getElementById("playerReset");

    const backupOverlay = document.getElementById("backupOverlay");
    const backupClose = document.getElementById("backupClose");
    const backupClose2 = document.getElementById("backupClose2");
    const exportJsonBtn = document.getElementById("exportJson");
    const importJson = document.getElementById("importJson");

    /* =========================
       MODAL HELPERS
    ========================= */
    function openOverlay(el){
      el.classList.add("show");
      el.setAttribute("aria-hidden","false");
      // prevent background scroll
      document.body.style.overflow = "hidden";
    }
    function closeOverlay(el){
      el.classList.remove("show");
      el.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }
    function closeAllOverlays(){
      [menuOverlay, selectOverlay, playerOverlay, backupOverlay].forEach(closeOverlay);
    }
    function bindOverlayClose(overlay){
      overlay.addEventListener("click", (e)=>{
        if(e.target === overlay) closeOverlay(overlay);
      });
    }
    [menuOverlay, selectOverlay, playerOverlay, backupOverlay].forEach(bindOverlayClose);

    /* =========================
       PLAYER PRESENT SELECTION
    ========================= */
    function renderPresentSummary(){
      const ids = state.presentIds;
      if(!ids.length){
        presentSummary.textContent = "Nessuno selezionato";
        return;
      }
      const names = ids.map(id => getPlayer(id)?.name || id);
      presentSummary.textContent = names.join(", ");
    }

    function openSelectModal(){
      // build list
      selectList.innerHTML = "";
      const ids = new Set(state.presentIds);

      state.players.forEach(p=>{
        const div = document.createElement("div");
        div.className = "listItem";
        div.innerHTML = `
          <input type="checkbox" ${ids.has(p.id) ? "checked" : ""} data-id="${p.id}">
          <div class="badge" style="width:38px;height:38px;border-radius:14px;">${p.id}</div>
          <div class="liText">
            <div class="liMain">${escapeHtml(p.name)}</div>
            <div class="liSub">${p.id}</div>
          </div>
        `;
        selectList.appendChild(div);
      });

      openOverlay(selectOverlay);
    }

    function applySelectedPlayers(){
      const checks = selectList.querySelectorAll('input[type="checkbox"][data-id]');
      const selected = [];
      checks.forEach(ch=>{
        if(ch.checked) selected.push(ch.getAttribute("data-id"));
      });
      state.presentIds = selected;
      ensureCurrentPlayerValid();
      saveState();
      updateUI();
    }

    /* =========================
       PLAYER UI + SETTINGS
    ========================= */
    function updatePlayerPill(){
      ensureCurrentPlayerValid();
      const p = getPlayer(state.currentPlayerId);
      if(!p) return;

      playerBadge.textContent = p.id;
      playerNameTop.textContent = p.name;

      if(p.photo){
        playerPhotoMini.style.display = "";
        playerPhotoMiniImg.src = p.photo;
      }else{
        playerPhotoMini.style.display = "none";
        playerPhotoMiniImg.src = "";
      }
    }

    function openPlayerSettings(){
      const p = getPlayer(state.currentPlayerId);
      if(!p) return;
      playerNameInput.value = p.name || "";
      if(p.photo){
        playerPhotoPreview.style.display = "";
        playerPhotoPreview.src = p.photo;
      }else{
        playerPhotoPreview.style.display = "none";
        playerPhotoPreview.src = "";
      }
      // reset file input so camera can be used again
      playerPhotoInput.value = "";
      openOverlay(playerOverlay);
    }

    playerPhotoInput.addEventListener("change", async ()=>{
      const file = playerPhotoInput.files && playerPhotoInput.files[0];
      if(!file) return;
      const dataUrl = await fileToDataURL(file, 720); // compress
      playerPhotoPreview.style.display = "";
      playerPhotoPreview.src = dataUrl;
    });

    playerSave.addEventListener("click", ()=>{
      const p = getPlayer(state.currentPlayerId);
      if(!p) return;
      const name = (playerNameInput.value || "").trim();
      if(name) p.name = name;

      if(playerPhotoPreview.src && playerPhotoPreview.style.display !== "none"){
        p.photo = playerPhotoPreview.src;
      }
      saveState();
      updateUI();
      closeOverlay(playerOverlay);
    });

    playerRemovePhoto.addEventListener("click", ()=>{
      const p = getPlayer(state.currentPlayerId);
      if(!p) return;
      p.photo = null;
      playerPhotoPreview.style.display = "none";
      playerPhotoPreview.src = "";
      saveState();
      updateUI();
    });

    playerReset.addEventListener("click", ()=>{
      const p = getPlayer(state.currentPlayerId);
      if(!p) return;
      // reset only this player
      p.sessions = [];
      p.photo = null;
      // keep name? reset to default label
      p.name = "Giocatore " + p.id.replace("G","");
      state.currentInputs[p.id] = Object.fromEntries(POS.map(x=>[x.key,0]));
      saveState();
      updateUI();
      closeOverlay(playerOverlay);
    });

    /* =========================
       TIMER
    ========================= */
    let timer = {
      running:false,
      remaining: state.timerSec,
      t:null
    };

    function fmt(sec){
      const s = Math.max(0, sec|0);
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${mm}:${ss}`;
    }

    function setTimer(sec){
      timer.remaining = sec;
      timeDisplay.textContent = fmt(timer.remaining);
    }

    function stopTimer(){
      timer.running=false;
      if(timer.t) clearInterval(timer.t);
      timer.t=null;
    }

    function startTimer(){
      if(timer.running) return;
      timer.running=true;

      // If timer is at 0, restart from preset
      if(timer.remaining <= 0){
        timer.remaining = state.timerSec;
        timeDisplay.textContent = fmt(timer.remaining);
      }

      timer.t = setInterval(()=>{
        timer.remaining -= 1;
        timeDisplay.textContent = fmt(timer.remaining);
        if(timer.remaining <= 0){
          stopTimer();
          timeDisplay.textContent = "00:00";
          finishSignal(); // 10 beeps + vib
        }
      }, 1000);
    }

    startBtn.addEventListener("click", startTimer);
    stopBtn.addEventListener("click", stopTimer);
    resetBtn.addEventListener("click", ()=>{
      stopTimer();
      timer.remaining = state.timerSec;
      timeDisplay.textContent = fmt(timer.remaining);
    });

    timerPresetEl.addEventListener("change", ()=>{
      const v = parseInt(timerPresetEl.value,10) || 45;
      state.timerSec = v;
      saveState();
      stopTimer();
      setTimer(state.timerSec);
    });

    /* =========================
       SOUND + VIB
    ========================= */
    let audioCtx = null;

    function getAudioCtx(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioCtx;
    }

    function beepOnce(freq=880, dur=0.08, gainVal=0.55){
      // gainVal higher = louder (phone still limits)
      const ctx = getAudioCtx();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "square";
      o.frequency.value = freq;
      g.gain.value = gainVal;
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + dur);
    }

    async function finishSignal(){
      // vibration (if allowed)
      if(navigator.vibrate){
        navigator.vibrate([120,80,120,80,120,80,120,80,120]);
      }

      // 10 beeps (~5s total spacing)
      const pattern = [
        880, 880, 988, 988, 1047, 1047, 1175, 1175, 1319, 1319
      ];
      for(let i=0;i<pattern.length;i++){
        try{ beepOnce(pattern[i], 0.09, 0.70); }catch(e){}
        await sleep(450);
      }
    }

    /* =========================
       INPUT PER PLAYER (NO SLIDER)
    ========================= */
    function currentInput(){
      return state.currentInputs[state.currentPlayerId];
    }

    function updateInputUI(){
      const inp = currentInput();
      for(const x of POS){
        document.getElementById("val-"+x.key).textContent = String(inp[x.key] || 0);
      }
    }

    document.querySelectorAll(".pmBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const k = btn.getAttribute("data-k");
        const d = parseInt(btn.getAttribute("data-d"),10) || 0;
        const inp = currentInput();
        inp[k] = clamp((inp[k]||0) + d, 0, 10);
        saveState();
        updateInputUI();
      });
    });

    clearBtn.addEventListener("click", ()=>{
      state.currentInputs[state.currentPlayerId] = Object.fromEntries(POS.map(x=>[x.key,0]));
      saveState();
      updateInputUI();
    });

    saveBtn.addEventListener("click", ()=>{
      const p = getPlayer(state.currentPlayerId);
      if(!p) return;

      const inp = currentInput();
      const made = {};
      let totalMade = 0;
      let totalAtt = 0;

      POS.forEach(x=>{
        const v = clamp(inp[x.key]||0, 0, 10);
        made[x.key] = v;
        totalMade += v;
        totalAtt += 10;
      });

      const percByPos = {};
      POS.forEach(x=>{
        percByPos[x.key] = Math.round((made[x.key]/10)*100);
      });

      const entry = {
        date: state.sessionDate,
        made,
        totalMade,
        totalAtt,
        percByPos
      };

      p.sessions.push(entry);

      // after save: reset inputs for that player
      state.currentInputs[p.id] = Object.fromEntries(POS.map(x=>[x.key,0]));

      saveState();
      updateUI();
    });

    /* =========================
       STATS CHART
    ========================= */
    let chart = null;

    function computeStats(player){
      const sessions = player.sessions || [];
      if(!sessions.length){
        return { labels: POS.map(x=>x.label), values: POS.map(_=>0), avg:0, n:0 };
      }
      // average percentage per position across sessions
      const sums = Object.fromEntries(POS.map(x=>[x.key,0]));
      sessions.forEach(s=>{
        POS.forEach(x=>{
          const pv = (s.percByPos && typeof s.percByPos[x.key]==="number") ? s.percByPos[x.key] : Math.round(((s.made?.[x.key]||0)/10)*100);
          sums[x.key] += pv;
        });
      });
      const n = sessions.length;
      const values = POS.map(x=>Math.round(sums[x.key]/n));
      const avg = Math.round(values.reduce((a,b)=>a+b,0)/values.length);
      return { labels: POS.map(x=>x.label), values, avg, n };
    }

    function renderChart(){
      const p = getPlayer(state.currentPlayerId);
      const st = computeStats(p);

      avgLine.textContent = `Media: ${st.avg}% • Sessioni: ${st.n}`;

      const ctx = document.getElementById("chart").getContext("2d");
      const data = {
        labels: st.labels,
        datasets: [{
          label: "Percentuale",
          data: st.values,
          borderWidth: 3,
          pointRadius: 4,
          tension: 0.35,
        }]
      };

      const opts = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            min: 0,
            max: 100,
            ticks: { color: "rgba(255,255,255,.75)", stepSize: 20 },
            grid: { color: "rgba(255,255,255,.10)" }
          },
          x: {
            ticks: { color: "rgba(255,255,255,.75)" },
            grid: { color: "rgba(255,255,255,.08)" }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx)=> `${ctx.parsed.y}%`
            }
          }
        }
      };

      if(chart){
        chart.data = data;
        chart.options = opts;
        chart.update();
      }else{
        chart = new Chart(ctx, {
          type: "line",
          data,
          options: opts
        });
      }
    }

    /* =========================
       SHARE WHATSAPP
    ========================= */
    shareBtn.addEventListener("click", ()=>{
      const p = getPlayer(state.currentPlayerId);
      if(!p) return;

      const st = computeStats(p);
      const msg =
`Virtus Shot Tracker
Giocatore: ${p.name}
Sessioni: ${st.n}
Media: ${st.avg}%

Fondo sx: ${st.values[0]}%
45° sx: ${st.values[1]}%
Frontale: ${st.values[2]}%
45° dx: ${st.values[3]}%
Fondo dx: ${st.values[4]}%`;

      const url = "https://wa.me/?text=" + encodeURIComponent(msg);
      window.open(url, "_blank");
    });

    /* =========================
       MENU ACTIONS
    ========================= */
    function openMenu(){ openOverlay(menuOverlay); }
    function closeMenu(){ closeOverlay(menuOverlay); }

    menuBtn.addEventListener("click", openMenu);
    menuClose.addEventListener("click", closeMenu);
    menuClose2.addEventListener("click", closeMenu);

    menuNewSession.addEventListener("click", ()=>{
      state.presentIds = [];
      state.sessionDate = new Date().toISOString().slice(0,10);
      saveState();
      updateUI();
      closeMenu();
    });

    menuSelectPlayers.addEventListener("click", ()=>{
      closeMenu();
      openSelectModal();
    });

    menuPlayerSettings.addEventListener("click", ()=>{
      closeMenu();
      openPlayerSettings();
    });

    menuBackup.addEventListener("click", ()=>{
      closeMenu();
      openOverlay(backupOverlay);
    });

    openSelectPlayers.addEventListener("click", openSelectModal);

    selectClose.addEventListener("click", ()=>closeOverlay(selectOverlay));
    selectCancel.addEventListener("click", ()=>closeOverlay(selectOverlay));
    selectOk.addEventListener("click", ()=>{
      applySelectedPlayers();
      closeOverlay(selectOverlay);
    });

    playerClose.addEventListener("click", ()=>closeOverlay(playerOverlay));
    playerClose2.addEventListener("click", ()=>closeOverlay(playerOverlay));

    backupClose.addEventListener("click", ()=>closeOverlay(backupOverlay));
    backupClose2.addEventListener("click", ()=>closeOverlay(backupOverlay));

    /* =========================
       BACKUP / IMPORT
    ========================= */
    exportJsonBtn.addEventListener("click", ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `virtus-shot-tracker-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    });

    importJson.addEventListener("change", async ()=>{
      const file = importJson.files && importJson.files[0];
      if(!file) return;
      try{
        const txt = await file.text();
        const obj = JSON.parse(txt);
        if(!obj || !obj.players) throw new Error("JSON non valido");
        localStorage.setItem(LS_KEY, JSON.stringify(obj));
        state = loadState();
        updateUI();
        closeOverlay(backupOverlay);
      }catch(e){
        alert("Import fallito: " + (e.message || e));
      }finally{
        importJson.value = "";
      }
    });

    /* =========================
       SESSION DATE
    ========================= */
    sessionDateEl.addEventListener("change", ()=>{
      state.sessionDate = sessionDateEl.value || new Date().toISOString().slice(0,10);
      saveState();
    });

    /* =========================
       PLAYER SWITCH (tap pill)
       - cycles through present players (or all)
    ========================= */
    document.getElementById("playerPill").addEventListener("click", ()=>{
      const ids = state.presentIds.length ? state.presentIds : state.players.map(p=>p.id);
      const i = ids.indexOf(state.currentPlayerId);
      const next = ids[(i+1) % ids.length];
      state.currentPlayerId = next;
      saveState();
      updateUI();
    });

    /* =========================
       MAIN UPDATE
    ========================= */
    function updateUI(){
      ensureCurrentPlayerValid();

      // session
      sessionDateEl.value = state.sessionDate || new Date().toISOString().slice(0,10);
      timerPresetEl.value = String(state.timerSec || 45);

      renderPresentSummary();
      updatePlayerPill();

      // timer
      stopTimer();
      timer.remaining = state.timerSec || 45;
      timeDisplay.textContent = fmt(timer.remaining);

      // inputs
      updateInputUI();

      // stats
      renderChart();
    }

    /* =========================
       UTIL
    ========================= */
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function fileToDataURL(file, maxSize=720){
      const img = await createImageBitmap(file);
      const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);

      const c = document.createElement("canvas");
      c.width = w; c.height = h;
      const g = c.getContext("2d");
      g.drawImage(img, 0, 0, w, h);
      return c.toDataURL("image/jpeg", 0.85);
    }

    // init
    ensureCurrentPlayerValid();
    updateUI();
  </script>
</body>
</html>
