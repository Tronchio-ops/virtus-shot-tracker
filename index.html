<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Virtus Shot Tracker</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#062714" />

  <!-- Chart.js (stabile) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#041b10;
      --bg2:#062714;
      --card: rgba(0,0,0,.38);
      --card2: rgba(0,0,0,.28);
      --stroke: rgba(255,255,255,.08);
      --text: #eafff3;
      --muted: rgba(234,255,243,.72);
      --accent:#0f7a3a;
      --accent2:#0aa85a;
      --danger:#8b2b2b;
      --btn:#0a5f33;
      --btn2:#0b6f3a;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 22px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background: radial-gradient(1200px 600px at 20% 0%, #0e4a29 0%, var(--bg2) 35%, var(--bg1) 100%);}

    .wrap{max-width:920px; margin:0 auto; padding:22px 14px 36px;}

    .hero{
      padding:22px 18px;
      border-radius: 28px;
      background: linear-gradient(135deg, rgba(14,74,41,.55), rgba(0,0,0,.22));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .hero::after{
      content:"";
      position:absolute; inset:-120px -120px auto auto;
      width:420px; height:420px;
      background: radial-gradient(circle at 30% 30%, rgba(10,168,90,.22), rgba(10,168,90,0) 70%);
      transform: rotate(18deg);
      pointer-events:none;
    }

    h1{margin:0; font-size:46px; letter-spacing:.2px; line-height:1.02;}
    .sub{margin-top:8px; color:var(--muted); font-size:15px;}

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:16px;
    }
    .tab{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      transition:.15s transform ease, .15s background ease;
      display:flex; align-items:center; gap:10px;
      min-width: 128px;
      justify-content:center;
    }
    .tab:hover{transform: translateY(-1px);}
    .tab.active{
      background: linear-gradient(135deg, rgba(10,168,90,.35), rgba(0,0,0,.25));
      border-color: rgba(10,168,90,.35);
    }
    .tab .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(255,255,255,.35);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .tab.active .dot{background: rgba(10,168,90,.95); box-shadow: 0 0 0 3px rgba(10,168,90,.18);}

    .grid{display:grid; grid-template-columns: 1fr; gap:14px; margin-top:14px;}
    @media(min-width:860px){
      .grid{grid-template-columns: 1.1fr .9fr;}
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
    }
    .card h2{margin:0 0 10px; font-size:28px;}
    .hint{color:var(--muted); font-size:13px; line-height:1.35;}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .row > *{flex:1;}
    .row .tight{flex:0 0 auto;}

    label{display:block; font-size:13px; color:var(--muted); margin:8px 0 6px;}
    input[type="text"], input[type="date"], select, textarea{
      width:100%;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding:12px 12px;
      border-radius: 14px;
      outline:none;
      font-size:16px;
    }
    textarea{min-height:72px; resize:vertical;}

    .btn{
      background: linear-gradient(135deg, rgba(11,111,58,.95), rgba(8,86,46,.95));
      border: 1px solid rgba(10,168,90,.25);
      color: var(--text);
      padding:12px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-size:16px;
      font-weight:700;
      transition:.15s transform ease, .15s filter ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.05);}
    .btn.secondary{
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      font-weight:700;
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(139,43,43,.92), rgba(84,18,18,.92));
      border-color: rgba(255,120,120,.20);
    }

    .photoRow{display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:10px;}
    .avatar{
      width:66px; height:66px; border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .avatar img{width:100%; height:100%; object-fit:cover;}
    .avatar span{color:rgba(255,255,255,.35); font-size:12px;}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:13px;
    }
    .pill strong{color:var(--text);}

    .scoreList{display:flex; flex-direction:column; gap:10px; margin-top:8px;}
    .scoreItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:12px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      align-items:center;
    }
    .posTitle{font-size:22px; font-weight:800; line-height:1.1;}
    .posSub{font-size:13px; color:var(--muted); margin-top:2px;}
    .counter{
      display:flex; align-items:center; gap:10px;
    }
    .cbtn{
      width:52px; height:52px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color:var(--text);
      font-size:26px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .cval{
      width:64px; height:52px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      display:flex; align-items:center; justify-content:center;
      font-size:22px; font-weight:900;
    }

    .actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:14px;}
    .actions .btn{flex:1; min-width:180px;}

    .timerBox{
      margin-top:12px;
      padding:12px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
    }
    .timerTop{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .timerBig{font-size:36px; font-weight:1000; letter-spacing:.5px;}
    .timerControls{display:flex; gap:10px; flex-wrap:wrap;}
    .miniBtn{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .miniBtn.primary{
      background: linear-gradient(135deg, rgba(10,168,90,.38), rgba(0,0,0,.18));
      border-color: rgba(10,168,90,.25);
    }

    .toggleRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size:13px;
      user-select:none;
    }
    .toggle input{transform: scale(1.25);}

    .chartWrap{
      margin-top:10px;
      padding:12px;
      border-radius: 18px;
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.08);
      position:relative;
      overflow:hidden;
      min-height: 360px;
    }
    .watermark{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:.09;
      pointer-events:none;
      transform: translateY(10px);
    }
    .watermark img{
      width:min(520px, 85%);
      height:auto;
      filter: saturate(1.05) contrast(1.05);
    }
    canvas{position:relative; z-index:2; width:100% !important; height: 320px !important;}

    .small{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35;}
    .sep{height:1px; background: rgba(255,255,255,.08); margin:14px 0;}
    .rightCard{display:flex; flex-direction:column; gap:14px;}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      padding:12px 14px;
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      font-weight:800;
      opacity:0;
      pointer-events:none;
      transition:.18s opacity ease, .18s transform ease;
      z-index:9999;
      max-width: 92vw;
      text-align:center;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1>Virtus Shot<br/>Tracker</h1>
      <div class="sub">
        Sessione = <b>10 tiri per posizione</b> ‚Ä¢ Timer gara <b>45 / 40 / 35 sec</b> ‚Ä¢ Statistiche <b>0‚Äì100%</b>
      </div>

      <div class="tabs" id="tabs"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Giocatore</h2>

        <label>Nome giocatore (tab selezionato)</label>
        <input id="playerName" type="text" placeholder="Es. Marco" />

        <div class="photoRow">
          <div class="avatar" id="avatarBox"><span>Foto</span></div>
          <div style="flex:1; min-width:240px;">
            <label style="margin-top:0;">Foto giocatore (salvata solo sul telefono)</label>
            <input id="photoInput" type="file" accept="image/*" />
          </div>
          <button class="btn secondary tight" id="removePhotoBtn" type="button">Rimuovi foto</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="saveNameBtn" type="button">Salva nome</button>
          <button class="btn danger" id="resetPlayerBtn" type="button">Reset giocatore</button>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div>
            <label>Timer gara</label>
            <select id="timerSelect">
              <option value="45">45 sec</option>
              <option value="40">40 sec</option>
              <option value="35">35 sec</option>
            </select>
          </div>
        </div>

        <div class="timerBox">
          <div class="timerTop">
            <div class="pill">Timer: <strong id="timerLabel">45 sec</strong></div>
            <div class="timerBig" id="timerBig">00:45</div>
            <div class="timerControls">
              <button class="miniBtn primary" id="startTimerBtn" type="button">Start</button>
              <button class="miniBtn" id="stopTimerBtn" type="button">Stop</button>
              <button class="miniBtn" id="resetTimerBtn" type="button">Reset</button>
            </div>
          </div>

          <div class="toggleRow">
            <label class="toggle">
              <input id="beepC" type="checkbox" checked />
              Suono (C)
            </label>
            <label class="toggle">
              <input id="beepB" type="checkbox" />
              Suono (B)
            </label>
            <label class="toggle">
              <input id="vibrateEnd" type="checkbox" checked />
              Vibrazione fine tempo
            </label>
            <label class="toggle">
              <input id="autoSendWA" type="checkbox" checked />
              WhatsApp automatico dopo ‚ÄúSalva sessione‚Äù
            </label>
          </div>

          <div class="small">
            Nota: su alcuni telefoni il suono/vibrazione pu√≤ richiedere che tu abbia premuto almeno una volta ‚ÄúStart‚Äù.
          </div>
        </div>

        <div class="sep"></div>

        <h2>Nuova sessione</h2>

        <div class="row">
          <div>
            <label>Data</label>
            <input id="sessionDate" type="date" />
          </div>
          <div>
            <label>Note (opzionale)</label>
            <input id="sessionNote" type="text" placeholder="Es. dopo allenamento / gara..." />
          </div>
        </div>

        <div class="hint" style="margin-top:8px;">
          Inserisci i canestri segnati (0‚Äì10) per ogni posizione. Nessuno slider: solo + / ‚Äì.
        </div>

        <div class="scoreList" id="scoreList"></div>

        <div class="actions">
          <button class="btn secondary" id="clearInputsBtn" type="button">Azzera inserimento</button>
          <button class="btn" id="saveSessionBtn" type="button">Salva sessione</button>
        </div>

        <div class="small">
          Dopo ‚ÄúSalva sessione‚Äù puoi condividere su WhatsApp. Il JSON serve per backup / invio al coach.
        </div>
      </div>

      <div class="rightCard">
        <div class="card">
          <h2>Backup / Coach</h2>

          <label>Import JSON (auto sul giocatore giusto)</label>
          <input id="importFile" type="file" accept="application/json" />

          <div class="actions" style="margin-top:12px;">
            <button class="btn secondary" id="exportBtn" type="button">Esporta JSON</button>
            <button class="btn" id="shareBtn" type="button">Condividi su WhatsApp</button>
          </div>

          <div class="small">
            Se importi il JSON di un giocatore, l‚Äôapp lo riconosce e lo mette nel tab corretto.
          </div>
        </div>

        <div class="card">
          <h2>Statistiche</h2>
          <div class="hint">Grafico sempre da 0% a 100%.</div>

          <div class="chartWrap">
            <div class="watermark" id="wmBox"></div>
            <canvas id="chart"></canvas>
          </div>

          <div class="small" id="statsText"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const POSITIONS = [
      { key: "fondo_sx", label: "Fondo sx" },
      { key: "angolo_sx", label: "45¬∞ sx" },
      { key: "frontale", label: "Frontale" },
      { key: "angolo_dx", label: "45¬∞ dx" },
      { key: "fondo_dx", label: "Fondo dx" },
    ];
    const SHOTS_PER_POS = 10;
    const PLAYER_COUNT = 12;

    /***********************
     * STATE
     ***********************/
    let activePlayerId = 1;
    let chartInstance = null;

    // Timer
    let timerSeconds = 45;
    let timerRemaining = 45;
    let timerRunning = false;
    let timerHandle = null;

    /***********************
     * STORAGE
     ***********************/
    function keyForPlayer(pid){ return `virtus_player_${pid}`; }

    function defaultPlayer(pid){
      return {
        id: pid,
        name: `Giocatore ${pid}`,
        photoDataUrl: null,
        sessions: [], // {date, note, made:{...}, shotsPerPos:10, ts}
        settings: {
          timerSeconds: 45,
          beepC: true,
          beepB: false,
          vibrateEnd: true,
          autoSendWA: true
        }
      };
    }

    function loadPlayer(pid){
      const raw = localStorage.getItem(keyForPlayer(pid));
      if(!raw) return defaultPlayer(pid);
      try{
        const obj = JSON.parse(raw);
        // Migrazione minima
        if(!obj || typeof obj !== 'object') return defaultPlayer(pid);
        if(!obj.id) obj.id = pid;
        if(!obj.name) obj.name = `Giocatore ${pid}`;
        if(!Array.isArray(obj.sessions)) obj.sessions = [];
        if(!obj.settings) obj.settings = defaultPlayer(pid).settings;
        if(typeof obj.photoDataUrl === "undefined") obj.photoDataUrl = null;
        return obj;
      }catch(e){
        return defaultPlayer(pid);
      }
    }

    function savePlayer(player){
      localStorage.setItem(keyForPlayer(player.id), JSON.stringify(player));
    }

    function resetPlayer(pid){
      localStorage.removeItem(keyForPlayer(pid));
    }

    /***********************
     * UI HELPERS
     ***********************/
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1400);
    }

    function pad2(n){ return String(n).padStart(2,'0'); }
    function fmtTimer(sec){
      const m = Math.floor(sec/60);
      const s = sec%60;
      return `${pad2(m)}:${pad2(s)}`;
    }

    function todayISO(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60*1000);
      return local.toISOString().slice(0,10);
    }

    /***********************
     * TABS
     ***********************/
    function renderTabs(){
      const tabs = $("tabs");
      tabs.innerHTML = "";
      for(let i=1;i<=PLAYER_COUNT;i++){
        const p = loadPlayer(i);
        const btn = document.createElement("div");
        btn.className = "tab" + (i===activePlayerId ? " active":"");
        btn.innerHTML = `<span class="dot"></span><span>${escapeHtml(p.name)}</span>`;
        btn.onclick = ()=>{ setActivePlayer(i); };
        tabs.appendChild(btn);
      }
    }

    function setActivePlayer(pid){
      activePlayerId = pid;
      renderTabs();
      renderPlayerPanel();
      updateStats();
    }

    /***********************
     * PLAYER PANEL
     ***********************/
    function renderPlayerPanel(){
      const p = loadPlayer(activePlayerId);

      $("playerName").value = p.name || `Giocatore ${activePlayerId}`;

      // Foto
      renderAvatar(p.photoDataUrl);

      // Settings -> UI
      const t = Number(p.settings?.timerSeconds || 45);
      setTimerSelect(t);

      $("beepC").checked = !!(p.settings?.beepC);
      $("beepB").checked = !!(p.settings?.beepB);
      $("vibrateEnd").checked = !!(p.settings?.vibrateEnd);
      $("autoSendWA").checked = !!(p.settings?.autoSendWA);

      // Timer init
      timerSeconds = t;
      timerRemaining = t;
      $("timerLabel").textContent = `${t} sec`;
      $("timerBig").textContent = fmtTimer(timerRemaining);

      // Session defaults
      if(!$("sessionDate").value) $("sessionDate").value = todayISO();
      $("sessionNote").value = "";

      // Inputs list
      renderScoreInputs();
      // Watermark chart (logo se disponibile)
      renderWatermark(p.photoDataUrl);
    }

    function renderAvatar(dataUrl){
      const box = $("avatarBox");
      box.innerHTML = "";
      if(dataUrl){
        const img = document.createElement("img");
        img.src = dataUrl;
        box.appendChild(img);
      }else{
        const sp = document.createElement("span");
        sp.textContent = "Foto";
        box.appendChild(sp);
      }
    }

    function renderWatermark(dataUrl){
      const wm = $("wmBox");
      wm.innerHTML = "";
      // Se hai un logo file nel repo, qui puoi usare icon-512.png come watermark base.
      // Se invece vuoi la foto giocatore dietro, usiamo dataUrl.
      const src = dataUrl || "icon-512.png";
      const img = document.createElement("img");
      img.src = src;
      img.alt = "watermark";
      wm.appendChild(img);
    }

    function setTimerSelect(val){
      const sel = $("timerSelect");
      sel.value = String(val);
      if(sel.value !== String(val)){
        sel.value = "45";
      }
    }

    /***********************
     * SCORE INPUTS (NO SLIDER)
     ***********************/
    let currentMade = {}; // temp inputs for active player session

    function renderScoreInputs(){
      currentMade = {};
      POSITIONS.forEach(p=> currentMade[p.key]=0);

      const list = $("scoreList");
      list.innerHTML = "";

      POSITIONS.forEach((pos, idx)=>{
        const item = document.createElement("div");
        item.className = "scoreItem";
        item.innerHTML = `
          <div>
            <div class="posTitle">${pos.label} <span style="font-size:14px; font-weight:800; color:rgba(234,255,243,.70);">(su ${SHOTS_PER_POS})</span></div>
            <div class="posSub">Posizione ${idx+1}/${POSITIONS.length}</div>
          </div>
          <div class="counter">
            <button class="cbtn" type="button" data-k="${pos.key}" data-d="-1">‚àí</button>
            <div class="cval" id="val_${pos.key}">0</div>
            <button class="cbtn" type="button" data-k="${pos.key}" data-d="1">+</button>
          </div>
        `;
        list.appendChild(item);
      });

      // Bind +/-
      list.querySelectorAll(".cbtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const k = btn.getAttribute("data-k");
          const d = Number(btn.getAttribute("data-d"));
          const next = clamp((currentMade[k]||0) + d, 0, SHOTS_PER_POS);
          currentMade[k] = next;
          $("val_"+k).textContent = String(next);
        }, {passive:true});
      });
    }

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    /***********************
     * SAVE SESSION
     ***********************/
    function saveSession(){
      const p = loadPlayer(activePlayerId);

      const date = $("sessionDate").value || todayISO();
      const note = ($("sessionNote").value || "").trim();

      const made = {};
      POSITIONS.forEach(pos => made[pos.key] = clamp(Number(currentMade[pos.key]||0), 0, SHOTS_PER_POS));

      const sess = {
        date,
        note,
        made,
        shotsPerPos: SHOTS_PER_POS,
        ts: Date.now()
      };

      p.sessions.push(sess);
      savePlayer(p);

      toast("Sessione salvata ‚úÖ");
      updateStats();

      // WhatsApp auto
      if($("autoSendWA").checked){
        shareWhatsApp(true);
      }
    }

    function clearInputs(){
      POSITIONS.forEach(pos=>{
        currentMade[pos.key] = 0;
        $("val_"+pos.key).textContent = "0";
      });
      $("sessionNote").value = "";
      toast("Inserimento azzerato");
    }

    /***********************
     * STATS + CHART
     ***********************/
    function calcStats(player){
      // Totali su tutte le sessioni
      const totals = {};
      POSITIONS.forEach(p=> totals[p.key] = { made:0, att:0 });

      for(const s of player.sessions){
        const spp = Number(s.shotsPerPos || SHOTS_PER_POS);
        for(const pos of POSITIONS){
          const m = Number(s.made?.[pos.key] ?? 0);
          totals[pos.key].made += clamp(m,0,spp);
          totals[pos.key].att += spp;
        }
      }

      const perc = POSITIONS.map(pos=>{
        const t = totals[pos.key];
        const v = t.att>0 ? (t.made/t.att)*100 : 0;
        return Math.round(v*10)/10;
      });

      const overallMade = POSITIONS.reduce((a,pos)=>a + totals[pos.key].made,0);
      const overallAtt  = POSITIONS.reduce((a,pos)=>a + totals[pos.key].att,0);
      const overallPerc = overallAtt>0 ? Math.round((overallMade/overallAtt)*1000)/10 : 0;

      return { perc, overallPerc, totals, overallMade, overallAtt };
    }

    function updateStats(){
      const p = loadPlayer(activePlayerId);
      renderWatermark(p.photoDataUrl);

      const { perc, overallPerc, overallMade, overallAtt } = calcStats(p);

      $("statsText").textContent =
        `Media totale: ${overallPerc}% (${overallMade} / ${overallAtt}) ‚Ä¢ Sessioni: ${p.sessions.length}`;

      // Chart render (sempre 0‚Äì100)
      const ctx = $("chart").getContext("2d");
      const labels = POSITIONS.map(x=>x.label);

      // Se Chart.js non √® caricato, non rompiamo l‚Äôapp
      if(typeof Chart === "undefined"){
        $("statsText").textContent += " ‚Ä¢ (Chart non disponibile offline)";
        return;
      }

      if(chartInstance){
        chartInstance.destroy();
        chartInstance = null;
      }

      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Percentuale",
            data: perc,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display:false },
            tooltip: {
              callbacks: {
                label: (c)=> `${c.raw}%`
              }
            }
          },
          scales: {
            y: {
              min: 0,
              max: 100,
              ticks: { callback: (v)=> v + "%" },
              grid: { color: "rgba(255,255,255,.08)" }
            },
            x: {
              grid: { display:false }
            }
          }
        }
      });
    }

    /***********************
     * EXPORT / IMPORT JSON
     ***********************/
    function exportJSON(){
      const p = loadPlayer(activePlayerId);
      const payload = {
        app: "VirtusShotTracker",
        version: 7,
        exportedAt: new Date().toISOString(),
        player: {
          id: p.id,
          name: p.name,
          // NON esportiamo foto per privacy/peso: se vuoi esportarla, dimmelo e la metto.
          sessions: p.sessions
        }
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `virtus_${safeFile(p.name)}_backup.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("JSON esportato");
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          const pl = obj?.player;
          if(!pl || !Array.isArray(pl.sessions)){
            toast("JSON non valido");
            return;
          }

          // Auto-detect giocatore:
          // se id tra 1..12 -> usalo
          // altrimenti prova a matchare per nome su tabs
          let targetId = null;
          if(Number(pl.id) >=1 && Number(pl.id) <= PLAYER_COUNT){
            targetId = Number(pl.id);
          }else if(pl.name){
            for(let i=1;i<=PLAYER_COUNT;i++){
              const p = loadPlayer(i);
              if((p.name||"").trim().toLowerCase() === String(pl.name).trim().toLowerCase()){
                targetId = i; break;
              }
            }
          }
          if(!targetId) targetId = activePlayerId;

          const target = loadPlayer(targetId);
          // Unione: aggiungiamo sessioni importate (evita duplicati per ts+date+made)
          const existingKey = new Set(target.sessions.map(s=> sessionSig(s)));
          let added = 0;
          for(const s of pl.sessions){
            const sig = sessionSig(s);
            if(!existingKey.has(sig)){
              target.sessions.push(s);
              existingKey.add(sig);
              added++;
            }
          }

          // aggiorna nome se importato e diverso
          if(pl.name && pl.name.trim()){
            target.name = pl.name.trim();
          }

          savePlayer(target);
          renderTabs();
          setActivePlayer(targetId);
          toast(`Import ok (+${added} sessioni)`);

        }catch(e){
          toast("Errore import JSON");
        }finally{
          $("importFile").value = "";
        }
      };
      reader.readAsText(file);
    }

    function sessionSig(s){
      // Firma robusta ma semplice
      const m = s?.made || {};
      return [
        s?.ts || "",
        s?.date || "",
        m.fondo_sx ?? "",
        m.angolo_sx ?? "",
        m.frontale ?? "",
        m.angolo_dx ?? "",
        m.fondo_dx ?? ""
      ].join("|");
    }

    function safeFile(name){
      return String(name || "giocatore")
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/^_+|_+$/g,"")
        .slice(0,40) || "giocatore";
    }

    /***********************
     * WHATSAPP SHARE
     ***********************/
    function buildReportText(player){
      const { perc, overallPerc } = calcStats(player);

      // ultima sessione
      const last = player.sessions[player.sessions.length-1];
      let lastLine = "";
      if(last){
        const made = last.made || {};
        lastLine =
          `\nUltima sessione (${last.date}): ` +
          `FSX ${made.fondo_sx||0}/10, 45SX ${made.angolo_sx||0}/10, FRO ${made.frontale||0}/10, 45DX ${made.angolo_dx||0}/10, FDX ${made.fondo_dx||0}/10` +
          (last.note ? `\nNote: ${last.note}` : "");
      }

      const posLine =
        `\nMedie posizioni: ` +
        `FSX ${perc[0]}% ‚Ä¢ 45SX ${perc[1]}% ‚Ä¢ FRO ${perc[2]}% ‚Ä¢ 45DX ${perc[3]}% ‚Ä¢ FDX ${perc[4]}%`;

      return (
        `üèÄ Virtus Shot Tracker\n` +
        `Giocatore: ${player.name}\n` +
        `Media totale: ${overallPerc}%\n` +
        posLine +
        lastLine
      );
    }

    function shareWhatsApp(auto=false){
      const p = loadPlayer(activePlayerId);
      const text = buildReportText(p);

      // Se c‚Äô√® Web Share API -> apri share sheet (migliore)
      if(navigator.share && !auto){
        navigator.share({ text }).catch(()=>{});
        return;
      }

      // WhatsApp deep link
      const url = "https://wa.me/?text=" + encodeURIComponent(text);
      window.open(url, "_blank");
      if(!auto) toast("Aperto WhatsApp");
    }

    /***********************
     * PHOTO HANDLING
     ***********************/
    function savePhoto(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        const p = loadPlayer(activePlayerId);
        p.photoDataUrl = reader.result;
        savePlayer(p);
        renderAvatar(p.photoDataUrl);
        renderWatermark(p.photoDataUrl);
        toast("Foto salvata");
      };
      reader.readAsDataURL(file);
    }

    function removePhoto(){
      const p = loadPlayer(activePlayerId);
      p.photoDataUrl = null;
      savePlayer(p);
      renderAvatar(null);
      renderWatermark(null);
      toast("Foto rimossa");
    }

    /***********************
     * TIMER (45/40/35 only)
     ***********************/
    function applyTimerFromUI(){
      const p = loadPlayer(activePlayerId);
      const v = Number($("timerSelect").value || 45);

      timerSeconds = v;
      timerRemaining = v;
      $("timerLabel").textContent = `${v} sec`;
      $("timerBig").textContent = fmtTimer(timerRemaining);

      p.settings.timerSeconds = v;
      p.settings.beepC = $("beepC").checked;
      p.settings.beepB = $("beepB").checked;
      p.settings.vibrateEnd = $("vibrateEnd").checked;
      p.settings.autoSendWA = $("autoSendWA").checked;
      savePlayer(p);
    }

    function timerStart(){
      if(timerRunning) return;
      timerRunning = true;

      // Aggiorna settings su start (cos√¨ restano)
      applyTimerFromUI();

      timerHandle = setInterval(()=>{
        timerRemaining = Math.max(0, timerRemaining - 1);
        $("timerBig").textContent = fmtTimer(timerRemaining);

        if(timerRemaining <= 0){
          timerStop(true);
          onTimerEnd();
        }
      }, 1000);

      toast("Timer avviato");
    }

    function timerStop(silent=false){
      timerRunning = false;
      if(timerHandle){ clearInterval(timerHandle); timerHandle = null; }
      if(!silent) toast("Timer fermato");
    }

    function timerReset(){
      timerStop(true);
      applyTimerFromUI(); // ripristina a timerSeconds
      toast("Timer resettato");
    }

    function onTimerEnd(){
      // suono + vibrazione
      const useC = $("beepC").checked;
      const useB = $("beepB").checked;
      const vib = $("vibrateEnd").checked;

      if(vib && navigator.vibrate){
        navigator.vibrate([140,60,140,60,220]);
      }

      // WebAudio beep (pi√π affidabile di audio file)
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g);
        g.connect(ctx.destination);

        // C o B (frequenze indicative)
        const freq = useB ? 494 : 523; // B4 ~494, C5 ~523
        if(!useC && !useB){
          ctx.close();
          return;
        }

        o.frequency.value = freq;
        o.type = "sine";
        g.gain.value = 0.0001;
        o.start();

        // attacco rapido
        g.gain.exponentialRampToValueAtTime(0.18, ctx.currentTime + 0.02);
        // durata
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.45);

        setTimeout(()=>{
          o.stop();
          ctx.close();
        }, 520);
      }catch(e){
        // se audio non disponibile, pazienza
      }

      toast("Tempo finito ‚è±Ô∏è");
    }

    /***********************
     * EVENTS
     ***********************/
    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function bindEvents(){
      $("saveNameBtn").addEventListener("click", ()=>{
        const p = loadPlayer(activePlayerId);
        const name = ($("playerName").value || "").trim();
        if(!name){ toast("Inserisci un nome"); return; }
        p.name = name;
        // salva settings correnti
        p.settings.beepC = $("beepC").checked;
        p.settings.beepB = $("beepB").checked;
        p.settings.vibrateEnd = $("vibrateEnd").checked;
        p.settings.autoSendWA = $("autoSendWA").checked;
        p.settings.timerSeconds = Number($("timerSelect").value || 45);

        savePlayer(p);
        renderTabs();
        toast("Nome salvato");
      }, {passive:true});

      $("resetPlayerBtn").addEventListener("click", ()=>{
        if(!confirm("Reset totale del giocatore selezionato? (sessioni e impostazioni)")) return;
        resetPlayer(activePlayerId);
        renderTabs();
        renderPlayerPanel();
        updateStats();
        toast("Giocatore resettato");
      });

      $("photoInput").addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        savePhoto(f);
        $("photoInput").value = "";
      });

      $("removePhotoBtn").addEventListener("click", ()=>{
        removePhoto();
      });

      $("timerSelect").addEventListener("change", ()=>{
        applyTimerFromUI();
      });

      $("beepC").addEventListener("change", ()=>applyTimerFromUI());
      $("beepB").addEventListener("change", ()=>applyTimerFromUI());
      $("vibrateEnd").addEventListener("change", ()=>applyTimerFromUI());
      $("autoSendWA").addEventListener("change", ()=>applyTimerFromUI());

      $("startTimerBtn").addEventListener("click", timerStart);
      $("stopTimerBtn").addEventListener("click", ()=>timerStop(false));
      $("resetTimerBtn").addEventListener("click", timerReset);

      $("clearInputsBtn").addEventListener("click", clearInputs);
      $("saveSessionBtn").addEventListener("click", saveSession);

      $("exportBtn").addEventListener("click", exportJSON);
      $("shareBtn").addEventListener("click", ()=>shareWhatsApp(false));

      $("importFile").addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        importJSON(f);
      });
    }

    /***********************
     * INIT
     ***********************/
    function init(){
      // Set default date
      $("sessionDate").value = todayISO();

      renderTabs();
      renderPlayerPanel();
      bindEvents();

      // Primo render chart
      updateStats();
    }

    // Start
    init();
  </script>
</body>
</html>
