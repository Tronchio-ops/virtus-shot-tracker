<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#062714" />
  <title>Virtus Shot Tracker</title>

  <!-- Cache-bust (cos√¨ anche la PWA aggiorna pi√π facile) -->
  <link rel="manifest" href="manifest.webmanifest?v=7">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#03150b;
      --bg1:#062714;
      --card:rgba(0,0,0,.38);
      --line:rgba(255,255,255,.14);
      --txt:#eafff1;
      --muted:rgba(234,255,241,.72);
      --accent:#1e8239;
      --danger:#8a2b2b;
      --warn:#a06d1f;
      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1100px 700px at 20% 0%, rgba(30,130,57,.25), transparent 60%),
        radial-gradient(900px 600px at 80% 10%, rgba(6,39,20,.9), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
      padding:18px 14px 40px;
    }

    .wrap{max-width:980px;margin:0 auto}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:6px 4px 14px;
    }
    h1{margin:0;font-size:28px;letter-spacing:.2px}
    .version{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border:1px solid var(--line);
      border-radius:999px;background:rgba(0,0,0,.22)
    }

    .tabs{
      display:flex;flex-wrap:wrap;gap:8px;
      margin:6px 0 14px;
    }
    .tab{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      transition:.12s transform ease, .12s background ease;
      font-weight:700;
      min-width:120px;
      text-align:center;
    }
    .tab:active{transform:scale(.98)}
    .tab.active{
      background:rgba(30,130,57,.25);
      border-color:rgba(30,130,57,.55);
      box-shadow:0 0 0 2px rgba(30,130,57,.18) inset;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      position:relative;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      overflow:hidden;
    }
    .card h2{margin:0 0 10px;font-size:20px}
    .small{font-size:13px;color:var(--muted);line-height:1.35}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1 1 auto}

    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    input[type="text"], input[type="date"], textarea, select{
      width:100%;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      color:var(--txt);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
    }
    textarea{min-height:86px;resize:vertical}

    .btn{
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      color:var(--txt);
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      user-select:none;
      transition:.12s transform ease, .12s background ease, .12s border ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      text-align:center;
    }
    .btn:active{transform:scale(.99)}
    .btn.green{
      background:rgba(30,130,57,.32);
      border-color:rgba(30,130,57,.55);
    }
    .btn.danger{
      background:rgba(138,43,43,.35);
      border-color:rgba(138,43,43,.55);
    }
    .btn.warn{
      background:rgba(160,109,31,.30);
      border-color:rgba(160,109,31,.55);
    }

    .playerTop{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    }
    .avatar{
      width:74px;height:74px;border-radius:18px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}

    .shotBlock{
      margin-top:10px;
      border-top:1px solid var(--line);
      padding-top:10px;
    }

    /* Input ‚ÄúA classica‚Äù: compatto e senza slider */
    .shotRow{
      display:grid;
      grid-template-columns: 1fr auto auto auto;
      gap:10px;
      align-items:center;
      padding:10px 0;
      border-bottom:1px dashed rgba(255,255,255,.12);
    }
    .shotRow:last-child{border-bottom:none}
    .shotLabel{
      font-weight:900;
      font-size:18px;
    }
    .shotSub{
      display:block;
      font-size:12px;
      color:var(--muted);
      font-weight:600;
      margin-top:2px;
    }

    .stepBtn{
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      font-size:22px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      display:flex;align-items:center;justify-content:center;
    }

    .numBox{
      width:64px;height:44px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.14);
      color:var(--txt);
      font-size:18px;
      font-weight:900;
      text-align:center;
      outline:none;
      -moz-appearance:textfield;
    }
    .numBox::-webkit-outer-spin-button,
    .numBox::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }

    .twoCols{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;
    }
    @media (max-width: 520px){
      .twoCols{grid-template-columns:1fr}
    }

    .hr{height:1px;background:var(--line);margin:12px 0}

    .timerBox{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:12px;border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.18);
    }
    .timerBig{font-size:28px;font-weight:1000;letter-spacing:.5px}
    .timerMini{font-size:12px;color:var(--muted);font-weight:700}

    .watermark{
      position:absolute;inset:0;
      pointer-events:none;
      opacity:.10;
      display:flex;align-items:center;justify-content:center;
      transform:translateY(20px);
    }
    .watermark img{
      width:min(520px,80%);
      filter:grayscale(100%) contrast(120%);
    }

    .list{
      margin-top:10px;
      max-height:240px;
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
    }
    .item{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      font-size:13px;
      display:flex;justify-content:space-between;gap:10px;
    }
    .item:last-child{border-bottom:none}
    .pill{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      color:var(--muted);
      white-space:nowrap;
    }

    .hint{font-size:12px;color:var(--muted);margin-top:8px}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>Virtus Shot Tracker</h1>
      <div class="small">Sessione = <b>10 tiri per posizione</b>. 8 giocatori separati. Modalit√† gara con timer.</div>
    </div>
    <div class="version" id="versionTag">VERSIONE: v7 (NO SLIDER)</div>
  </header>

  <div class="tabs" id="tabs"></div>

  <div class="grid">

    <!-- COLONNA SINISTRA: Profilo + Timer + Nuova Sessione -->
    <div class="card">
      <h2>Giocatore</h2>

      <div class="playerTop">
        <div class="avatar" id="avatarBox">
          <div class="small" style="padding:8px;text-align:center">Foto</div>
        </div>

        <div style="min-width:240px;flex:1">
          <label>Nome giocatore</label>
          <div class="row">
            <input id="playerName" type="text" placeholder="Es. Marco" />
            <button class="btn green" id="saveNameBtn">Salva nome</button>
          </div>

          <label>Scegli una foto (solo sul telefono)</label>
          <div class="row">
            <input id="photoInput" type="file" accept="image/*" />
            <button class="btn" id="removePhotoBtn">Rimuovi foto</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn warn" id="exportBtn">Esporta JSON</button>
        <label class="btn" style="flex:1;justify-content:center;cursor:pointer">
          Importa JSON
          <input id="importInput" type="file" accept="application/json" style="display:none" />
        </label>
        <button class="btn danger" id="resetPlayerBtn">Reset giocatore</button>
      </div>

      <div class="hint">
        ‚úî Export = backup o invio al coach. Import = ripristina/aggiorna i dati del tab corrente.
      </div>

      <div class="hr"></div>

      <h2>Modalit√† gara (timer)</h2>
      <div class="twoCols">
        <div>
          <label>Durata</label>
          <select id="timerPreset">
            <option value="45">45 sec</option>
            <option value="40">40 sec</option>
            <option value="35">35 sec</option>
          </select>
        </div>

        <div>
          <label>Suono</label>
          <select id="soundMode">
            <option value="C" selected>Opzione C (beep)</option>
            <option value="B">Opzione B (buzzer)</option>
          </select>
        </div>
      </div>

      <div class="twoCols">
        <div>
          <label>Vibrazione</label>
          <select id="vibrationMode">
            <option value="on" selected>ON</option>
            <option value="off">OFF</option>
          </select>
        </div>
        <div>
          <label>Note</label>
          <div class="small">Nessun autostart. Premi ‚ÄúStart‚Äù.</div>
        </div>
      </div>

      <div class="timerBox" style="margin-top:10px">
        <div>
          <div class="timerMini">Tempo rimanente</div>
          <div class="timerBig" id="timerDisplay">00:45</div>
        </div>
        <div class="row" style="margin:0;flex:0 0 auto">
          <button class="btn green" id="startTimerBtn">Start</button>
          <button class="btn" id="stopTimerBtn">Stop</button>
          <button class="btn" id="resetTimerBtn">Reset</button>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Nuova sessione</h2>
      <label>Data</label>
      <input id="sessionDate" type="date" />

      <label>Note (opzionale)</label>
      <textarea id="sessionNote" placeholder="Es. dopo allenamento / gara..."></textarea>

      <div class="shotBlock">
        <div class="small" style="margin-bottom:10px">
          Inserisci i canestri segnati (0‚Äì10) per ogni posizione. <b>Nessuno slider.</b>
        </div>

        <div id="shots"></div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="clearDraftBtn">Azzera inserimento</button>
          <button class="btn green" id="saveSessionBtn">Salva sessione</button>
        </div>

        <div class="hint">
          Dopo ‚ÄúSalva sessione‚Äù puoi condividere su WhatsApp dal tasto ‚ÄúCondividi‚Äù nella colonna destra.
        </div>
      </div>
    </div>

    <!-- COLONNA DESTRA: Statistiche + Grafico + Storico -->
    <div class="card" style="min-height:640px">
      <div class="watermark">
        <!-- Metti qui il tuo logo se vuoi watermark: rinomina un file nel repo come logo-watermark.png -->
        <img id="wmImg" src="logo-watermark.png" alt="" onerror="this.style.display='none'">
      </div>

      <h2>Statistiche</h2>
      <div class="small">Grafico sempre da <b>0% a 100%</b>.</div>

      <canvas id="chart" style="margin-top:10px;position:relative;z-index:1"></canvas>

      <div class="hr"></div>

      <div class="row">
        <div class="pill" id="bestPill">Best: -</div>
        <div class="pill" id="avgPill">Media: -</div>
        <button class="btn green" id="shareBtn">Condividi WhatsApp</button>
      </div>

      <div class="hr"></div>

      <h2>Storico sessioni</h2>
      <div class="list" id="sessionList"></div>

      <div class="hint">
        Se non vedi la versione ‚Äúv7 (NO SLIDER)‚Äù, stai aprendo una cache vecchia.
      </div>
    </div>
  </div>
</div>

<script>
  /***********************
   * CONFIG
   ***********************/
  const APP_VERSION = "v7";
  const PLAYER_COUNT = 8;
  const POSITIONS = [
    { key:"fondo_sx", label:"Fondo sx" },
    { key:"45_sx",    label:"45¬∞ sx" },
    { key:"frontale", label:"Frontale" },
    { key:"45_dx",    label:"45¬∞ dx" },
    { key:"fondo_dx", label:"Fondo dx" }
  ];
  const MAX_MADE = 10;
  const STORAGE_PREFIX = `virtusShot.${APP_VERSION}.`;

  /***********************
   * STATE
   ***********************/
  let currentPlayer = 0; // 0..7
  let chart;

  const qs = (id)=>document.getElementById(id);

  function playerKey(p){ return `${STORAGE_PREFIX}player.${p}`; }

  function defaultPlayerState(){
    return {
      name: `Giocatore ${currentPlayer+1}`,
      photo: null, // dataURL
      draft: {
        date: new Date().toISOString().slice(0,10),
        note: "",
        shots: Object.fromEntries(POSITIONS.map(p=>[p.key,0]))
      },
      sessions: [] // {id, date, note, shots, createdAt}
    };
  }

  function loadPlayer(p){
    const raw = localStorage.getItem(playerKey(p));
    if(!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }
  function savePlayer(p, data){
    localStorage.setItem(playerKey(p), JSON.stringify(data));
  }
  function ensurePlayer(p){
    let st = loadPlayer(p);
    if(!st){
      st = defaultPlayerState();
      st.name = `Giocatore ${p+1}`;
      savePlayer(p, st);
    }
    // migrazioni leggere/robustezza
    st.draft ??= { date:new Date().toISOString().slice(0,10), note:"", shots:Object.fromEntries(POSITIONS.map(x=>[x.key,0])) };
    st.draft.shots ??= Object.fromEntries(POSITIONS.map(x=>[x.key,0]));
    for(const pos of POSITIONS){
      if(typeof st.draft.shots[pos.key] !== "number") st.draft.shots[pos.key] = 0;
    }
    st.sessions ??= [];
    return st;
  }

  /***********************
   * UI: Tabs
   ***********************/
  function buildTabs(){
    const el = qs("tabs");
    el.innerHTML = "";
    for(let i=0;i<PLAYER_COUNT;i++){
      const st = ensurePlayer(i);
      const b = document.createElement("div");
      b.className = "tab" + (i===currentPlayer ? " active" : "");
      b.textContent = st.name || `Giocatore ${i+1}`;
      b.onclick = ()=>switchPlayer(i);
      el.appendChild(b);
    }
  }

  function switchPlayer(p){
    // salva eventuali campi attuali nel draft del giocatore corrente
    persistDraftFromUI();
    currentPlayer = p;
    // ricarica
    buildTabs();
    renderPlayer();
    renderSessions();
    renderChart();
  }

  /***********************
   * UI: Shots (NO SLIDER)
   ***********************/
  function buildShotInputs(){
    const wrap = qs("shots");
    wrap.innerHTML = "";
    POSITIONS.forEach((pos, idx)=>{
      const row = document.createElement("div");
      row.className = "shotRow";

      const lbl = document.createElement("div");
      lbl.className = "shotLabel";
      lbl.innerHTML = `${pos.label} <span class="shotSub">(su 10) ‚Ä¢ Posizione ${idx+1}/5</span>`;

      const minus = document.createElement("button");
      minus.className = "stepBtn";
      minus.textContent = "‚Äì";
      minus.onclick = ()=>stepValue(pos.key, -1);

      const input = document.createElement("input");
      input.className = "numBox";
      input.type = "number";
      input.min = "0";
      input.max = String(MAX_MADE);
      input.inputMode = "numeric";
      input.value = "0";
      input.id = `shot_${pos.key}`;
      // stop wheel changes (evita incrementi accidentali)
      input.addEventListener("wheel", (e)=>e.preventDefault(), {passive:false});
      input.addEventListener("input", ()=>{
        const v = clampInt(input.value, 0, MAX_MADE);
        input.value = v;
        persistDraftFromUI();
        renderChart();
      });

      const plus = document.createElement("button");
      plus.className = "stepBtn";
      plus.textContent = "+";
      plus.onclick = ()=>stepValue(pos.key, +1);

      row.appendChild(lbl);
      row.appendChild(minus);
      row.appendChild(input);
      row.appendChild(plus);

      wrap.appendChild(row);
    });
  }

  function stepValue(key, delta){
    const el = qs(`shot_${key}`);
    const v = clampInt(el.value, 0, MAX_MADE);
    const nv = clampInt(v + delta, 0, MAX_MADE);
    el.value = nv;
    persistDraftFromUI();
    renderChart();
  }

  function clampInt(v, min, max){
    const n = Number(String(v).replace(",", "."));
    if(Number.isNaN(n)) return min;
    return Math.max(min, Math.min(max, Math.round(n)));
  }

  /***********************
   * Player render
   ***********************/
  function renderPlayer(){
    const st = ensurePlayer(currentPlayer);

    qs("playerName").value = st.name || "";
    qs("sessionDate").value = st.draft?.date || new Date().toISOString().slice(0,10);
    qs("sessionNote").value = st.draft?.note || "";

    // avatar
    const box = qs("avatarBox");
    box.innerHTML = "";
    if(st.photo){
      const img = document.createElement("img");
      img.src = st.photo;
      box.appendChild(img);
    }else{
      const t = document.createElement("div");
      t.className = "small";
      t.style.padding = "8px";
      t.style.textAlign = "center";
      t.textContent = "Foto";
      box.appendChild(t);
    }

    // draft shots
    for(const pos of POSITIONS){
      const v = st.draft?.shots?.[pos.key] ?? 0;
      const el = qs(`shot_${pos.key}`);
      if(el) el.value = clampInt(v,0,MAX_MADE);
    }
  }

  function persistDraftFromUI(){
    const st = ensurePlayer(currentPlayer);
    st.name = qs("playerName").value.trim() || st.name;

    st.draft = st.draft || {};
    st.draft.date = qs("sessionDate").value || new Date().toISOString().slice(0,10);
    st.draft.note = qs("sessionNote").value || "";
    st.draft.shots = st.draft.shots || {};

    for(const pos of POSITIONS){
      const el = qs(`shot_${pos.key}`);
      st.draft.shots[pos.key] = el ? clampInt(el.value,0,MAX_MADE) : 0;
    }
    savePlayer(currentPlayer, st);
    buildTabs(); // aggiorna label tab se nome cambiato
  }

  /***********************
   * Sessions
   ***********************/
  function saveSession(){
    const st = ensurePlayer(currentPlayer);
    persistDraftFromUI();

    const shots = {...st.draft.shots};
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
    const sess = {
      id,
      date: st.draft.date,
      note: st.draft.note,
      shots,
      createdAt: new Date().toISOString()
    };
    st.sessions.unshift(sess);

    // reset draft (solo inserimento, non storico)
    st.draft.note = "";
    st.draft.shots = Object.fromEntries(POSITIONS.map(p=>[p.key,0]));

    savePlayer(currentPlayer, st);

    renderPlayer();
    renderSessions();
    renderChart();
  }

  function deleteSession(id){
    const st = ensurePlayer(currentPlayer);
    st.sessions = st.sessions.filter(s=>s.id !== id);
    savePlayer(currentPlayer, st);
    renderSessions();
    renderChart();
  }

  function renderSessions(){
    const st = ensurePlayer(currentPlayer);
    const list = qs("sessionList");
    list.innerHTML = "";

    if(st.sessions.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.textContent = "Nessuna sessione salvata.";
      list.appendChild(empty);
    }else{
      for(const s of st.sessions.slice(0,30)){
        const item = document.createElement("div");
        item.className = "item";

        const left = document.createElement("div");
        left.innerHTML = `<b>${s.date}</b> <span style="color:rgba(234,255,241,.65)">‚Ä¢</span> ${sessionPct(s).toFixed(1)}%`;

        const right = document.createElement("div");
        const del = document.createElement("button");
        del.className = "btn danger";
        del.style.padding = "6px 10px";
        del.style.borderRadius = "12px";
        del.textContent = "X";
        del.onclick = ()=>deleteSession(s.id);
        right.appendChild(del);

        item.appendChild(left);
        item.appendChild(right);
        list.appendChild(item);
      }
    }

    // pills
    const best = bestSession(st.sessions);
    qs("bestPill").textContent = best ? `Best: ${best.date} ‚Ä¢ ${sessionPct(best).toFixed(1)}%` : "Best: -";

    const avg = avgPct(st.sessions);
    qs("avgPill").textContent = st.sessions.length ? `Media: ${avg.toFixed(1)}%` : "Media: -";
  }

  function sessionPct(session){
    const totalMade = POSITIONS.reduce((sum,p)=>sum+(session.shots?.[p.key]||0),0);
    const totalAttempts = POSITIONS.length * 10;
    return (totalMade / totalAttempts) * 100;
  }
  function bestSession(sessions){
    if(!sessions || !sessions.length) return null;
    return [...sessions].sort((a,b)=>sessionPct(b)-sessionPct(a))[0];
  }
  function avgPct(sessions){
    if(!sessions || !sessions.length) return 0;
    const sum = sessions.reduce((acc,s)=>acc+sessionPct(s),0);
    return sum/sessions.length;
  }

  /***********************
   * Chart (0-100)
   ***********************/
  function renderChart(){
    const st = ensurePlayer(currentPlayer);
    const draft = st.draft?.shots || {};
    const labels = POSITIONS.map(p=>p.label);
    const dataPct = POSITIONS.map(p=> (clampInt(draft[p.key]??0,0,MAX_MADE)/10)*100 );

    const ctx = qs("chart");
    const cfg = {
      type:"bar",
      data:{
        labels,
        datasets:[{
          label:"% su 10 tiri",
          data:dataPct
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          y:{
            min:0,
            max:100,
            ticks:{ callback:(v)=>v+"%" }
          }
        },
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{
              label:(c)=> `${c.parsed.y.toFixed(0)}%`
            }
          }
        }
      }
    };

    // set fixed height
    ctx.style.height = "280px";

    if(chart){
      chart.data.labels = cfg.data.labels;
      chart.data.datasets[0].data = cfg.data.datasets[0].data;
      chart.options.scales.y.min = 0;
      chart.options.scales.y.max = 100;
      chart.update();
    }else{
      chart = new Chart(ctx, cfg);
    }
  }

  /***********************
   * Export / Import
   ***********************/
  function exportJSON(){
    const st = ensurePlayer(currentPlayer);
    const payload = {
      app: "Virtus Shot Tracker",
      version: APP_VERSION,
      playerIndex: currentPlayer,
      exportedAt: new Date().toISOString(),
      data: st
    };

    const json = JSON.stringify(payload, null, 2);
    const blob = new Blob([json], {type:"application/json"});
    const url = URL.createObjectURL(blob);

    const nameSafe = (st.name || `Giocatore_${currentPlayer+1}`).replace(/[^a-z0-9_-]+/gi,"_");
    const a = document.createElement("a");
    a.href = url;
    a.download = `virtus_shot_${nameSafe}_${APP_VERSION}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 800);

    alert("JSON esportato. Ora puoi inviarlo su WhatsApp come file (al coach) o tenerlo come backup.");
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(reader.result);
        if(!obj || !obj.data) throw new Error("Formato non valido");
        const data = obj.data;

        // Validazione minima
        data.sessions ??= [];
        data.draft ??= { date:new Date().toISOString().slice(0,10), note:"", shots:Object.fromEntries(POSITIONS.map(p=>[p.key,0])) };
        data.draft.shots ??= Object.fromEntries(POSITIONS.map(p=>[p.key,0]));

        savePlayer(currentPlayer, data);
        buildTabs();
        renderPlayer();
        renderSessions();
        renderChart();
        alert("Import completato sul giocatore selezionato.");
      }catch(e){
        alert("Import fallito: JSON non valido.");
      }
    };
    reader.readAsText(file);
  }

  /***********************
   * WhatsApp share
   ***********************/
  function shareWhatsApp(){
    const st = ensurePlayer(currentPlayer);
    const shots = st.draft?.shots || {};
    const lines = POSITIONS.map(p=>`${p.label}: ${clampInt(shots[p.key]??0,0,MAX_MADE)}/10`);
    const pct = POSITIONS.reduce((s,p)=>s+clampInt(shots[p.key]??0,0,MAX_MADE),0) / (POSITIONS.length*10) * 100;

    const msg =
`üèÄ Virtus Shot Tracker (${APP_VERSION})
üë§ ${st.name}
üìÖ ${qs("sessionDate").value || "-"}
‚è± Timer: ${qs("timerPreset").value}s
üéØ Risultati:
- ${lines.join("\n- ")}
üìä Totale: ${pct.toFixed(1)}%
üìù Note: ${qs("sessionNote").value || "-"}

(Se vuoi mandare anche lo storico: usa "Esporta JSON" e invia il file al coach.)`;

    const url = "https://wa.me/?text=" + encodeURIComponent(msg);
    window.open(url, "_blank");
  }

  /***********************
   * Reset
   ***********************/
  function resetPlayer(){
    if(!confirm("Reset del giocatore: cancella foto + storico + draft. Confermi?")) return;
    const st = defaultPlayerState();
    st.name = `Giocatore ${currentPlayer+1}`;
    savePlayer(currentPlayer, st);
    buildTabs();
    renderPlayer();
    renderSessions();
    renderChart();
  }

  function clearDraft(){
    const st = ensurePlayer(currentPlayer);
    st.draft.note = "";
    st.draft.shots = Object.fromEntries(POSITIONS.map(p=>[p.key,0]));
    savePlayer(currentPlayer, st);
    renderPlayer();
    renderChart();
  }

  /***********************
   * Timer (gara)
   ***********************/
  let timerInterval = null;
  let remaining = 45;

  function setTimerFromPreset(){
    const s = Number(qs("timerPreset").value);
    remaining = s;
    updateTimerUI();
  }

  function updateTimerUI(){
    const mm = String(Math.floor(remaining/60)).padStart(2,"0");
    const ss = String(remaining%60).padStart(2,"0");
    qs("timerDisplay").textContent = `${mm}:${ss}`;
  }

  function stopTimer(){
    if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  }

  function startTimer(){
    stopTimer();
    timerInterval = setInterval(()=>{
      remaining--;
      updateTimerUI();
      if(remaining <= 0){
        stopTimer();
        remaining = 0;
        updateTimerUI();
        endSignal();
      }
    }, 1000);
  }

  function endSignal(){
    // vibrazione
    if(qs("vibrationMode").value === "on" && "vibrate" in navigator){
      navigator.vibrate([200,120,200,120,300]);
    }
    // suono (C default, B option)
    const mode = qs("soundMode").value;
    playTone(mode);
  }

  function playTone(mode){
    try{
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioContext();

      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);

      // Opzione C: beep (3 beep)
      // Opzione B: buzzer singolo pi√π lungo
      const now = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, now);

      if(mode === "C"){
        const freqs = [880, 880, 880];
        const times = [0, 0.25, 0.5];
        times.forEach((t,i)=>{
          o.frequency.setValueAtTime(freqs[i], now + t);
          g.gain.setValueAtTime(0.0001, now + t);
          g.gain.linearRampToValueAtTime(0.18, now + t + 0.02);
          g.gain.linearRampToValueAtTime(0.0001, now + t + 0.18);
        });
        o.start(now);
        o.stop(now + 0.75);
      }else{
        o.frequency.setValueAtTime(220, now);
        g.gain.linearRampToValueAtTime(0.25, now + 0.03);
        g.gain.linearRampToValueAtTime(0.0001, now + 0.9);
        o.start(now);
        o.stop(now + 0.95);
      }

      // chiudi contesto dopo
      setTimeout(()=>ctx.close(), 1200);
    }catch(e){
      // alcuni telefoni bloccano audio senza interazione: ma qui c‚Äô√® click sul timer, quindi dovrebbe andare
      console.log("Audio blocked:", e);
    }
  }

  /***********************
   * Foto giocatore
   ***********************/
  function setPhoto(file){
    const st = ensurePlayer(currentPlayer);
    const r = new FileReader();
    r.onload = ()=>{
      st.photo = r.result;
      savePlayer(currentPlayer, st);
      renderPlayer();
    };
    r.readAsDataURL(file);
  }

  /***********************
   * Init
   ***********************/
  function init(){
    qs("versionTag").textContent = `VERSIONE: ${APP_VERSION} (NO SLIDER)`;

    buildShotInputs();
    buildTabs();

    // timer
    qs("timerPreset").addEventListener("change", ()=>{
      setTimerFromPreset();
    });
    setTimerFromPreset();

    qs("startTimerBtn").onclick = ()=>{
      // sblocca audio su alcuni android (interazione)
      startTimer();
    };
    qs("stopTimerBtn").onclick = ()=>stopTimer();
    qs("resetTimerBtn").onclick = ()=>{
      stopTimer();
      setTimerFromPreset();
    };

    // name
    qs("saveNameBtn").onclick = ()=>{
      const st = ensurePlayer(currentPlayer);
      st.name = qs("playerName").value.trim() || st.name;
      savePlayer(currentPlayer, st);
      buildTabs();
      alert("Nome salvato.");
    };

    // draft fields persist
    qs("playerName").addEventListener("input", ()=>persistDraftFromUI());
    qs("sessionDate").addEventListener("change", ()=>persistDraftFromUI());
    qs("sessionNote").addEventListener("input", ()=>persistDraftFromUI());

    // photo
    qs("photoInput").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(f) setPhoto(f);
      e.target.value = "";
    });
    qs("removePhotoBtn").onclick = ()=>{
      const st = ensurePlayer(currentPlayer);
      st.photo = null;
      savePlayer(currentPlayer, st);
      renderPlayer();
    };

    // export/import
    qs("exportBtn").onclick = exportJSON;
    qs("importInput").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(f) importJSON(f);
      e.target.value = "";
    });

    qs("resetPlayerBtn").onclick = resetPlayer;
    qs("clearDraftBtn").onclick = clearDraft;

    qs("saveSessionBtn").onclick = ()=>{
      saveSession();
      alert("Sessione salvata ‚úÖ");
    };

    qs("shareBtn").onclick = shareWhatsApp;

    // load current player
    renderPlayer();
    renderSessions();
    renderChart();
  }

  init();
</script>

</body>
</html>
