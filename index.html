<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Virtus Shot Tracker</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#061a11" />

  <style>
    :root{
      --bg0:#020905;
      --bg1:#04140d;
      --bg2:#062114;
      --green:#0aa85a;
      --green2:#0f7a3a;
      --text:#eafff3;
      --muted:rgba(234,255,243,.72);
      --stroke:rgba(255,255,255,.10);
      --card:rgba(0,0,0,.42);
      --card2:rgba(0,0,0,.28);
      --shadow:0 18px 50px rgba(0,0,0,.40);
      --radius:22px;
      --radius2:18px;
    }

    *{box-sizing:border-box;}
    html,body{
      height:100%;
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(10,168,90,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(10,168,90,.14), transparent 55%),
        linear-gradient(160deg, var(--bg2), var(--bg0));
    }

    .wrap{max-width:960px; margin:0 auto; padding:18px 14px 36px;}

    /* Header */
    .topbar{
      display:flex; align-items:center; gap:14px;
      padding:16px 16px;
      border-radius:28px;
      background:
        radial-gradient(700px 300px at 30% 0%, rgba(10,168,90,.25), transparent 60%),
        linear-gradient(135deg, rgba(0,0,0,.30), rgba(0,0,0,.08));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .topbar::after{
      content:"";
      position:absolute;
      inset:-200px -220px auto auto;
      width:520px; height:520px;
      background: radial-gradient(circle at 35% 35%, rgba(10,168,90,.20), rgba(10,168,90,0) 70%);
      transform:rotate(15deg);
      pointer-events:none;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:0;
    }
    .brandLogo{
      width:54px; height:54px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }
    .brandLogo img{width:100%; height:100%; object-fit:cover;}
    .brandLogo span{font-weight:900; color:rgba(255,255,255,.35); font-size:12px;}

    .brandText{min-width:0;}
    .brandTitle{
      margin:0;
      font-size:28px;
      font-weight:1000;
      letter-spacing:.2px;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandSub{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
      line-height:1.25;
    }

    .rightBox{
      margin-left:auto;
      display:flex; align-items:center; gap:10px;
      flex:0 0 auto;
      position:relative;
    }

    .activePlayerBadge{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      max-width: 56vw;
    }
    .apAvatar{
      width:38px; height:38px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }
    .apAvatar img{width:100%; height:100%; object-fit:cover;}
    .apAvatar span{font-weight:1000; font-size:12px; color:rgba(255,255,255,.55);}
    .apName{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .menuBtn{
      width:44px; height:44px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:22px; font-weight:1000;
      user-select:none;
    }

    .dropdown{
      position:absolute;
      right:0;
      top:52px;
      min-width: 240px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.78);
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      overflow:hidden;
      display:none;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }
    .dropdown.show{display:block;}
    .ddItem{
      padding:12px 14px;
      cursor:pointer;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; align-items:center;
      user-select:none;
    }
    .ddItem:last-child{border-bottom:none;}
    .ddItem:hover{background: rgba(10,168,90,.14);}
    .ddIcon{
      width:26px; height:26px;
      border-radius: 10px;
      background: rgba(10,168,90,.18);
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(10,168,90,.20);
      flex:0 0 auto;
      font-size:14px;
    }
    .ddText{font-weight:900;}
    .ddHint{font-weight:700; color:rgba(234,255,243,.70); font-size:12px; margin-left:auto;}

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media(min-width:900px){
      .grid{grid-template-columns: 1.18fr .82fr;}
    }

    .card{
      background: linear-gradient(180deg, rgba(0,0,0,.40), rgba(0,0,0,.26));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-80px -80px auto auto;
      width:220px; height:220px;
      background: radial-gradient(circle at 35% 35%, rgba(10,168,90,.18), rgba(10,168,90,0) 70%);
      pointer-events:none;
    }

    h2{margin:0 0 10px 0; font-size:24px; font-weight:1000;}
    .hint{color:var(--muted); font-size:13px; line-height:1.35;}
    .small{color:var(--muted); font-size:12px; line-height:1.35; margin-top:8px;}

    label{display:block; margin:8px 0 6px; font-size:13px; color:var(--muted);}
    input[type="date"], input[type="text"], select, input[type="file"]{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size:16px;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .row > *{flex:1;}
    .row .tight{flex:0 0 auto;}

    .btn{
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(10,168,90,.22);
      background: linear-gradient(135deg, rgba(10,168,90,.40), rgba(0,0,0,.18));
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      transition:.15s transform ease, .15s filter ease;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.05);}
    .btn.secondary{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-weight:900;
    }
    .btn.danger{
      border:1px solid rgba(255,120,120,.20);
      background: linear-gradient(135deg, rgba(139,43,43,.92), rgba(84,18,18,.92));
    }

    /* Tabs for selected players */
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .ptab{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      max-width: 100%;
    }
    .ptab.active{
      border-color: rgba(10,168,90,.35);
      background: linear-gradient(135deg, rgba(10,168,90,.24), rgba(0,0,0,.18));
    }
    .ptabAva{
      width:34px; height:34px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }
    .ptabAva img{width:100%; height:100%; object-fit:cover;}
    .ptabAva span{font-size:12px; font-weight:1000; color:rgba(255,255,255,.55);}
    .ptabName{
      font-weight:1000;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 220px;
    }

    /* Timer */
    .timerBox{
      padding:12px;
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(600px 180px at 20% 0%, rgba(10,168,90,.18), transparent 65%),
        rgba(0,0,0,.18);
    }
    .timerTop{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .timerBig{
      font-size:38px;
      font-weight:1100;
      letter-spacing:.5px;
    }
    .startBig{
      padding:14px 18px;
      border-radius: 18px;
      border:1px solid rgba(10,168,90,.28);
      background: linear-gradient(135deg, rgba(10,168,90,.60), rgba(0,0,0,.18));
      color: var(--text);
      font-weight:1100;
      cursor:pointer;
      min-width: 160px;
      text-align:center;
      box-shadow: 0 14px 32px rgba(0,0,0,.32);
      user-select:none;
    }
    .miniBtn{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }

    /* Inputs +/‚àí */
    .scoreList{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .scoreItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      align-items:center;
    }
    .posTitle{font-size:20px; font-weight:1100; line-height:1.1;}
    .posSub{font-size:12px; color:var(--muted); margin-top:2px;}
    .counter{display:flex; align-items:center; gap:10px;}
    .cbtn{
      width:52px; height:52px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-size:26px;
      font-weight:1100;
      cursor:pointer;
      user-select:none;
    }
    .cval{
      width:64px; height:52px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center;
      font-size:22px; font-weight:1100;
    }

    .actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:14px;}
    .actions .btn{flex:1; min-width:160px;}

    /* Stats */
    .chartWrap{
      margin-top:10px;
      padding:12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(700px 240px at 30% 0%, rgba(10,168,90,.12), transparent 65%),
        rgba(0,0,0,.12);
      position:relative;
      overflow:hidden;
    }
    .watermark{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      opacity:.09;
      pointer-events:none;
      z-index:1;
      transform: translateY(10px);
    }
    .watermark img{
      width:min(520px, 85%);
      height:auto;
      filter: saturate(1.05) contrast(1.05);
    }
    canvas{position:relative; z-index:2; width:100%; height:320px; display:block; border-radius:14px; background: rgba(255,255,255,.02);}

    /* Pages */
    .page{display:none;}
    .page.show{display:block;}

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:2000;
      backdrop-filter: blur(6px);
    }
    .modalOverlay.show{display:flex;}
    .modal{
      width:min(720px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.80);
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; gap:12px;
    }
    .modalHead h3{margin:0; font-size:18px; font-weight:1100;}
    .modalBody{padding:14px 16px;}
    .modalFoot{
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pickList{display:flex; flex-direction:column; gap:10px;}
    .pickRow{
      display:flex; align-items:center; gap:12px;
      padding:10px 10px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }
    .pickRow input{transform: scale(1.25);}
    .pickAva{
      width:44px; height:44px;
      border-radius: 999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }
    .pickAva img{width:100%; height:100%; object-fit:cover;}
    .pickAva span{font-weight:1100; font-size:12px; color:rgba(255,255,255,.55);}
    .pickName{font-weight:1100;}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      padding:12px 14px;
      background: rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      font-weight:1100;
      opacity:0;
      pointer-events:none;
      transition:.18s opacity ease, .18s transform ease;
      z-index:9999;
      max-width: 92vw;
      text-align:center;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}

    /* Ranking */
    .rankList{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .rankItem{
      display:flex; align-items:center; gap:12px;
      padding:12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }
    .rankNum{
      width:32px; height:32px;
      border-radius: 12px;
      border:1px solid rgba(10,168,90,.22);
      background: rgba(10,168,90,.14);
      display:flex; align-items:center; justify-content:center;
      font-weight:1100;
    }
    .rankName{font-weight:1100; flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .rankPct{font-weight:1100;}
    .seg{
      display:inline-flex;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .seg button{
      padding:10px 12px;
      border:none;
      background: transparent;
      color: var(--muted);
      font-weight:1100;
      cursor:pointer;
    }
    .seg button.active{
      color: var(--text);
      background: rgba(10,168,90,.18);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="brandLogo" id="brandLogo">
          <img id="brandImg" src="icon-192.png" alt="Virtus" />
        </div>
        <div class="brandText">
          <div class="brandTitle">Virtus Shot Tracker</div>
          <div class="brandSub">Sessione: 10 tiri per posizione ‚Ä¢ Timer 45/40/35 ‚Ä¢ Statistiche 0‚Äì100%</div>
        </div>
      </div>

      <div class="rightBox">
        <div class="activePlayerBadge" id="activePlayerBadge" title="Giocatore attivo">
          <div class="apAvatar" id="apAvatar"><span>VS</span></div>
          <div class="apName" id="apName">‚Äî</div>
        </div>

        <div class="menuBtn" id="menuBtn" aria-label="Menu">‚ãÆ</div>
        <div class="dropdown" id="dropdown">
          <div class="ddItem" id="ddNewSession">
            <div class="ddIcon">‚ü≥</div>
            <div class="ddText">Nuova sessione</div>
            <div class="ddHint">reset</div>
          </div>
          <div class="ddItem" id="ddPickPlayers">
            <div class="ddIcon">‚òë</div>
            <div class="ddText">Seleziona giocatori</div>
            <div class="ddHint">presenti</div>
          </div>
          <div class="ddItem" id="ddPlayerPage">
            <div class="ddIcon">üë§</div>
            <div class="ddText">Giocatore</div>
            <div class="ddHint">nome/foto</div>
          </div>
          <div class="ddItem" id="ddRanking">
            <div class="ddIcon">üèÜ</div>
            <div class="ddText">Classifica</div>
            <div class="ddHint">squadra</div>
          </div>
          <div class="ddItem" id="ddBackupPage">
            <div class="ddIcon">‚õÅ</div>
            <div class="ddText">Backup</div>
            <div class="ddHint">json</div>
          </div>
          <div class="ddItem" id="ddShareWA">
            <div class="ddIcon">üü¢</div>
            <div class="ddText">Condividi WhatsApp</div>
            <div class="ddHint">giocatore</div>
          </div>
          <div class="ddItem" id="ddGoHome">
            <div class="ddIcon">‚åÇ</div>
            <div class="ddText">Home</div>
            <div class="ddHint">dash</div>
          </div>
        </div>
      </div>
    </div>

    <!-- HOME -->
    <div class="page show" id="pageHome">
      <div class="grid">
        <div class="card">
          <h2>Sessione</h2>

          <!-- 1) DATA -->
          <label>Data sessione</label>
          <input id="sessionDate" type="date" />

          <!-- 2) TAB GIOCATORI PRESENTI -->
          <div style="margin-top:10px;">
            <div class="hint">Giocatori presenti (se vuoto: ‚ãÆ ‚Üí Seleziona giocatori)</div>
            <div class="tabs" id="playerTabs"></div>
          </div>

          <!-- 3) TIMER -->
          <div style="margin-top:14px;">
            <h2 style="margin:0 0 10px 0;">Timer</h2>

            <label>Durata (solo 45 / 40 / 35)</label>
            <select id="timerSelect">
              <option value="45">45 sec</option>
              <option value="40">40 sec</option>
              <option value="35">35 sec</option>
            </select>

            <div class="timerBox">
              <div class="timerTop">
                <div class="timerBig" id="timerBig">00:45</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <div class="startBig" id="startTimerBtn">START</div>
                  <button class="miniBtn" id="stopTimerBtn" type="button">Stop</button>
                  <button class="miniBtn" id="resetTimerBtn" type="button">Reset</button>
                </div>
              </div>
              <div class="small">Suono + vibrazione: attivi di default. Fine tempo: 5 beep (~5s).</div>
            </div>
          </div>

          <!-- 4) INSERIMENTO -->
          <div style="margin-top:14px;">
            <h2 style="margin:0 0 10px 0;">Inserimento tiri</h2>
            <div class="hint">Solo + / ‚àí. Ogni posizione √® su 10 tiri.</div>
            <div class="scoreList" id="scoreList"></div>
          </div>

          <!-- 5) SALVA -->
          <div class="actions">
            <button class="btn secondary" id="clearInputsBtn" type="button">Azzera inserimento</button>
            <button class="btn" id="saveSessionBtn" type="button">Salva sessione</button>
          </div>
        </div>

        <div class="card">
          <!-- 6) STATISTICHE -->
          <h2>Statistiche</h2>
          <div class="hint">Grafico sempre 0% ‚Üí 100% (offline, senza librerie esterne).</div>

          <div class="chartWrap">
            <div class="watermark" id="wmBox"></div>
            <canvas id="chart" width="900" height="320"></canvas>
          </div>

          <div class="small" id="statsText">‚Äî</div>

          <div class="actions" style="margin-top:14px;">
            <button class="btn secondary" id="shareBtn" type="button">Condividi su WhatsApp</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PLAYER PAGE -->
    <div class="page" id="pagePlayer">
      <div class="card">
        <h2>Giocatore</h2>
        <div class="hint">Qui gestisci nome e foto (fotocamera). In Home rimane pulito.</div>

        <div class="row" style="margin-top:12px;">
          <div class="tight" style="flex:0 0 auto;">
            <div class="apAvatar" style="width:84px;height:84px;border-radius:24px;" id="playerPageAvatar">
              <span>VS</span>
            </div>
          </div>
          <div>
            <label>Nome giocatore</label>
            <input id="playerName" type="text" placeholder="Es. Marco" />
          </div>
        </div>

        <label>Foto giocatore (apre la fotocamera)</label>
        <input id="photoInput" type="file" accept="image/*" capture="environment" />

        <div class="actions" style="margin-top:14px;">
          <button class="btn" id="savePlayerBtn" type="button">Salva nome e foto</button>
          <button class="btn secondary" id="removePhotoBtn" type="button">Rimuovi foto</button>
          <button class="btn danger" id="resetPlayerBtn" type="button">Reset giocatore</button>
        </div>

        <div class="small">Nota: la foto √® salvata solo sul telefono di chi la imposta.</div>
      </div>
    </div>

    <!-- BACKUP PAGE -->
    <div class="page" id="pageBackup">
      <div class="card">
        <h2>Backup (JSON)</h2>
        <div class="hint">Import/Export dei dati del giocatore attivo. Utile per inviare al coach o spostare dati.</div>

        <label>Import JSON</label>
        <input id="importFile" type="file" accept="application/json" />

        <div class="actions" style="margin-top:14px;">
          <button class="btn secondary" id="exportBtn" type="button">Esporta JSON</button>
          <button class="btn" id="backHomeFromBackup" type="button">Torna Home</button>
        </div>

        <div class="small">L‚Äôimport riconosce il giocatore se nel file c‚Äô√® id/nome; altrimenti usa quello attivo.</div>
      </div>
    </div>

    <!-- RANKING PAGE -->
    <div class="page" id="pageRanking">
      <div class="card">
        <h2>Classifica (presenti)</h2>
        <div class="hint">Riassunto squadra senza conflitti: legge i dati gi√† salvati, non modifica niente.</div>

        <div class="row" style="margin-top:10px;">
          <div class="tight" style="flex:0 0 auto;">
            <div class="seg" id="rankMode">
              <button type="button" data-mode="total" class="active">Totale</button>
              <button type="button" data-mode="last">Ultima</button>
            </div>
          </div>
          <div class="tight" style="flex:0 0 auto;">
            <button class="btn secondary" id="backHomeFromRanking" type="button">Torna Home</button>
          </div>
        </div>

        <div class="rankList" id="rankList"></div>
        <div class="small" id="rankHint"></div>
      </div>
    </div>

  </div>

  <!-- MODAL: PICK PLAYERS -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal">
      <div class="modalHead">
        <h3>Seleziona giocatori presenti</h3>
        <div style="margin-left:auto; color:rgba(234,255,243,.7); font-weight:900; font-size:12px;">checkbox</div>
      </div>
      <div class="modalBody">
        <div class="pickList" id="pickList"></div>
      </div>
      <div class="modalFoot">
        <button class="btn secondary" id="modalCancel" type="button">Annulla</button>
        <button class="btn" id="modalConfirm" type="button">Conferma</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const POSITIONS = [
      { key: "fondo_sx", label: "Fondo sx" },
      { key: "angolo_sx", label: "45¬∞ sx" },
      { key: "frontale", label: "Frontale" },
      { key: "angolo_dx", label: "45¬∞ dx" },
      { key: "fondo_dx", label: "Fondo dx" },
    ];
    const SHOTS_PER_POS = 10;
    const PLAYER_COUNT = 12;

    /***********************
     * GLOBAL STATE (UI)
     ***********************/
    let activePlayerId = 1;              // player currently shown/used
    let selectedPlayers = [];            // "presenti" on dashboard
    let rankMode = "total";              // total | last

    // Timer
    let timerSeconds = 45;
    let timerRemaining = 45;
    let timerRunning = false;
    let timerHandle = null;

    // Inputs (+/‚àí) for current session entry
    let currentMade = {};

    /***********************
     * STORAGE KEYS
     ***********************/
    const UI_KEY = "virtus_ui_v1";              // session date + selectedPlayers + activePlayerId + timerSeconds
    const playerKey = (pid) => `virtus_player_${pid}_v1`;

    function defaultPlayer(pid){
      return {
        id: pid,
        name: `Giocatore ${pid}`,
        photoDataUrl: null,
        sessions: [] // {date, made:{...}, shotsPerPos, ts}
      };
    }

    function loadPlayer(pid){
      const raw = localStorage.getItem(playerKey(pid));
      if(!raw) return defaultPlayer(pid);
      try{
        const p = JSON.parse(raw);
        if(!p || typeof p !== "object") return defaultPlayer(pid);
        if(!p.id) p.id = pid;
        if(!p.name) p.name = `Giocatore ${pid}`;
        if(!Array.isArray(p.sessions)) p.sessions = [];
        if(typeof p.photoDataUrl === "undefined") p.photoDataUrl = null;
        return p;
      }catch(e){
        return defaultPlayer(pid);
      }
    }

    function savePlayer(p){
      localStorage.setItem(playerKey(p.id), JSON.stringify(p));
    }

    function resetPlayer(pid){
      localStorage.removeItem(playerKey(pid));
    }

    function loadUI(){
      try{
        const raw = localStorage.getItem(UI_KEY);
        if(!raw) return null;
        const o = JSON.parse(raw);
        if(!o || typeof o !== "object") return null;
        return o;
      }catch(e){
        return null;
      }
    }

    function saveUI(){
      const o = {
        activePlayerId,
        selectedPlayers,
        timerSeconds,
        sessionDate: $("sessionDate").value || todayISO()
      };
      localStorage.setItem(UI_KEY, JSON.stringify(o));
    }

    /***********************
     * HELPERS
     ***********************/
    function $(id){ return document.getElementById(id); }

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1400);
    }

    function todayISO(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60*1000);
      return local.toISOString().slice(0,10);
    }

    function pad2(n){ return String(n).padStart(2,'0'); }
    function fmtTimer(sec){
      const m = Math.floor(sec/60);
      const s = sec%60;
      return `${pad2(m)}:${pad2(s)}`;
    }

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    function initials(name){
      const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
      if(parts.length === 0) return "VS";
      const a = parts[0][0] || "";
      const b = parts.length > 1 ? (parts[parts.length-1][0] || "") : "";
      return (a + b).toUpperCase();
    }

    /***********************
     * ROUTER (PAGES)
     ***********************/
    function showPage(pageId){
      const pages = ["pageHome","pagePlayer","pageBackup","pageRanking"];
      pages.forEach(id => $(id).classList.remove("show"));
      $(pageId).classList.add("show");
      closeDropdown();
      // keep UI saved
      saveUI();

      // refresh page-specific views
      if(pageId === "pageHome"){
        renderHomeHeader();
        renderTabs();
        renderScoreInputs();
        updateStats();
      }
      if(pageId === "pagePlayer"){
        renderPlayerPage();
      }
      if(pageId === "pageBackup"){
        // nothing special
      }
      if(pageId === "pageRanking"){
        renderRanking();
      }
    }

    /***********************
     * DROPDOWN MENU
     ***********************/
    function toggleDropdown(){
      $("dropdown").classList.toggle("show");
    }
    function closeDropdown(){
      $("dropdown").classList.remove("show");
    }

    /***********************
     * BRAND LOGO FALLBACK
     ***********************/
    function initBrandLogo(){
      const img = $("brandImg");
      img.onerror = () => {
        $("brandLogo").innerHTML = "<span>Virtus</span>";
      };
    }

    /***********************
     * HOME HEADER (ACTIVE PLAYER BADGE)
     ***********************/
    function renderHomeHeader(){
      const p = loadPlayer(activePlayerId);
      $("apName").textContent = p.name || "‚Äî";

      const ava = $("apAvatar");
      ava.innerHTML = "";
      if(p.photoDataUrl){
        const img = document.createElement("img");
        img.src = p.photoDataUrl;
        ava.appendChild(img);
      }else{
        const sp = document.createElement("span");
        sp.textContent = initials(p.name);
        ava.appendChild(sp);
      }
    }

    /***********************
     * SELECTED PLAYER TABS (ONLY PRESENTI)
     ***********************/
    function ensureActivePlayerValid(){
      if(selectedPlayers.length === 0){
        activePlayerId = 1;
        return;
      }
      if(!selectedPlayers.includes(activePlayerId)){
        activePlayerId = selectedPlayers[0];
      }
    }

    function renderTabs(){
      ensureActivePlayerValid();
      const tabs = $("playerTabs");
      tabs.innerHTML = "";

      if(selectedPlayers.length === 0){
        tabs.innerHTML = `<div class="hint">Nessun giocatore selezionato. Apri ‚ãÆ ‚Üí Seleziona giocatori.</div>`;
        renderHomeHeader();
        return;
      }

      selectedPlayers.forEach(pid=>{
        const p = loadPlayer(pid);
        const tab = document.createElement("div");
        tab.className = "ptab" + (pid === activePlayerId ? " active" : "");
        const ava = document.createElement("div");
        ava.className = "ptabAva";

        if(p.photoDataUrl){
          const img = document.createElement("img");
          img.src = p.photoDataUrl;
          ava.appendChild(img);
        }else{
          const sp = document.createElement("span");
          sp.textContent = initials(p.name);
          ava.appendChild(sp);
        }

        const nm = document.createElement("div");
        nm.className = "ptabName";
        nm.textContent = p.name;

        tab.appendChild(ava);
        tab.appendChild(nm);

        tab.onclick = ()=>{
          activePlayerId = pid;
          renderHomeHeader();
          renderTabs();
          renderScoreInputs();
          updateStats();
          saveUI();
        };

        tabs.appendChild(tab);
      });

      renderHomeHeader();
    }

    /***********************
     * INPUTS (+/‚àí)
     ***********************/
    function resetEntry(){
      currentMade = {};
      POSITIONS.forEach(p=> currentMade[p.key] = 0);
    }

    function renderScoreInputs(){
      resetEntry();
      const list = $("scoreList");
      list.innerHTML = "";

      POSITIONS.forEach((pos, idx)=>{
        const item = document.createElement("div");
        item.className = "scoreItem";
        item.innerHTML = `
          <div>
            <div class="posTitle">${pos.label} <span style="font-size:13px; font-weight:1100; color:rgba(234,255,243,.70);">(su ${SHOTS_PER_POS})</span></div>
            <div class="posSub">Posizione ${idx+1}/${POSITIONS.length}</div>
          </div>
          <div class="counter">
            <button class="cbtn" type="button" data-k="${pos.key}" data-d="-1">‚àí</button>
            <div class="cval" id="val_${pos.key}">0</div>
            <button class="cbtn" type="button" data-k="${pos.key}" data-d="1">+</button>
          </div>
        `;
        list.appendChild(item);
      });

      list.querySelectorAll(".cbtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const k = btn.getAttribute("data-k");
          const d = Number(btn.getAttribute("data-d"));
          const next = clamp((currentMade[k]||0) + d, 0, SHOTS_PER_POS);
          currentMade[k] = next;
          $("val_"+k).textContent = String(next);
        }, {passive:true});
      });
    }

    function clearInputs(){
      POSITIONS.forEach(pos=>{
        currentMade[pos.key] = 0;
        $("val_"+pos.key).textContent = "0";
      });
      toast("Inserimento azzerato");
    }

    /***********************
     * SAVE SESSION (PLAYER DATA ONLY)
     ***********************/
    function saveSession(){
      if(selectedPlayers.length === 0){
        toast("Seleziona prima i giocatori (‚ãÆ)");
        return;
      }

      const p = loadPlayer(activePlayerId);
      const date = $("sessionDate").value || todayISO();

      const made = {};
      POSITIONS.forEach(pos => made[pos.key] = clamp(Number(currentMade[pos.key]||0), 0, SHOTS_PER_POS));

      p.sessions.push({
        date,
        made,
        shotsPerPos: SHOTS_PER_POS,
        ts: Date.now()
      });

      savePlayer(p);
      toast("Sessione salvata ‚úÖ");
      updateStats();
      clearInputs();
    }

    /***********************
     * STATS CALC
     ***********************/
    function calcStats(player){
      const totals = {};
      POSITIONS.forEach(p=> totals[p.key] = { made:0, att:0 });

      for(const s of player.sessions){
        const spp = Number(s.shotsPerPos || SHOTS_PER_POS);
        for(const pos of POSITIONS){
          const m = Number(s.made?.[pos.key] ?? 0);
          totals[pos.key].made += clamp(m,0,spp);
          totals[pos.key].att += spp;
        }
      }

      const perc = POSITIONS.map(pos=>{
        const t = totals[pos.key];
        const v = t.att>0 ? (t.made/t.att)*100 : 0;
        return Math.round(v*10)/10;
      });

      const overallMade = POSITIONS.reduce((a,pos)=>a + totals[pos.key].made,0);
      const overallAtt  = POSITIONS.reduce((a,pos)=>a + totals[pos.key].att,0);
      const overallPerc = overallAtt>0 ? Math.round((overallMade/overallAtt)*1000)/10 : 0;

      return { perc, overallPerc, overallMade, overallAtt };
    }

    function lastSessionOverall(player){
      const s = player.sessions[player.sessions.length - 1];
      if(!s) return 0;
      const spp = Number(s.shotsPerPos || SHOTS_PER_POS);
      let made = 0;
      let att = 0;
      for(const pos of POSITIONS){
        made += clamp(Number(s.made?.[pos.key] ?? 0), 0, spp);
        att += spp;
      }
      return att>0 ? Math.round((made/att)*1000)/10 : 0;
    }

    /***********************
     * CUSTOM CANVAS BAR CHART (OFFLINE, STABLE)
     ***********************/
    function drawBarChart(canvas, labels, values){
      const ratio = window.devicePixelRatio || 1;

      // Resize to container width (retina)
      const cssH = 320;
      const cssW = canvas.parentElement ? canvas.parentElement.clientWidth : 900;

      if(canvas._cssW !== cssW || canvas._ratio !== ratio){
        canvas._cssW = cssW;
        canvas._ratio = ratio;
        canvas.style.width = "100%";
        canvas.style.height = cssH + "px";
        canvas.width = Math.floor(cssW * ratio);
        canvas.height = Math.floor(cssH * ratio);
      }

      const ctx = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;

      ctx.clearRect(0,0,w,h);

      // soft bg
      ctx.fillStyle = "rgba(255,255,255,0.02)";
      ctx.fillRect(0,0,w,h);

      const padL = 68*ratio, padR = 16*ratio, padT = 16*ratio, padB = 56*ratio;
      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      // grid 0..100
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 1*ratio;
      ctx.fillStyle = "rgba(234,255,243,0.72)";
      ctx.font = `${12*ratio}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;

      for(let p=0;p<=100;p+=20){
        const y = padT + plotH - (p/100)*plotH;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL+plotW, y);
        ctx.stroke();
        ctx.fillText(p+"%", 12*ratio, y + 4*ratio);
      }

      // axes
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT+plotH);
      ctx.lineTo(padL+plotW, padT+plotH);
      ctx.stroke();

      const n = values.length;
      const gap = 14*ratio;
      const barW = (plotW - gap*(n+1)) / n;

      for(let i=0;i<n;i++){
        const v = Math.max(0, Math.min(100, Number(values[i])||0));
        const barH = (v/100)*plotH;

        const x = padL + gap + i*(barW+gap);
        const y = padT + plotH - barH;

        // bar gradient
        const grad = ctx.createLinearGradient(0, y, 0, y+barH);
        grad.addColorStop(0, "rgba(10,168,90,0.95)");
        grad.addColorStop(1, "rgba(10,168,90,0.45)");
        ctx.fillStyle = grad;
        roundRect(ctx, x, y, barW, barH, 12*ratio);
        ctx.fill();

        // value label
        ctx.fillStyle = "rgba(234,255,243,0.92)";
        ctx.font = `${13*ratio}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
        const txt = (Math.round(v*10)/10).toString() + "%";
        const tw = ctx.measureText(txt).width;
        ctx.fillText(txt, x + (barW - tw)/2, y - 8*ratio);

        // x label (wrap)
        ctx.fillStyle = "rgba(234,255,243,0.72)";
        ctx.font = `${12*ratio}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
        drawWrapCenter(ctx, labels[i] || "", x + barW/2, padT+plotH + 18*ratio, barW+gap, 2, 12*ratio);
      }
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    function drawWrapCenter(ctx, text, cx, y, maxW, maxLines, fontSize){
      const words = String(text).split(" ");
      const lines = [];
      let line = "";
      for(const w of words){
        const test = line ? (line + " " + w) : w;
        if(ctx.measureText(test).width <= maxW || !line){
          line = test;
        }else{
          lines.push(line);
          line = w;
        }
      }
      if(line) lines.push(line);
      const used = lines.slice(0, maxLines);
      for(let i=0;i<used.length;i++){
        const t = used[i];
        const tw = ctx.measureText(t).width;
        ctx.fillText(t, cx - tw/2, y + i*(fontSize+4));
      }
    }

    function renderWatermark(){
      const wm = $("wmBox");
      wm.innerHTML = "";
      const p = loadPlayer(activePlayerId);
      const src = p.photoDataUrl || "icon-512.png";

      const img = document.createElement("img");
      img.src = src;
      img.alt = "watermark";
      img.onerror = () => { img.style.display = "none"; };
      wm.appendChild(img);
    }

    function updateStats(){
      if(selectedPlayers.length === 0){
        $("statsText").textContent = "Seleziona i giocatori presenti (‚ãÆ).";
        renderWatermark();
        drawBarChart($("chart"), POSITIONS.map(x=>x.label), POSITIONS.map(()=>0));
        return;
      }

      const p = loadPlayer(activePlayerId);
      renderWatermark();

      const { perc, overallPerc, overallMade, overallAtt } = calcStats(p);
      $("statsText").textContent = `Media totale: ${overallPerc}% (${overallMade}/${overallAtt}) ‚Ä¢ Sessioni: ${p.sessions.length}`;

      drawBarChart($("chart"), POSITIONS.map(x=>x.label), perc);
    }

    /***********************
     * WHATSAPP SHARE (MANUAL)
     ***********************/
    function buildReportText(player){
      const { perc, overallPerc } = calcStats(player);
      const last = player.sessions[player.sessions.length-1];

      let lastLine = "";
      if(last){
        const m = last.made || {};
        lastLine =
          `\nUltima sessione (${last.date}): FSX ${m.fondo_sx||0}/10, 45SX ${m.angolo_sx||0}/10, FRO ${m.frontale||0}/10, 45DX ${m.angolo_dx||0}/10, FDX ${m.fondo_dx||0}/10`;
      }

      const posLine =
        `\nMedie posizioni: FSX ${perc[0]}% ‚Ä¢ 45SX ${perc[1]}% ‚Ä¢ FRO ${perc[2]}% ‚Ä¢ 45DX ${perc[3]}% ‚Ä¢ FDX ${perc[4]}%`;

      return (
        `üèÄ Virtus Shot Tracker\n` +
        `Giocatore: ${player.name}\n` +
        `Media totale: ${overallPerc}%\n` +
        posLine +
        lastLine
      );
    }

    function shareWhatsApp(){
      if(selectedPlayers.length === 0){
        toast("Seleziona i giocatori (‚ãÆ)");
        return;
      }
      const p = loadPlayer(activePlayerId);
      const text = buildReportText(p);
      const url = "https://wa.me/?text=" + encodeURIComponent(text);
      window.open(url, "_blank");
    }

    /***********************
     * TIMER (45/40/35, 5 BEEPS + VIBRATION)
     ***********************/
    function setTimerUIFromSelect(){
      timerSeconds = Number($("timerSelect").value || 45);
      timerRemaining = timerSeconds;
      $("timerBig").textContent = fmtTimer(timerRemaining);
      saveUI();
    }

    function timerStart(){
      if(timerRunning) return;
      timerRunning = true;

      // ensure select applied
      setTimerUIFromSelect();

      timerHandle = setInterval(()=>{
        timerRemaining = Math.max(0, timerRemaining - 1);
        $("timerBig").textContent = fmtTimer(timerRemaining);
        if(timerRemaining <= 0){
          timerStop(true);
          onTimerEnd();
        }
      }, 1000);

      toast("Timer avviato");
    }

    function timerStop(silent=false){
      timerRunning = false;
      if(timerHandle){ clearInterval(timerHandle); timerHandle = null; }
      if(!silent) toast("Timer fermato");
    }

    function timerReset(){
      timerStop(true);
      setTimerUIFromSelect();
      toast("Timer resettato");
    }

    function beep(freq, durationMs){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g);
        g.connect(ctx.destination);

        o.frequency.value = freq;
        o.type = "sine";
        g.gain.value = 0.0001;

        o.start();
        g.gain.exponentialRampToValueAtTime(0.18, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + (durationMs/1000));

        setTimeout(()=>{
          o.stop();
          ctx.close();
        }, durationMs + 60);
      }catch(e){}
    }

    function onTimerEnd(){
      // vibration pattern ~5s (best effort)
      if(navigator.vibrate){
        navigator.vibrate([200,100,200,100,200,100,200,100,200]);
      }

      // 5 beeps in ~5 seconds (A-ish)
      const freqA = 440; // A4
      for(let i=0;i<5;i++){
        setTimeout(()=>beep(freqA, 450), i*1000);
      }

      toast("Tempo finito ‚è±Ô∏è");
    }

    /***********************
     * PICK PLAYERS MODAL (CHECKBOX)
     ***********************/
    function openPickModal(){
      const list = $("pickList");
      list.innerHTML = "";

      // show all 12 players
      for(let i=1;i<=PLAYER_COUNT;i++){
        const p = loadPlayer(i);
        const row = document.createElement("label");
        row.className = "pickRow";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = String(i);
        cb.checked = selectedPlayers.includes(i);

        const ava = document.createElement("div");
        ava.className = "pickAva";
        if(p.photoDataUrl){
          const img = document.createElement("img");
          img.src = p.photoDataUrl;
          ava.appendChild(img);
        }else{
          const sp = document.createElement("span");
          sp.textContent = initials(p.name);
          ava.appendChild(sp);
        }

        const nm = document.createElement("div");
        nm.className = "pickName";
        nm.textContent = p.name;

        row.appendChild(cb);
        row.appendChild(ava);
        row.appendChild(nm);

        list.appendChild(row);
      }

      $("modalOverlay").classList.add("show");
      closeDropdown();
    }

    function closePickModal(){
      $("modalOverlay").classList.remove("show");
    }

    function confirmPickModal(){
      const checks = Array.from($("pickList").querySelectorAll("input[type=checkbox]:checked"));
      const ids = checks.map(x=>Number(x.value)).filter(n=>n>=1 && n<=PLAYER_COUNT);

      selectedPlayers = ids;
      ensureActivePlayerValid();
      renderTabs();
      renderScoreInputs();
      updateStats();
      renderHomeHeader();
      saveUI();

      closePickModal();
      toast(selectedPlayers.length ? "Giocatori selezionati ‚úÖ" : "Nessun giocatore selezionato");
    }

    /***********************
     * NEW SESSION (RESET PRESENTI ONLY)
     ***********************/
    function newSession(){
      selectedPlayers = [];
      activePlayerId = 1;
      renderTabs();
      renderScoreInputs();
      updateStats();
      renderHomeHeader();
      saveUI();
      toast("Nuova sessione: seleziona i presenti");
      openPickModal();
    }

    /***********************
     * PLAYER PAGE (CAMERA)
     ***********************/
    function renderPlayerPage(){
      const p = loadPlayer(activePlayerId);

      $("playerName").value = p.name;

      const box = $("playerPageAvatar");
      box.innerHTML = "";
      if(p.photoDataUrl){
        const img = document.createElement("img");
        img.src = p.photoDataUrl;
        box.appendChild(img);
      }else{
        const sp = document.createElement("span");
        sp.textContent = initials(p.name);
        box.appendChild(sp);
      }
    }

    function savePlayerNameAndPhoto(){
      const p = loadPlayer(activePlayerId);
      const name = ($("playerName").value || "").trim();
      if(name) p.name = name;
      savePlayer(p);

      // update UI elements
      renderTabs();
      renderHomeHeader();
      renderPlayerPage();
      updateStats();

      toast("Giocatore salvato ‚úÖ");
    }

    function removePhoto(){
      const p = loadPlayer(activePlayerId);
      p.photoDataUrl = null;
      savePlayer(p);
      renderTabs();
      renderHomeHeader();
      renderPlayerPage();
      updateStats();
      toast("Foto rimossa");
    }

    function handlePhotoFile(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const p = loadPlayer(activePlayerId);
        p.photoDataUrl = reader.result;
        savePlayer(p);
        renderTabs();
        renderHomeHeader();
        renderPlayerPage();
        updateStats();
        toast("Foto salvata ‚úÖ");
      };
      reader.readAsDataURL(file);
    }

    function doResetPlayer(){
      if(!confirm("Reset totale giocatore? (sessioni + foto + nome)")) return;
      resetPlayer(activePlayerId);
      renderTabs();
      renderHomeHeader();
      renderPlayerPage();
      updateStats();
      toast("Giocatore resettato");
    }

    /***********************
     * BACKUP (IMPORT/EXPORT JSON)
     ***********************/
    function safeFile(name){
      return String(name || "giocatore")
        .trim().toLowerCase()
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/^_+|_+$/g,"")
        .slice(0,40) || "giocatore";
    }

    function exportJSON(){
      const p = loadPlayer(activePlayerId);
      const payload = {
        app: "VirtusShotTracker",
        version: 9,
        exportedAt: new Date().toISOString(),
        player: { id: p.id, name: p.name, sessions: p.sessions }
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `virtus_${safeFile(p.name)}_backup.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("JSON esportato");
    }

    function sessionSig(s){
      const m = s?.made || {};
      return [
        s?.ts || "",
        s?.date || "",
        m.fondo_sx ?? "",
        m.angolo_sx ?? "",
        m.frontale ?? "",
        m.angolo_dx ?? "",
        m.fondo_dx ?? ""
      ].join("|");
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          const pl = obj?.player;
          if(!pl || !Array.isArray(pl.sessions)){
            toast("JSON non valido");
            return;
          }

          // target detection
          let targetId = null;
          if(Number(pl.id) >= 1 && Number(pl.id) <= PLAYER_COUNT){
            targetId = Number(pl.id);
          }else if(pl.name){
            for(let i=1;i<=PLAYER_COUNT;i++){
              const p = loadPlayer(i);
              if((p.name||"").trim().toLowerCase() === String(pl.name).trim().toLowerCase()){
                targetId = i; break;
              }
            }
          }
          if(!targetId) targetId = activePlayerId;

          const target = loadPlayer(targetId);

          const existing = new Set(target.sessions.map(s=>sessionSig(s)));
          let added = 0;
          for(const s of pl.sessions){
            const sig = sessionSig(s);
            if(!existing.has(sig)){
              target.sessions.push(s);
              existing.add(sig);
              added++;
            }
          }
          if(pl.name && pl.name.trim()){
            target.name = pl.name.trim();
          }

          savePlayer(target);
          activePlayerId = targetId;
          ensureActivePlayerValid();
          renderTabs();
          renderHomeHeader();
          updateStats();

          toast(`Import OK (+${added})`);
        }catch(e){
          toast("Errore import JSON");
        }finally{
          $("importFile").value = "";
        }
      };
      reader.readAsText(file);
    }

    /***********************
     * RANKING (PRESENTI)
     ***********************/
    function renderRanking(){
      const list = $("rankList");
      list.innerHTML = "";

      if(selectedPlayers.length === 0){
        $("rankHint").textContent = "Seleziona prima i giocatori presenti (‚ãÆ ‚Üí Seleziona giocatori).";
        return;
      }

      // build rows
      const rows = selectedPlayers.map(pid=>{
        const p = loadPlayer(pid);
        const total = calcStats(p).overallPerc;
        const last = lastSessionOverall(p);
        const value = (rankMode === "last") ? last : total;
        return { pid, name: p.name, value };
      });

      rows.sort((a,b)=> b.value - a.value);

      rows.forEach((r, idx)=>{
        const p = loadPlayer(r.pid);

        const item = document.createElement("div");
        item.className = "rankItem";

        const num = document.createElement("div");
        num.className = "rankNum";
        num.textContent = String(idx+1);

        const ava = document.createElement("div");
        ava.className = "pickAva";
        ava.style.width = "44px";
        ava.style.height = "44px";
        if(p.photoDataUrl){
          const img = document.createElement("img");
          img.src = p.photoDataUrl;
          ava.appendChild(img);
        }else{
          const sp = document.createElement("span");
          sp.textContent = initials(p.name);
          ava.appendChild(sp);
        }

        const nm = document.createElement("div");
        nm.className = "rankName";
        nm.textContent = r.name;

        const pct = document.createElement("div");
        pct.className = "rankPct";
        pct.textContent = `${r.value}%`;

        item.appendChild(num);
        item.appendChild(ava);
        item.appendChild(nm);
        item.appendChild(pct);

        item.onclick = ()=>{
          // jump to that player on home
          activePlayerId = r.pid;
          showPage("pageHome");
        };

        list.appendChild(item);
      });

      $("rankHint").textContent = rankMode === "last"
        ? "Ordinata per % dell‚Äôultima sessione salvata."
        : "Ordinata per % media totale (tutte le sessioni).";
    }

    /***********************
     * INIT EVENTS
     ***********************/
    function bindEvents(){
      // Dropdown
      $("menuBtn").addEventListener("click", (e)=>{
        e.stopPropagation();
        toggleDropdown();
      });
      document.addEventListener("click", ()=>{
        closeDropdown();
      });

      // Menu items
      $("ddNewSession").addEventListener("click", newSession);
      $("ddPickPlayers").addEventListener("click", openPickModal);
      $("ddPlayerPage").addEventListener("click", ()=>showPage("pagePlayer"));
      $("ddBackupPage").addEventListener("click", ()=>showPage("pageBackup"));
      $("ddRanking").addEventListener("click", ()=>showPage("pageRanking"));
      $("ddShareWA").addEventListener("click", shareWhatsApp);
      $("ddGoHome").addEventListener("click", ()=>showPage("pageHome"));

      // Modal
      $("modalCancel").addEventListener("click", closePickModal);
      $("modalConfirm").addEventListener("click", confirmPickModal);
      $("modalOverlay").addEventListener("click", (e)=>{
        if(e.target === $("modalOverlay")) closePickModal();
      });

      // Home
      $("sessionDate").addEventListener("change", saveUI);
      $("timerSelect").addEventListener("change", ()=>{
        setTimerUIFromSelect();
        saveUI();
      });

      $("startTimerBtn").addEventListener("click", timerStart);
      $("stopTimerBtn").addEventListener("click", ()=>timerStop(false));
      $("resetTimerBtn").addEventListener("click", timerReset);

      $("clearInputsBtn").addEventListener("click", clearInputs);
      $("saveSessionBtn").addEventListener("click", saveSession);
      $("shareBtn").addEventListener("click", shareWhatsApp);

      // Player page
      $("savePlayerBtn").addEventListener("click", savePlayerNameAndPhoto);
      $("removePhotoBtn").addEventListener("click", removePhoto);
      $("resetPlayerBtn").addEventListener("click", doResetPlayer);
      $("photoInput").addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        handlePhotoFile(f);
        $("photoInput").value = "";
      });

      // Backup
      $("exportBtn").addEventListener("click", exportJSON);
      $("importFile").addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        importJSON(f);
      });
      $("backHomeFromBackup").addEventListener("click", ()=>showPage("pageHome"));

      // Ranking
      $("backHomeFromRanking").addEventListener("click", ()=>showPage("pageHome"));
      $("rankMode").querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          $("rankMode").querySelectorAll("button").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          rankMode = btn.getAttribute("data-mode");
          renderRanking();
        });
      });

      // Resize
      window.addEventListener("resize", ()=>{
        if($("pageHome").classList.contains("show")){
          updateStats();
        }
      }, {passive:true});
    }

    /***********************
     * BOOT
     ***********************/
    function boot(){
      initBrandLogo();

      // date
      $("sessionDate").value = todayISO();

      // load UI if exists
      const ui = loadUI();
      if(ui){
        if(ui.sessionDate) $("sessionDate").value = ui.sessionDate;
        if(Array.isArray(ui.selectedPlayers)) selectedPlayers = ui.selectedPlayers.filter(n=>Number.isFinite(n));
        if(Number(ui.activePlayerId)) activePlayerId = Number(ui.activePlayerId);
        if(Number(ui.timerSeconds)) timerSeconds = Number(ui.timerSeconds);
      }

      // normalize timer select
      if(![35,40,45].includes(timerSeconds)) timerSeconds = 45;
      $("timerSelect").value = String(timerSeconds);
      timerRemaining = timerSeconds;
      $("timerBig").textContent = fmtTimer(timerRemaining);

      // ensure active valid
      ensureActivePlayerValid();

      bindEvents();
      renderHomeHeader();
      renderTabs();
      renderScoreInputs();
      updateStats();
      saveUI();
    }

    boot();
  </script>
</body>
</html>
