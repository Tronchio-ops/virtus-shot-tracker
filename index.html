<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Virtus Shot Tracker</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#062714" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#041b0d;
      --bg2:#062714;
      --panel: rgba(0,0,0,.40);
      --panel2: rgba(0,0,0,.25);
      --text:#eaf7ee;
      --muted: rgba(234,247,238,.72);
      --accent:#20c25e;
      --accent2:#0ea54a;
      --danger:#ff4d4d;
      --warn:#ffcc00;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
      --radius2: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at 20% 10%, #0b3a1d 0%, var(--bg2) 35%, var(--bg1) 100%);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 110px;
    }

    .title{
      font-size: 38px;
      font-weight: 800;
      letter-spacing: .2px;
      margin: 10px 0 6px;
      text-shadow: 0 10px 30px rgba(0,0,0,.55);
    }
    .subtitle{
      margin:0 0 16px;
      color: var(--muted);
      font-size: 14px;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 16px;
      margin: 14px 0;
    }

    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .col{ flex:1 1 260px; min-width: 260px; }

    .section-title{
      font-size: 16px;
      font-weight: 800;
      margin: 0 0 10px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(32,194,94,.15);
      border: 1px solid rgba(32,194,94,.35);
      color: #bff2cf;
    }

    /* Player tabs */
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .tab{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 700;
      cursor:pointer;
      transition: .15s transform, .15s background, .15s border;
      user-select:none;
      touch-action: manipulation;
    }
    .tab:hover{ transform: translateY(-1px); }
    .tab.active{
      background: linear-gradient(180deg, rgba(32,194,94,.30), rgba(32,194,94,.12));
      border-color: rgba(32,194,94,.55);
    }

    .player-head{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top: 12px;
    }
    .avatar{
      width: 56px; height:56px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color: rgba(255,255,255,.85);
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .player-meta .name{
      font-size: 18px;
      font-weight: 900;
      margin:0;
    }
    .player-meta .small{
      margin:0;
      color: var(--muted);
      font-size: 13px;
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
      font-weight: 700;
    }
    input[type="text"], input[type="date"], textarea, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height: 72px; resize: vertical; }

    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(32,194,94,.35), rgba(32,194,94,.18));
      border-color: rgba(32,194,94,.55);
    }
    .btn.danger{
      background: rgba(255,77,77,.15);
      border-color: rgba(255,77,77,.45);
      color:#ffd7d7;
    }
    .btn.small{ padding: 8px 10px; border-radius: 12px; font-weight: 900; }

    .muted{ color: var(--muted); font-size: 13px; }

    /* Shot inputs (classic) */
    .shots-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 760px){
      .shots-grid{ grid-template-columns: 1fr 1fr; }
    }
    .shot-line{
      background: var(--panel2);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .shot-label{
      font-weight: 900;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .shot-label span{ font-size: 12px; color: var(--muted); font-weight: 700; }

    .stepper{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .stepper button{
      width: 40px; height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-size: 18px;
      font-weight: 900;
      cursor:pointer;
      touch-action: manipulation;
    }
    .stepper input{
      width: 70px;
      text-align:center;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-size: 16px;
      font-weight: 900;
      outline:none;
      /* important: evita cambi con rotella */
    }
    .stepper input::-webkit-outer-spin-button,
    .stepper input::-webkit-inner-spin-button{
      -webkit-appearance: none;
      margin: 0;
    }

    .pillrow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    /* Timer */
    .timerBox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .timerTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .timerBig{
      font-size: 42px;
      font-weight: 1000;
      letter-spacing: 1px;
      text-shadow: 0 10px 25px rgba(0,0,0,.55);
    }
    .timerState{ color: var(--muted); font-size: 13px; font-weight: 700; }

    .hr{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; border-radius: 999px; }

    /* Chart watermark */
    .chartWrap{
      position:relative;
      border-radius: 18px;
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.10);
      padding: 12px;
      overflow:hidden;
    }
    .watermark{
      position:absolute;
      inset:0;
      background-repeat:no-repeat;
      background-position:center;
      background-size: 70%;
      opacity:.10;
      pointer-events:none;
      filter: saturate(1.1);
    }
    canvas{ position:relative; z-index:2; }

    /* Sessions list */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px;
    }
    .itemTop{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .itemTitle{ font-weight: 900; }
    .itemSmall{ color: var(--muted); font-size: 12px; margin-top: 2px; }
    .itemGrid{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:8px;
    }
    @media (min-width: 760px){
      .itemGrid{ grid-template-columns: repeat(5, minmax(0,1fr)); }
    }
    .kpi{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 8px;
    }
    .kpi b{ display:block; font-size: 12px; }
    .kpi span{ display:block; color: var(--muted); font-size: 12px; margin-top:2px; }

    /* Footer fixed actions (mobile) */
    .footerBar{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px;
      background: rgba(0,0,0,.55);
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }
    .footerBar .inner{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
    }
    .hint{ font-size: 12px; color: var(--muted); }

    a.link{ color:#bff2cf; text-decoration:none; border-bottom:1px dashed rgba(191,242,207,.45); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">Virtus Shot Tracker</div>
    <p class="subtitle">Sessione: <b>10 tiri per posizione</b> ‚Ä¢ Dati separati per ogni giocatore ‚Ä¢ Export/Import per WhatsApp</p>

    <!-- Players -->
    <div class="card">
      <div class="section-title">Giocatori <span class="badge">8 profili</span></div>
      <div id="tabs" class="tabs"></div>

      <div class="player-head">
        <div class="avatar" id="avatarBox">VP</div>
        <div class="player-meta">
          <p class="name" id="playerNameTop">Giocatore 1</p>
          <p class="small" id="playerInfoTop">0 sessioni salvate</p>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <label>Nome giocatore</label>
          <div class="row" style="gap:10px;">
            <div class="col" style="min-width:220px;">
              <input id="nameInput" type="text" placeholder="Es. Marco" />
            </div>
            <div class="col" style="min-width:220px;">
              <button class="btn primary" id="saveNameBtn">Salva nome</button>
            </div>
          </div>

          <label>Foto giocatore (opzionale)</label>
          <div class="pillrow">
            <input id="photoInput" type="file" accept="image/*" />
            <button class="btn small" id="removePhotoBtn">Rimuovi foto</button>
          </div>
          <p class="muted">La foto resta salvata solo sul tuo telefono (localStorage).</p>

          <div class="hr"></div>
          <div class="pillrow">
            <button class="btn danger" id="resetPlayerBtn">Reset dati di questo giocatore</button>
          </div>
        </div>

        <div class="col">
          <div class="section-title">Condivisione dati <span class="badge">Export / Import</span></div>

          <div class="pillrow">
            <button class="btn primary" id="exportBtn">Esporta JSON giocatore</button>
            <button class="btn" id="copyJsonBtn">Copia JSON</button>
            <button class="btn" id="waSummaryBtn">Invia riepilogo su WhatsApp</button>
          </div>

          <label>Importa (incolla qui o scegli file)</label>
          <textarea id="importArea" placeholder="Incolla qui il JSON esportato..."></textarea>
          <div class="pillrow" style="margin-top:10px;">
            <input id="importFile" type="file" accept=".json,application/json" />
            <button class="btn primary" id="importBtn">Importa automaticamente</button>
          </div>
          <p class="muted">
            Suggerimento: su WhatsApp invii il file <b>.json</b> (o incolli il JSON qui) e poi premi Importa.
          </p>
        </div>
      </div>
    </div>

    <!-- New session + timer -->
    <div class="card">
      <div class="row">
        <div class="col">
          <div class="section-title">Nuova sessione <span class="badge">10 tiri/posizione</span></div>

          <div class="row">
            <div class="col">
              <label>Data</label>
              <input id="dateInput" type="date" />
            </div>
            <div class="col">
              <label>Note (opzionale)</label>
              <input id="noteInput" type="text" placeholder="Es. dopo allenamento / pre-partita..." />
            </div>
          </div>

          <div style="margin-top:10px;" class="shots-grid" id="shotsGrid"></div>

          <div class="pillrow" style="margin-top:12px;">
            <button class="btn primary" id="saveSessionBtn">Salva sessione</button>
            <button class="btn" id="clearDraftBtn">Azzera inserimento</button>
          </div>

          <p class="muted" style="margin-top:10px;">
            Inserisci i <b>canestri segnati</b> (0‚Äì10) per ogni posizione.
          </p>
        </div>

        <div class="col">
          <div class="section-title">Modalit√† gara (timer unico) <span class="badge">45 / 40 / 35</span></div>

          <div class="timerBox">
            <div class="timerTop">
              <div>
                <div class="timerBig" id="timerDisplay">00:45</div>
                <div class="timerState" id="timerState">Seleziona durata e premi Start.</div>
              </div>

              <div style="min-width: 240px;">
                <label>Durata per lato</label>
                <select id="timerPreset">
                  <option value="45">45 secondi</option>
                  <option value="40">40 secondi</option>
                  <option value="35">35 secondi</option>
                </select>

                <label>Suono fine tempo</label>
                <select id="soundPreset">
                  <option value="C" selected>Suono C (beep)</option>
                  <option value="B">Suono B (beep alternativo)</option>
                  <option value="OFF">Nessun suono</option>
                </select>

                <div class="pillrow" style="margin-top:10px;">
                  <button class="btn primary" id="startTimerBtn">Start</button>
                  <button class="btn" id="pauseTimerBtn">Pausa</button>
                  <button class="btn danger" id="resetTimerBtn">Reset</button>
                </div>
              </div>
            </div>

            <div class="hr"></div>
            <p class="muted" style="margin:0;">
              A fine tempo: <b>beep + vibrazione</b>. (Se il telefono √® in silenzioso/vibrazione pu√≤ cambiare.)
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="card">
      <div class="section-title">Statistiche <span class="badge">grafico 0‚Äì100%</span></div>

      <div class="row">
        <div class="col">
          <div class="chartWrap">
            <div class="watermark" id="wm"></div>
            <canvas id="chart" height="220"></canvas>
          </div>
          <p class="muted" id="statsLine" style="margin-top:10px;">Nessuna sessione ancora salvata.</p>
        </div>

        <div class="col">
          <div class="section-title">Dashboard</div>
          <div class="pillrow">
            <div class="kpi" style="flex:1 1 140px;">
              <b>Miglior sessione</b>
              <span id="bestSession">‚Äî</span>
            </div>
            <div class="kpi" style="flex:1 1 140px;">
              <b>Totale sessioni</b>
              <span id="totalSessions">0</span>
            </div>
          </div>

          <div class="hr"></div>

          <div class="section-title">Storico (ultime 10)</div>
          <div class="list" id="sessionsList"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">Aggiornamenti app</div>
      <p class="muted" style="margin:0;">
        Per aggiornare l‚Äôapp installata: aggiorna <b>index.html</b> su GitHub ‚Üí apri il sito ‚Üí fai <b>refresh</b> (o chiudi e riapri l‚Äôapp).
        Se non cambia subito: Impostazioni Android ‚Üí App ‚Üí Chrome ‚Üí <b>Cancella cache</b> (non ‚Äúdati‚Äù) e riapri.
      </p>
    </div>

  </div>

  <div class="footerBar">
    <div class="inner">
      <div class="hint">Consiglio: fai Export JSON dopo l‚Äôallenamento e invialo al coach su WhatsApp.</div>
      <button class="btn primary" id="scrollTopBtn">‚Üë Su</button>
    </div>
  </div>

<script>
/* =========================
   STORAGE + STATE
========================= */

const STORAGE_KEY = "virtus_shot_tracker_v3";
const POS = [
  { key:"fondo_sx", label:"Fondo sx", note:"su 10" },
  { key:"angolo_sx", label:"45¬∞ sx", note:"su 10" },
  { key:"frontale", label:"Frontale", note:"su 10" },
  { key:"angolo_dx", label:"45¬∞ dx", note:"su 10" },
  { key:"fondo_dx", label:"Fondo dx", note:"su 10" },
];

function todayISO(){
  const d = new Date();
  const tz = d.getTimezoneOffset() * 60000;
  return new Date(Date.now() - tz).toISOString().slice(0,10);
}

function defaultDraft(){
  return {
    date: todayISO(),
    note: "",
    shots: {
      fondo_sx: 0,
      angolo_sx: 0,
      frontale: 0,
      angolo_dx: 0,
      fondo_dx: 0
    }
  };
}

function defaultPlayer(i){
  return {
    id: i,
    name: `Giocatore ${i+1}`,
    photoDataUrl: "",
    sessions: [],
    draft: defaultDraft()
  };
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      return { selected:0, players: Array.from({length:8}, (_,i)=>defaultPlayer(i)) };
    }
    const s = JSON.parse(raw);
    // harden
    if(!s.players || s.players.length !== 8){
      return { selected:0, players: Array.from({length:8}, (_,i)=>defaultPlayer(i)) };
    }
    // ensure drafts exist
    s.players = s.players.map((p, i) => ({
      ...defaultPlayer(i),
      ...p,
      draft: { ...defaultDraft(), ...(p.draft||{}) ,
        shots: { ...defaultDraft().shots, ...((p.draft && p.draft.shots) ? p.draft.shots : {}) }
      },
      sessions: Array.isArray(p.sessions) ? p.sessions : []
    }));
    s.selected = Math.max(0, Math.min(7, s.selected ?? 0));
    return s;
  }catch(e){
    return { selected:0, players: Array.from({length:8}, (_,i)=>defaultPlayer(i)) };
  }
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

let state = loadState();

/* =========================
   UI HELPERS
========================= */

const el = (id)=>document.getElementById(id);

function clamp(n, min, max){
  n = Number.isFinite(n) ? n : 0;
  return Math.max(min, Math.min(max, n));
}

function formatMMSS(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

function initials(name){
  const parts = (name||"").trim().split(/\s+/).filter(Boolean);
  if(!parts.length) return "VP";
  const a = parts[0][0] || "V";
  const b = (parts[1]?.[0]) || (parts[0][1] || "P");
  return (a+b).toUpperCase();
}

/* =========================
   RENDER TABS + PLAYER
========================= */

function renderTabs(){
  const tabs = el("tabs");
  tabs.innerHTML = "";
  state.players.forEach((p, i)=>{
    const b = document.createElement("button");
    b.className = "tab" + (i===state.selected ? " active" : "");
    b.textContent = p.name;
    b.addEventListener("click", ()=>{
      // salva eventuali campi gi√† scritti (sono in draft, ma assicurati)
      state.selected = i;
      saveState();
      renderAll();
    });
    tabs.appendChild(b);
  });
}

function setAvatar(p){
  const box = el("avatarBox");
  box.innerHTML = "";
  if(p.photoDataUrl){
    const img = document.createElement("img");
    img.src = p.photoDataUrl;
    box.appendChild(img);
  }else{
    box.textContent = initials(p.name);
  }

  // watermark chart
  const wm = el("wm");
  if(p.photoDataUrl){
    wm.style.backgroundImage = `url('${p.photoDataUrl}')`;
  }else{
    // usa l'icona di repo se presente
    wm.style.backgroundImage = `url('icon-512.png')`;
  }
}

function renderPlayerHeader(){
  const p = state.players[state.selected];
  el("playerNameTop").textContent = p.name;
  el("playerInfoTop").textContent = `${p.sessions.length} sessioni salvate`;
  setAvatar(p);
}

function renderProfileInputs(){
  const p = state.players[state.selected];
  el("nameInput").value = p.name || "";
  // date/note/shots vengono renderizzati nella sezione draft
}

function renderShotsGrid(){
  const p = state.players[state.selected];
  const grid = el("shotsGrid");
  grid.innerHTML = "";

  POS.forEach(pos=>{
    const line = document.createElement("div");
    line.className = "shot-line";

    const left = document.createElement("div");
    left.className = "shot-label";
    left.innerHTML = `<div>${pos.label}</div><span>${pos.note}</span>`;

    const step = document.createElement("div");
    step.className = "stepper";

    const minus = document.createElement("button");
    minus.type = "button";
    minus.textContent = "‚Äì";
    minus.addEventListener("click", ()=>{
      p.draft.shots[pos.key] = clamp((p.draft.shots[pos.key]||0) - 1, 0, 10);
      saveState();
      renderAll(); // semplice e sicuro
    });

    const inp = document.createElement("input");
    inp.type = "number";
    inp.inputMode = "numeric";
    inp.min = "0";
    inp.max = "10";
    inp.step = "1";
    inp.value = clamp(Number(p.draft.shots[pos.key] ?? 0), 0, 10);

    // blocca rotellina / scroll che cambia valore
    inp.addEventListener("wheel", (e)=>{ e.preventDefault(); }, { passive:false });

    inp.addEventListener("change", ()=>{
      p.draft.shots[pos.key] = clamp(parseInt(inp.value,10), 0, 10);
      saveState();
      renderAll();
    });

    const plus = document.createElement("button");
    plus.type = "button";
    plus.textContent = "+";
    plus.addEventListener("click", ()=>{
      p.draft.shots[pos.key] = clamp((p.draft.shots[pos.key]||0) + 1, 0, 10);
      saveState();
      renderAll();
    });

    step.appendChild(minus);
    step.appendChild(inp);
    step.appendChild(plus);

    line.appendChild(left);
    line.appendChild(step);
    grid.appendChild(line);
  });
}

function renderDraft(){
  const p = state.players[state.selected];
  el("dateInput").value = p.draft.date || todayISO();
  el("noteInput").value = p.draft.note || "";
  renderShotsGrid();
}

function renderSessions(){
  const p = state.players[state.selected];
  const list = el("sessionsList");
  list.innerHTML = "";

  const recent = [...p.sessions].slice(-10).reverse();
  if(recent.length === 0){
    list.innerHTML = `<p class="muted" style="margin:0;">Nessuna sessione salvata.</p>`;
    return;
  }

  recent.forEach((s, idx)=>{
    const div = document.createElement("div");
    div.className = "item";

    const total = POS.reduce((acc, pos)=>acc + (s.shots?.[pos.key]||0), 0);
    const max = POS.length * 10;
    const pct = Math.round((total/max)*100);

    div.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemTitle">${s.date || "‚Äî"} ‚Ä¢ <b>${pct}%</b></div>
          <div class="itemSmall">${s.note ? s.note : "‚Äî"}</div>
        </div>
        <button class="btn small danger" data-del="${p.sessions.length - 1 - idx}">Elimina</button>
      </div>
      <div class="itemGrid">
        ${POS.map(pos=>{
          const v = s.shots?.[pos.key] ?? 0;
          return `<div class="kpi"><b>${pos.label}</b><span>${v}/10</span></div>`;
        }).join("")}
      </div>
    `;

    div.querySelector("[data-del]").addEventListener("click", (e)=>{
      const realIndex = parseInt(e.currentTarget.getAttribute("data-del"),10);
      if(Number.isFinite(realIndex)){
        p.sessions.splice(realIndex,1);
        saveState();
        renderAll();
      }
    });

    list.appendChild(div);
  });
}

/* =========================
   STATS + CHART
========================= */

let chart;

function calcStats(p){
  const n = p.sessions.length;
  if(n === 0) return null;

  const sums = Object.fromEntries(POS.map(pos=>[pos.key,0]));
  let totalMade = 0;
  const maxPerSession = POS.length * 10;

  let best = { pct:-1, date:"‚Äî", total:0 };

  p.sessions.forEach(s=>{
    let sessionTotal = 0;
    POS.forEach(pos=>{
      const v = clamp(parseInt(s.shots?.[pos.key] ?? 0,10), 0, 10);
      sums[pos.key] += v;
      sessionTotal += v;
    });
    totalMade += sessionTotal;

    const pct = (sessionTotal / maxPerSession) * 100;
    if(pct > best.pct){
      best = { pct, date: s.date || "‚Äî", total: sessionTotal };
    }
  });

  const avgsPct = POS.map(pos=>{
    const avgMade = sums[pos.key] / n;          // su 10
    const pct = (avgMade / 10) * 100;           // 0-100
    return { key: pos.key, label: pos.label, pct: Math.round(pct) };
  });

  const overallPct = Math.round((totalMade / (n*maxPerSession)) * 100);

  return { avgsPct, overallPct, best };
}

function renderChart(){
  const p = state.players[state.selected];
  const st = calcStats(p);

  const ctx = el("chart").getContext("2d");
  const labels = POS.map(x=>x.label);
  const data = st ? st.avgsPct.map(x=>x.pct) : [0,0,0,0,0];

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "% medio",
        data
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          min: 0,
          max: 100,
          ticks: { callback: (v)=> v + "%" }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: { label: (c)=> `${c.raw}%` }
        }
      }
    }
  });

  if(!st){
    el("statsLine").textContent = "Nessuna sessione ancora salvata.";
    el("bestSession").textContent = "‚Äî";
    el("totalSessions").textContent = "0";
    return;
  }

  el("statsLine").textContent =
    `Media totale: ${st.overallPct}% ‚Ä¢ (calcolata su ${p.sessions.length} sessioni)`;
  el("bestSession").textContent = `${Math.round(st.best.pct)}% ‚Ä¢ ${st.best.date}`;
  el("totalSessions").textContent = String(p.sessions.length);
}

/* =========================
   TIMER (GARA ONLY)
========================= */

let timerLeft = 45;
let timerRunning = false;
let timerInterval = null;

function applyPreset(){
  const preset = parseInt(el("timerPreset").value,10);
  timerLeft = Number.isFinite(preset) ? preset : 45;
  el("timerDisplay").textContent = formatMMSS(timerLeft);
  el("timerState").textContent = "Seleziona durata e premi Start.";
}

function stopTimer(){
  timerRunning = false;
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
}

function playEndSignal(){
  // vibrazione
  try{
    if(navigator.vibrate) navigator.vibrate([250,120,250,120,400]);
  }catch(e){}

  // suono
  const mode = el("soundPreset").value;
  if(mode === "OFF") return;

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.connect(g); g.connect(ctx.destination);

  // "C" = beep pi√π acuto, "B" = pi√π basso/alternato
  const seq = (mode === "B")
    ? [{f:650, t:0.12},{f:0,t:0.06},{f:520,t:0.12},{f:0,t:0.06},{f:650,t:0.18}]
    : [{f:880, t:0.12},{f:0,t:0.06},{f:880,t:0.12},{f:0,t:0.06},{f:1040,t:0.18}];

  let at = ctx.currentTime;
  g.gain.setValueAtTime(0.0001, at);
  seq.forEach(step=>{
    if(step.f === 0){
      g.gain.setValueAtTime(0.0001, at);
      at += step.t;
      return;
    }
    o.frequency.setValueAtTime(step.f, at);
    g.gain.setValueAtTime(0.18, at);
    at += step.t;
    g.gain.setValueAtTime(0.0001, at);
  });

  o.start();
  o.stop(at + 0.02);
}

function startTimer(){
  if(timerRunning) return;

  timerRunning = true;
  el("timerState").textContent = "In corso‚Ä¶";
  timerInterval = setInterval(()=>{
    timerLeft -= 1;
    el("timerDisplay").textContent = formatMMSS(timerLeft);

    if(timerLeft <= 0){
      stopTimer();
      el("timerDisplay").textContent = "00:00";
      el("timerState").textContent = "Tempo! (Reset per ripartire)";
      playEndSignal();
    }
  }, 1000);
}

/* =========================
   EXPORT / IMPORT
========================= */

function buildPlayerExport(p){
  return {
    app: "VirtusShotTracker",
    version: 3,
    exportedAt: new Date().toISOString(),
    player: {
      id: p.id,
      name: p.name,
      photoDataUrl: p.photoDataUrl || "",
      sessions: p.sessions || []
    }
  };
}

function downloadJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importPayload(payload){
  if(!payload) throw new Error("JSON vuoto");
  const pl = payload.player || payload;
  if(!pl || !Array.isArray(pl.sessions)) throw new Error("Formato non valido (manca sessions)");

  const p = state.players[state.selected];
  // import = sostituisci il profilo selezionato (pi√π semplice e pulito)
  p.name = pl.name || p.name;
  p.photoDataUrl = pl.photoDataUrl || "";
  p.sessions = pl.sessions.map(s=>({
    date: s.date || todayISO(),
    note: s.note || "",
    shots: {
      fondo_sx: clamp(parseInt(s.shots?.fondo_sx ?? 0,10),0,10),
      angolo_sx: clamp(parseInt(s.shots?.angolo_sx ?? 0,10),0,10),
      frontale: clamp(parseInt(s.shots?.frontale ?? 0,10),0,10),
      angolo_dx: clamp(parseInt(s.shots?.angolo_dx ?? 0,10),0,10),
      fondo_dx: clamp(parseInt(s.shots?.fondo_dx ?? 0,10),0,10),
    }
  }));

  // draft sicuro
  p.draft = defaultDraft();

  saveState();
  renderAll();
}

/* =========================
   EVENTS
========================= */

function hookEvents(){
  // Tabs render done in renderTabs

  el("saveNameBtn").addEventListener("click", ()=>{
    const p = state.players[state.selected];
    p.name = (el("nameInput").value || p.name).trim() || p.name;
    saveState();
    renderAll();
  });

  el("photoInput").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const p = state.players[state.selected];
    const reader = new FileReader();
    reader.onload = ()=>{
      p.photoDataUrl = String(reader.result || "");
      saveState();
      renderAll();
      el("photoInput").value = "";
    };
    reader.readAsDataURL(file);
  });

  el("removePhotoBtn").addEventListener("click", ()=>{
    const p = state.players[state.selected];
    p.photoDataUrl = "";
    saveState();
    renderAll();
  });

  el("resetPlayerBtn").addEventListener("click", ()=>{
    const ok = confirm("Resetto TUTTI i dati di questo giocatore? (non si pu√≤ annullare)");
    if(!ok) return;
    state.players[state.selected] = defaultPlayer(state.selected);
    saveState();
    renderAll();
  });

  // Draft fields
  el("dateInput").addEventListener("change", ()=>{
    const p = state.players[state.selected];
    p.draft.date = el("dateInput").value || todayISO();
    saveState();
  });
  el("noteInput").addEventListener("input", ()=>{
    const p = state.players[state.selected];
    p.draft.note = el("noteInput").value || "";
    saveState();
  });

  el("clearDraftBtn").addEventListener("click", ()=>{
    const p = state.players[state.selected];
    p.draft = defaultDraft();
    saveState();
    renderAll();
  });

  el("saveSessionBtn").addEventListener("click", ()=>{
    const p = state.players[state.selected];

    const s = {
      date: p.draft.date || todayISO(),
      note: (p.draft.note || "").trim(),
      shots: { ...p.draft.shots }
    };

    // valida 0-10
    POS.forEach(pos=>{
      s.shots[pos.key] = clamp(parseInt(s.shots[pos.key] ?? 0,10), 0, 10);
    });

    p.sessions.push(s);
    // reset draft solo per quel giocatore (IMPORTANTISSIMO)
    p.draft = defaultDraft();
    saveState();
    renderAll();
    alert("Sessione salvata ‚úÖ");
  });

  // Timer
  el("timerPreset").addEventListener("change", ()=>{
    stopTimer();
    applyPreset();
  });
  el("soundPreset").addEventListener("change", ()=>{
    // niente auto-start
  });
  el("startTimerBtn").addEventListener("click", async ()=>{
    // su android spesso serve un gesto per sbloccare l'audio
    // quindi facciamo un resume audio context "soft" quando si preme start
    try{
      if(window.AudioContext || window.webkitAudioContext){
        const c = new (window.AudioContext || window.webkitAudioContext)();
        await c.resume();
        c.close();
      }
    }catch(e){}
    startTimer();
  });
  el("pauseTimerBtn").addEventListener("click", ()=>{
    if(!timerRunning) return;
    stopTimer();
    el("timerState").textContent = "In pausa.";
  });
  el("resetTimerBtn").addEventListener("click", ()=>{
    stopTimer();
    applyPreset();
  });

  // Export
  el("exportBtn").addEventListener("click", ()=>{
    const p = state.players[state.selected];
    const obj = buildPlayerExport(p);
    const safeName = (p.name || "giocatore").replace(/[^\w\-]+/g,"_");
    downloadJSON(obj, `virtus_${safeName}.json`);
  });

  el("copyJsonBtn").addEventListener("click", async ()=>{
    const p = state.players[state.selected];
    const obj = buildPlayerExport(p);
    const txt = JSON.stringify(obj);
    try{
      await navigator.clipboard.writeText(txt);
      alert("JSON copiato ‚úÖ (ora puoi incollarlo su WhatsApp o qui)");
    }catch(e){
      // fallback
      el("importArea").value = txt;
      alert("Non posso copiare automaticamente: ho messo il JSON nel box Importa. Tieni premuto e copia.");
    }
  });

  el("waSummaryBtn").addEventListener("click", ()=>{
    const p = state.players[state.selected];
    const st = calcStats(p);

    let msg = `üèÄ *Virtus Shot* - ${p.name}\n`;
    if(!st){
      msg += `Nessuna sessione salvata ancora.\n`;
    }else{
      msg += `Sessioni: ${p.sessions.length}\n`;
      msg += `Media totale: ${st.overallPct}%\n`;
      msg += `Miglior sessione: ${Math.round(st.best.pct)}% (${st.best.date})\n\n`;
      msg += `Medie per posizione:\n`;
      st.avgsPct.forEach(x=>{
        msg += `- ${x.label}: ${x.pct}%\n`;
      });
      msg += `\nüìé Per i dati completi: usa "Esporta JSON giocatore" e invia il file.`;
    }

    const url = "https://wa.me/?text=" + encodeURIComponent(msg);
    window.open(url, "_blank");
  });

  // Import: incolla -> prova auto
  el("importArea").addEventListener("paste", ()=>{
    setTimeout(()=>{ tryAutoImport(); }, 50);
  });

  el("importBtn").addEventListener("click", ()=>{
    tryAutoImport(true);
  });

  el("importFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const text = await file.text();
    el("importArea").value = text;
    tryAutoImport(true);
    el("importFile").value = "";
  });

  // Scroll top
  el("scrollTopBtn").addEventListener("click", ()=>{
    window.scrollTo({ top:0, behavior:"smooth" });
  });
}

function tryAutoImport(showAlerts=false){
  const raw = (el("importArea").value || "").trim();
  if(!raw){
    if(showAlerts) alert("Incolla prima il JSON oppure scegli un file.");
    return;
  }
  try{
    const obj = JSON.parse(raw);
    importPayload(obj);
    el("importArea").value = "";
    alert("Import riuscito ‚úÖ");
  }catch(err){
    if(showAlerts) alert("Import fallito: " + (err?.message || err));
  }
}

/* =========================
   MAIN RENDER
========================= */

function renderAll(){
  renderTabs();
  renderPlayerHeader();
  renderProfileInputs();
  renderDraft();
  renderSessions();
  renderChart();

  // timer display keep consistent
  if(!timerRunning){
    el("timerDisplay").textContent = formatMMSS(timerLeft);
  }
}

(function init(){
  // init timer preset to 45
  applyPreset();

  // ensure each player has its own draft date
  state.players.forEach(p=>{
    if(!p.draft) p.draft = defaultDraft();
    if(!p.draft.date) p.draft.date = todayISO();
  });
  saveState();

  hookEvents();
  renderAll();
})();
</script>

<!-- Optional: basic service worker register if you later add sw.js -->
<script>
  // Se in futuro aggiungi sw.js, puoi sbloccare questa parte.
  // if ("serviceWorker" in navigator) {
  //   navigator.serviceWorker.register("./sw.js").catch(()=>{});
  // }
</script>

</body>
</html>
